---
title: "NRRL2 CG Analysis"
output: pdf_document
---

This notebook contains all the code for the manuscript. Code was written in R 4.3.1-4.3.2

# Globals
First, load the necessary:
```{r}
# betareg 3.1-4
# cowplot 1.1.2
# deSolve 1.40
# dplyr 1.1.4
# FactoMineR 2.9
# forcats 1.0.0
# ggplot2 3.4.4
# ggpubr 0.6.0
# growthcurver 0.3.1
# growthrates 0.8.4
# lmtest 0.9-40
# patchwork 1.1.3
# purrr 1.0.2
# RColorBrewer 1.1-3
# readxl 1.4.3
# stringr 1.5.1
# tibble 3.2.1
# tidyr 1.3.0
# tidyverse 2.0.0
# vegan 2.6-4
# MASS 7.3-60
pacman::p_load(tidyverse, cowplot, vegan, FactoMineR, readxl, ggpubr, MASS, RColorBrewer,
               readxl, growthrates, growthcurver, patchwork, betareg, lmtest, lme4)
```
 
Define global:
```{r}
xTextSize<-14
```

Since I will need to add growth rate data, here is a function for adding labels:
```{r}
label96well<-function(mydata, mylabels){
  # This function will take a data file where a column named "sample" contains well IDs
  # and a set of labels corresponding to those wells
  # which must have columns Strain, Community, Rep, Pass, and Morph
  # and move those labels to the "mydata" object according to well ID
  
  # Add blank columns to mydata
  mydata <- mydata %>%
  add_column(Strain=NA, 
             Community=NA,
             Rep=NA,
             Pass=NA,
             Morph=NA)
  
  # Take well IDs
  well_list1<-unique(mylabels$Well)
  
  attach(mylabels)

  for (i in seq_along(well_list1)){
    idx<-which(mydata$sample==well_list1[i]) # Find indices corresponding to each well
    mydata$Strain[idx]<-Strain[i]
    mydata$Community[idx]<-Community[i]
    mydata$Rep[idx]<-Rep[i]
    mydata$Pass[idx]<-Pass[i]
    mydata$Morph[idx]<-Morph[i]
    }
  detach(mylabels) # We're done with this, let it go
  
  return(mydata)
}
```

# Community Evolution
Data and analyses for Figure 1. Read in multispecies community data from batch worm digests:
```{r}
NRRLMulti2<-read_excel("ExperimentalEvolutionPlateData.xlsx", sheet="MultispeciesTimeSeries")
names(NRRLMulti2)
```

Create stacked bar plots of relative abundance of the seven genera:
```{r}
# make stacked bar plots
NRRLMulti2$Total<-rowSums(NRRLMulti2[,5:11])
fAA<-NRRLMulti2$AA/NRRLMulti2$Total 
fMO<-NRRLMulti2$MO/NRRLMulti2$Total 
fRE<-NRRLMulti2$RE/NRRLMulti2$Total 
fBS<-NRRLMulti2$BS/NRRLMulti2$Total 
fOA<-NRRLMulti2$OA/NRRLMulti2$Total 
fCX<-NRRLMulti2$CX/NRRLMulti2$Total 
fSX<-NRRLMulti2$SX/NRRLMulti2$Total 

values<-c(fAA,fMO,fRE,fBS,fOA,fCX,fSX) 
mylen<-length(fAA)
bact<-c(rep("AA",mylen), rep("MO",mylen), rep("RE",mylen), rep("BS",mylen), rep("OA",mylen), rep("CX",mylen), rep("SX",mylen)) 
MultiF<-data.frame(Pass=NRRLMulti2$Pass, 
                   ID=NRRLMulti2$ID, 
                   Set=NRRLMulti2$Set, 
                   Rep=NRRLMulti2$Rep, 
                   bact, values)
MultiF<-as_tibble(MultiF)
#glimpse(MultiF)

# plot
pMultiF<-MultiF %>%
  filter(Pass=="1" | Pass=="5" | Pass=="10") %>% # we don't need to see ALL of these surely
  ggplot(aes(fill=bact, y=values, x=ID))+ 
  geom_bar(stat="identity") + 
  scale_fill_manual(values=c('red4', 'orangered', 'gold', 'yellowgreen', 'darkgreen', 'blue', 'purple')) + 
  theme(
    axis.text=element_text(size=xTextSize+2), 
    axis.title=element_text(size=xTextSize+2),
    axis.text.x=element_blank(),
    axis.ticks = element_blank(),
    legend.title=element_blank(),
    strip.text=element_text(size=xTextSize+4),
    plot.title=element_text(hjust=0.5, size=xTextSize+2, face="bold"), 
    legend.text=element_text(size=xTextSize),
    #legend.position = "none")  
    )+
  labs(y="Relative Abundance", x="", title="Worm+")+
  facet_wrap(~Pass)
#pMultiF
```

Read in the community composition data from the no-worm evolution experiment:
```{r}
MultiNoWorm<-read.table("NRRLNoWormMulti.txt", header=TRUE) 
names(MultiNoWorm)
MultiNoWorm<-as_tibble(MultiNoWorm)
MultiNoWorm$Set<-substr(MultiNoWorm$Rep,1,1)
MultiNoWorm$ID<-MultiNoWorm$Rep
MultiNoWorm$Rep<-as.numeric(substr(MultiNoWorm$ID,2,2))
MultiNoWorm<-MultiNoWorm %>% relocate(ID, Set)
#glimpse(MultiNoWorm)
```
make stacked bar plots of relative abundance:
```{r}
# make the stacked barplots
fNAA<-MultiNoWorm$AA/MultiNoWorm$Total 
fNMO<-MultiNoWorm$MO/MultiNoWorm$Total 
fNRE<-MultiNoWorm$RE/MultiNoWorm$Total 
fNBS<-MultiNoWorm$BS/MultiNoWorm$Total 
fNOA<-MultiNoWorm$OA/MultiNoWorm$Total 
fNCX<-MultiNoWorm$CX/MultiNoWorm$Total 
fNSX<-MultiNoWorm$SX/MultiNoWorm$Total 

values<-c(fNAA, fNMO, fNRE, fNBS, fNOA, fNCX, fNSX)
mylen2<- length(fNAA)
bact<-c(rep("AA",mylen2), rep("MO",mylen2), rep("RE",mylen2), rep("BS",mylen2), rep("OA",mylen2), rep("CX",mylen2), rep("SX",mylen2))  
MultiF_NoWorm<-data.frame(Pass=MultiNoWorm$Pass, 
                   ID=MultiNoWorm$ID, 
                   Set=MultiNoWorm$Set, 
                   Rep=MultiNoWorm$Rep, 
                   bact, values)
MultiF_NoWorm<-as_tibble(MultiF_NoWorm)
#glimpse(MultiF_NoWorm)
```

and plot:
```{r}
# plot out no-worm communities barplots
pMultiF_NW<-MultiF_NoWorm %>%
  filter(Pass=="1" | Pass=="5" | Pass=="10") %>% # we don't need to see ALL of these surely
  ggplot(aes(fill=bact, y=values, x=ID))+ 
  geom_bar(stat="identity") + 
  scale_fill_manual(values=c('red4', 'orangered', 'gold', 'yellowgreen', 'darkgreen', 'blue', 'purple')) + 
  theme(
    axis.text=element_text(size=xTextSize+2), 
    axis.title=element_text(size=xTextSize+2),
    axis.text.x=element_blank(),
    axis.ticks = element_blank(),
    strip.text=element_text(size=xTextSize+4),
    #legend.title=element_blank(),
    plot.title=element_text(hjust=0.5, size=xTextSize+2, face="bold"), 
    #legend.text=element_text(size=xTextSize)
    legend.position = "none"
    )  +
  labs(y="Relative Abundance", x="", title="Worm-")+
  facet_wrap(~Pass)
pMultiF_NW
```

Ordinate both data sets together. First merge the data sets:
```{r}
# label the data sets
NRRLMulti2$Worms<-"Worm+"
MultiNoWorm$Worms<-"Worm-"

# log-transform the count data
MultiLog<-decostand(NRRLMulti2[,5:11], method="log") 
MultiNWLog<-decostand(MultiNoWorm[,5:11], method="log") 

# merge and standardize
MultiLogMerge<-rbind(MultiLog, MultiNWLog) # combine
MultiLogMergeStand<-decostand(MultiLogMerge, method="standardize")
MultiLogMergeStand$Pass<-c(NRRLMulti2$Pass, MultiNoWorm$Pass)
MultiLogMergeStand$Worms<-c(NRRLMulti2$Worms, MultiNoWorm$Worms)

# sanity check structure
#str(MultiLogMergeStand)
#View(MultiLogMergeStand)
```

Then the ordination:
```{r}
# joint PCA
pcaMNW_Merge<-PCA(MultiLogMergeStand, quali.sup=c(8,9)) 

pcaMNW_Merge$eig
#dim1: 48.87%; dim2=21.42% 

pcaMNW_Merge.top2<-data.frame(PC1=pcaMNW_Merge$ind$coord[,1],
                        PC2=pcaMNW_Merge$ind$coord[,2],
                        Pass=as.factor(MultiLogMergeStand$Pass),
                        Worms=as.factor(MultiLogMergeStand$Worms))


# Plot out the first two PCs
pPCAMNW_Merge<-pcaMNW_Merge.top2 %>%
  ggplot(aes(x=PC1,y=PC2,color=Pass)) +
  geom_point(size=2) +
  #theme_classic() +
  scale_color_viridis_d()+
  theme(axis.text=element_text(size=xTextSize+2), 
        axis.title=element_text(size=xTextSize+2),
        legend.text=element_text(size=xTextSize+2),
        strip.text=element_text(size=xTextSize+4),
        #plot.title=element_text(hjust=0.5, size=myTextSize+2),
        legend.title = element_text(size=xTextSize+2)) + 
  labs(y="PC2 (21.4%)", x="PC1 (48.9%)")+
  facet_wrap(~Worms)
pPCAMNW_Merge
```

merge some plots:
```{r}
pMultiPlotsTop_Merge_BC<-plot_grid(pMultiF_NW, pMultiF,
                          rel_widths=c(1, 1.2), labels=c("B", "C"))
pMultiPlotsTop_Merge<-plot_grid(pPCAMNW_Merge, pMultiPlotsTop_Merge_BC,
                                ncol=1, rel_heights=c(0.9,1), labels=c("A", ""))
pMultiPlotsTop_Merge
```

Multispecies worm digests: When did alt morphs appear in these data?
```{r}
pVariantEmergenceGrid<-NRRLMulti2 %>%
  rename("Chryseobacterium" = "varCX",
         "Microbacterium"="varMO") %>%
  pivot_longer(cols=Chryseobacterium:Microbacterium, names_to="Variant", values_to="Presence") %>%
  ggplot(aes(x=factor(Pass), y=ID, fill=Presence))+
  geom_tile(color="white", lwd=0.5)+
  scale_fill_gradient(low = "white", high = "red") +
  theme(legend.position = "none",
        axis.text.y=element_text(size=xTextSize-5), 
        axis.text.x=element_text(size=xTextSize), 
        axis.title=element_text(size=xTextSize),
        plot.title=element_text(hjust=0.5, size=xTextSize) 
  )+
  labs(y="Community", x="Pass", title="Emergence of Morphological Variants")+
  facet_wrap(~Variant, ncol=1)+
  theme(strip.text=element_text(size=xTextSize, face="italic"))
pVariantEmergenceGrid
```

Let's heatmap the variant emergence instead. Note that values of -1 indicate cases where variants were not counted but were observed on plates (passes 6-7) and/or retrieved from glycerol stocks (8+).
```{r}
NRRLMulti2_Variants<-read_excel("122121EvolutionNRRL2.xlsx", sheet="MultispeciesVariants")
pVariantEmergenceHeat<-NRRLMulti2_Variants %>%
  ggplot(aes(x=factor(Pass), y=ID, fill=fAlt))+
  geom_tile(lwd=0.5)+
  #scale_fill_viridis_c() +
  scale_fill_gradient2(low="blue", mid="grey99", high="red3")+
  #scale_fill_gradient2(low="blue", mid="ivory1", high="red3")+
  theme_classic()+
  theme(axis.text.y=element_text(size=xTextSize-5), 
        axis.text.x=element_text(size=xTextSize), 
        axis.title=element_text(size=xTextSize),
        plot.title=element_text(hjust=0.5, size=xTextSize),
        legend.text = element_text(size=xTextSize),
        legend.title = element_text(size=xTextSize),
        #panel.background = element_rect(fill = 'grey80', color = 'grey80')
        panel.background = element_rect(fill = 'black', color = 'black')
  )+
  labs(y="Community", x="Pass", title="Emergence of Morphological Variants", fill="fAlt")+
  facet_wrap(~Species, ncol=3)+
  theme(strip.text=element_text(size=xTextSize))
  #theme(strip.text=element_text(size=myTextSize, face="italic"))
pVariantEmergenceHeat
```

Any cases where we see both MO and CG alternate morphs in the same community?
```{r}
glimpse(NRRLMulti2)
NRRLMulti2<-NRRLMulti2 %>%
  mutate(varTotal = varMO + varCX) # sum of Boolean (were there MO variants) (were there Chryseobacterium variants)
  
max(NRRLMulti2$varTotal) #nope - at most one kind of variant per community*replicate
```


Plot Fig 1 with the joint ordination
```{r}
plot_grid(pMultiPlotsTop_Merge, pVariantEmergenceHeat, ncol=1, rel_heights = c(2,1), labels=c("", "D"))
#ggsave("pFig1_Multispecies_AllPassSummary_Merge_Heat_ivory1_grey80.png", width=10, height=12, units="in", dpi=400)
#ggsave("pFig1_Multispecies_AllPassSummary_Merge_Heat_grey99_blackfill.tiff", width=240, height=275, units="mm")
ggsave("pFig1_Multispecies_AllPassSummary_Merge_Heat_grey99_blackfill.eps", width=240, height=275, units="mm")
# 2/3 page width is 114 mm - supplied at 2X size
```

## Variant Emergence vs. Diversity (SI Figure)
Variants emerges around passage 6. Does this correspond with any features on the community level? let's generate diversity estimates and plot:

```{r}
H<-NRRLMulti2 %>%
  dplyr::select(AA:SX) %>%
  diversity()
NRRLMulti2$H<-H
#glimpse(NRRLMulti2)

D_inv<-NRRLMulti2 %>%
  dplyr::select(AA:SX) %>%
  diversity(index="invsimpson")
NRRLMulti2$D_inv<-D_inv
#glimpse(NRRLMulti2)

S<-NRRLMulti2 %>%
  dplyr::select(AA:SX) %>%
  specnumber()
NRRLMulti2$S<-S
#glimpse(NRRLMulti2)

# Plot all communities*replicates, just CX variants
pVariantEmergenceRichness_CX<-NRRLMulti2 %>%
  ggplot(aes(x=factor(Pass), y=S, color=factor(varCX)))+
  geom_jitter(width=0.15)+
  theme_classic()+
#  scale_fill_gradient(low = "white", high = "red") +
  theme(legend.position = "none",
        axis.text.y=element_text(size=xTextSize), 
        axis.text.x=element_text(size=xTextSize), 
        axis.title=element_text(size=xTextSize),
        plot.title=element_text(hjust=0.5, size=xTextSize) 
  )+
  labs(y="Richness", x="Pass", title="Emergence of Morphological Variants: \nChryseobacterium")+
  #facet_wrap(~Variant, ncol=1)+
  theme(strip.text=element_text(size=xTextSize, face="italic"))
#pVariantEmergenceRichness_CX
```
Filter down to CG only:
```{r}
# Filter down to CG only
pVariantEmergenceRichness_CG<-NRRLMulti2 %>%
  filter(Set=="A" | Set=="B" | Set=="E" | Set=="F"| 
           Set=="I" | Set=="J") %>%
  ggplot(aes(x=factor(Pass), y=S, color=factor(varCX)))+
  geom_jitter(width=0.15)+
  theme_classic()+
  #  scale_fill_gradient(low = "white", high = "red") +
  theme(legend.position = "none",
        axis.text.y=element_text(size=xTextSize), 
        axis.text.x=element_text(size=xTextSize), 
        axis.title=element_text(size=xTextSize),
        plot.title=element_text(hjust=0.5, size=xTextSize) 
  )+
  labs(y="Richness", x="Pass", title="Emergence of Morphological Variants: \nC. gleum")+
  #facet_wrap(~Variant, ncol=1)+
  theme(strip.text=element_text(size=xTextSize, face="italic"))
#pVariantEmergenceRichness_CG
```



Filter down to CG or MO only only and plot:
```{r}
# Filter down to CG only and plot Shannon
pVariantEmergenceH_CG<-NRRLMulti2 %>%
  filter(Set=="A" | Set=="B" | Set=="E" | Set=="F"| 
           Set=="I" | Set=="J") %>%
  ggplot(aes(x=factor(Pass), y=H, color=factor(varCX)))+
  geom_jitter(width=0.15)+
  theme_classic()+
  #  scale_fill_gradient(low = "white", high = "red") +
  theme(legend.position = "none",
        axis.text.y=element_text(size=xTextSize), 
        axis.text.x=element_text(size=xTextSize), 
        axis.title=element_text(size=xTextSize),
        plot.title=element_text(hjust=0.5, size=xTextSize) 
  )+
  labs(y="Shannon H'", x="Pass", title="C. gleum")+
  #facet_wrap(~Variant, ncol=1)+
  theme(strip.text=element_text(size=xTextSize, face="italic"))
#pVariantEmergenceH_CG

# Filter down to CG only and plot Simpson
pVariantEmergenceIS_CG<-NRRLMulti2 %>%
  filter(Set=="A" | Set=="B" | Set=="E" | Set=="F"| 
           Set=="I" | Set=="J") %>%
  ggplot(aes(x=factor(Pass), y=D_inv, color=factor(varCX)))+
  geom_jitter(width=0.15)+
  theme_classic()+
  #  scale_fill_gradient(low = "white", high = "red") +
  theme(legend.position = "none",
        axis.text.y=element_text(size=xTextSize), 
        axis.text.x=element_text(size=xTextSize), 
        axis.title=element_text(size=xTextSize),
        plot.title=element_text(hjust=0.5, size=xTextSize) 
  )+
  labs(y="Inverse Simpson", x="Pass", title="C. gleum")+
  #facet_wrap(~Variant, ncol=1)+
  theme(strip.text=element_text(size=xTextSize, face="italic"))
#pVariantEmergenceIS_CG

# how about MO?
pVariantEmergenceRichness_MO<-NRRLMulti2 %>%
  ggplot(aes(x=factor(Pass), y=S, color=factor(varMO)))+
  geom_jitter(width=0.15)+
  theme_classic()+
  #  scale_fill_gradient(low = "white", high = "red") +
  theme(legend.position = "none",
        axis.text.y=element_text(size=xTextSize), 
        axis.text.x=element_text(size=xTextSize), 
        axis.title=element_text(size=xTextSize),
        plot.title=element_text(hjust=0.5, size=xTextSize) 
  )+
  labs(y="Richness", x="Pass", title="Emergence of Morphological Variants: \nM. oxydans")+
  #facet_wrap(~Variant, ncol=1)+
  theme(strip.text=element_text(size=xTextSize, face="italic"))
pVariantEmergenceRichness_MO

pVariantEmergenceH_MO<-NRRLMulti2 %>%
  ggplot(aes(x=factor(Pass), y=H, color=factor(varMO)))+
  geom_jitter(width=0.15)+
  theme_classic()+
  #  scale_fill_gradient(low = "white", high = "red") +
  theme(legend.position = "none",
        axis.text.y=element_text(size=xTextSize), 
        axis.text.x=element_text(size=xTextSize), 
        axis.title=element_text(size=xTextSize),
        plot.title=element_text(hjust=0.5, size=xTextSize) 
  )+
  labs(y="Shannon H'", x="Pass", title="M. oxydans")+
  #facet_wrap(~Variant, ncol=1)+
  theme(strip.text=element_text(size=xTextSize, face="italic"))
#pVariantEmergenceH_MO

pVariantEmergenceIS_MO<-NRRLMulti2 %>%
  ggplot(aes(x=factor(Pass), y=D_inv, color=factor(varMO)))+
  geom_jitter(width=0.15)+
  theme_classic()+
  #  scale_fill_gradient(low = "white", high = "red") +
  theme(legend.position = "none",
        axis.text.y=element_text(size=xTextSize), 
        axis.text.x=element_text(size=xTextSize), 
        axis.title=element_text(size=xTextSize),
        plot.title=element_text(hjust=0.5, size=xTextSize) 
  )+
  labs(y="Inverse Simpson", x="Pass", title="M. oxydans")+
  #facet_wrap(~Variant, ncol=1)+
  theme(strip.text=element_text(size=xTextSize, face="italic"))
#pVariantEmergenceIS_MO

plot_grid(pVariantEmergenceRichness_CG, pVariantEmergenceRichness_MO,
          pVariantEmergenceH_CG, pVariantEmergenceH_MO, 
          pVariantEmergenceIS_CG, pVariantEmergenceIS_MO,
          ncol=2, align="h")
ggsave("FigS3_EmergenceMorphVariants.png", height=6, width=8, units="in", dpi=300)
```

Calculate median diversity across samples at each passage:
```{r}
# calculations - median diversity
summarizeVariantEmergenceD<-NRRLMulti2 %>%
  group_by(Pass) %>%
  summarize(median_H=median(H),
            median_D=median(D_inv),
            median_S=median(S))
summarizeVariantEmergenceD
```

And plot:
```{r}
# plot out
summarizeVariantEmergenceD %>%
  pivot_longer(!Pass, names_to="Measure", values_to="median_diversity") %>%
  ggplot(aes(x=factor(Pass), y=median_diversity, color=Measure)) +
  geom_point()+
  theme(legend.position = "none",
        axis.text.y=element_text(size=xTextSize+2), 
        axis.text.x=element_text(size=xTextSize+2), 
        axis.title=element_text(size=xTextSize+2),
        #plot.title=element_text(hjust=0.5, size=myTextSize)
        )+
  labs(y="Median Diversity", x="Pass", title="")
```


# Growth Curves
## Growth in 1X NGM
Load in the OD600 data from the Excel files:
```{r}
plate1 <- read_excel("20230217-MD-NGM-p6-p10.xlsx", sheet = "raw")
plate2 <- read_excel("20230218-MD-NGM-p6-p10.xlsx", sheet = "raw")
plate3 <- read_excel("20230219-MD-NGM-p6-p10.xlsx", sheet = "raw")
```

Check the contents briefly:
```{r}
head(plate3)
```

First, let's get rid of any sample-containing wells where there was no growth. Start by getting OD600 range by well:
```{r}
plate1_range<-sapply(plate1, function(plate1) range(plate1))
plate1_range
```

Note that blanks in this plate and plate 3 are [E2, F2, G2, H2] and negative controls [E3, F3, G3, H3]; plate 2 only has the blank wells. 
Do the same for each of the other plates:
```{r}
plate2_range<-sapply(plate2, function(plate2) range(plate2))
plate2_range
```

```{r}
plate3_range<-sapply(plate3, function(plate3) range(plate3))
plate3_range
```

Since the blanks are changing a bit over time, we might want to use the "blank" method for correction. Here, growthcurver will take the ODs from a single column named "blank" and use that to correct the rest of the plate. In each plate, we will therefore name one "blank column (created as the average of the actual blanks):
```{r}
plate1_mod <- mutate(plate1, blank=rowMeans(dplyr::select(plate1, c(E2, F2, G2, H2))))
#View(plate1_mod)
plate1_mod$blank
```
Same for other plates:
```{r}
plate2_mod <- mutate(plate2, blank=rowMeans(dplyr::select(plate2, c(E2, F2, G2, H2))))
plate3_mod <- mutate(plate3, blank=rowMeans(dplyr::select(plate3, c(E2, F2, G2, H2))))
```

Let's see what the blanks look like:
```{r}
par(mfrow=c(1,3))
p1_blank<-plot(plate1_mod$time, plate1_mod$blank)
p2_blank<-plot(plate2_mod$time, plate2_mod$blank)
p3_blank<-plot(plate3_mod$time, plate3_mod$blank)
```

Now we can remove the individual columns with no growth:
```{r}
# Find the names of columns where growth is measurable; append "blank" column name
keepNames1<-c(names(which((plate1_range[1,]*2) < plate1_range[2,])), "blank")
keepNames2<-c(names(which((plate2_range[1,]*2) < plate2_range[2,])), "blank")
keepNames3<-c(names(which((plate3_range[1,]*2) < plate3_range[2,])), "blank")

# Select these columns and the blank from the new tibbles
plate1_mod<-dplyr::select(plate1_mod, all_of(keepNames1))
plate2_mod<-dplyr::select(plate2_mod, all_of(keepNames2))
plate3_mod<-dplyr::select(plate3_mod, all_of(keepNames3))

# confirm
#names(plate1_mod)
#names(plate2_mod)
#names(plate3_mod)
```

## Growthcurver

Using growthcurver to get parameter estimates for all of the remaining sample wells with and without the blank-well correction. First, with the default ("min") correction:
```{r}
plate1_out_min<-SummarizeGrowthByPlate(plate1_mod, plot_fit=TRUE, plot_file = "plate1_min.pdf")
plate2_out_min<-SummarizeGrowthByPlate(plate2_mod, plot_fit=TRUE, plot_file = "plate2_min.pdf")
plate3_out_min<-SummarizeGrowthByPlate(plate3_mod, plot_fit=TRUE, plot_file = "plate3_min.pdf")
```

So far so good. What if we use the "blank" correction?
```{r}
plate1_out_blank<-SummarizeGrowthByPlate(plate1_mod, bg_correct = "blank", plot_fit=TRUE, plot_file = "plate1_blank.pdf")
plate2_out_blank<-SummarizeGrowthByPlate(plate2_mod, bg_correct = "blank", plot_fit=TRUE, plot_file = "plate2_blank.pdf")
plate3_out_blank<-SummarizeGrowthByPlate(plate3_mod, bg_correct = "blank", plot_fit=TRUE, plot_file = "plate3_blank.pdf")
```

The fits are very similar, so let's work with the default. 

Label these estimates using the well info from each file. For plate 1:
```{r}
my_labels1<-read_excel("20230217-MD-NGM-p6-p10.xlsx", sheet="Labels", col_names=TRUE)
#knitr::kable(my_labels1)
```

And plates 2-3:
```{r}
my_labels2<-read_excel("20230218-MD-NGM-p6-p10.xlsx", sheet="Labels", col_names=TRUE)
my_labels3<-read_excel("20230219-MD-NGM-p6-p10.xlsx", sheet="Labels", col_names=TRUE)
```


And add labels to each set of parameter estimates. First to plate 1:
```{r}
plate1_out_min<- label96well(plate1_out_min, my_labels1)
#View(plate1_out_min)
```

and to the other two plates:
```{r}
plate2_out_min<- label96well(plate2_out_min, my_labels2)
plate3_out_min<- label96well(plate3_out_min, my_labels3)
```

Now we can add a column indicating plate ID to these parameter estimates (new first column):
```{r}
plate1_out_min<-add_column(plate1_out_min, Plate=1, .before="sample")
plate2_out_min<-add_column(plate2_out_min, Plate=2, .before="sample")
plate3_out_min<-add_column(plate3_out_min, Plate=3, .before="sample")
```

And combine the parameter estimates into a single object:
```{r}
allplates_LVparams_min<-rbind(plate1_out_min, plate2_out_min, plate3_out_min)
```

Clean up
```{r}
allplates_LVparams_min<-allplates_LVparams_min[complete.cases(allplates_LVparams_min),]
```

Let's prune out the most egregious weird wells, where the fit failed
```{r}
# the "weird wells"
#View(allplates_LVparams_min[which(allplates_LVparams_min$t_mid>16),])
#View(allplates_LVparams_min[which(allplates_LVparams_min$t_mid<10.2),])
```

```{r}
# take out the weird wells
allplates_LVparams_min<-allplates_LVparams_min[which(allplates_LVparams_min$t_mid<=16),]
allplates_LVparams_min<-allplates_LVparams_min[which(allplates_LVparams_min$t_mid>=10.2),]
```

Carrying capacity doesn't seem to have changed much, and the estimates of growth rate from growthcurver tend to be unstable - we'll estimate those from spline fits farther down. Let's plot K here:
```{r}
WTmedian_k<-median(allplates_LVparams_min$k[allplates_LVparams_min$Strain=="WT"])

# reorder
allplates_LVparams_min$Strain<-factor(allplates_LVparams_min$Strain, 
                                      levels=c("WT", "A1o6", "A1o10", "A2o6", "A2o10",
                                               "F1o6", "F1o10", "F2o6", "F2o10",
                                               "A2a6", "A2a10", "F2a6", "F2a10"))

pLVparams_min_k_box<-allplates_LVparams_min %>%
  ggplot(aes(x=Strain, y=k, color=Strain))+
  theme_classic()+
  geom_boxplot()+
  geom_jitter(width=0.1)+
  geom_hline(yintercept = WTmedian_k, color="black")+
  theme(legend.position = "none",
        text=element_text(size=xTextSize)) +
  labs(x="", y="Saturation OD600 (K)")
pLVparams_min_k_box + 
            scale_color_manual(values=c("black", "red", "red2", "red3", "red4",
                                        "dodgerblue", "dodgerblue2", "dodgerblue3", "dodgerblue4",
                                        "magenta", "magenta3", "purple", "purple3"))
```

We can also add hypothesis tests to the plots (here, each vs. ancestor):
```{r}
pLVparams_min_k_box + 
            scale_color_manual(values=c("black", "red", "red2", "red3", "red4",
                                        "dodgerblue", "dodgerblue2", "dodgerblue3", "dodgerblue4",
                                        "magenta", "magenta3", "purple", "purple3"))+
      stat_compare_means(label.x = 2, label.y=0.14) +
  stat_compare_means(aes(label = after_stat(p.signif)),method="wilcox.test",                     
                     ref.group="WT", label.y=0.28)
```


## Growthrates
The spline fits here will give better estimates of growth rate r.
Growthrates requires the data to be in a different format. Let's pivot the data out. Recall that the "plate[X]_mod" objects contain the original-layout OD600 data with no-growth wells removed.
```{r}
plate1_mod_long<-plate1_mod %>%
  dplyr::select(!blank) %>% # don't need blank well here
  pivot_longer(cols = A1:H1,
               names_to = "sample",
               values_to = "OD600")
plate2_mod_long<-plate2_mod %>%
  dplyr::select(!blank) %>% # don't need blank well here
  pivot_longer(cols = A1:H1,
               names_to = "sample",
               values_to = "OD600")
plate3_mod_long<-plate3_mod %>%
  dplyr::select(!blank) %>% # don't need blank well here
  pivot_longer(cols = A1:H1,
               names_to = "sample",
               values_to = "OD600")
```

Now we can add labels to these objects directly (since growthrates will let us make use of these labels if we want to)
```{r}
plate1_mod_long<-label96well(plate1_mod_long, my_labels1)
plate2_mod_long<-label96well(plate2_mod_long, my_labels2)
plate3_mod_long<-label96well(plate3_mod_long, my_labels3)

# Confirm
str(plate1_mod_long)
str(plate2_mod_long)
str(plate3_mod_long)
```

We can plot out with ggplot to check the data:
```{r}
plate1_mod_long %>%
  mutate(Pass=factor(Pass)) %>%
  ggplot(aes(time, OD600)) + 
  geom_point(aes(color=Pass)) + 
  facet_grid(Community ~ Morph)
```

Plate 2:
```{r}
plate2_mod_long %>%
  mutate(Pass=factor(Pass)) %>%
  ggplot(aes(time, OD600)) + 
  geom_point(aes(color=Pass)) + 
  facet_grid(Community ~ Morph)
```

Plate 3:
```{r}
plate3_mod_long %>%
  mutate(Pass=factor(Pass)) %>%
  ggplot(aes(time, OD600)) + 
  geom_point(aes(color=Pass)) + 
  facet_grid(Community ~ Morph)
```

Now we can fit splines. I want estimates for each well, so we'll tell growthrates to separate by well:
```{r}
# Single-well fit for illustration, as in the vignette
splitted.data.plate1<-multisplit(plate1_mod_long, "sample")
dat<-splitted.data.plate1[[1]] # should be the first data set (well A1)
dat
```

```{r}
unique(dat$sample)
```
Starting with plate 1, fit splines:
```{r}
plate1_manyspline<-all_splines(OD600~time | sample, data=plate1_mod_long, spar=0.9)
par(mfrow=c(7,8))
par(mar = c(2.5, 4, 2, 1))
#plot(plate1_manyspline)
```
Plots look good; smoothing is working well. Let's do the same for each of the other plates. Plate 2:
```{r}
plate2_manyspline<-all_splines(OD600~time | sample, data=plate2_mod_long, spar=0.9)
par(mfrow=c(7,8))
par(mar = c(2.5, 4, 2, 1))
#plot(plate2_manyspline)
```

Plate 3:
```{r}
plate3_manyspline<-all_splines(OD600~time | sample, data=plate3_mod_long, spar=0.9)
par(mfrow=c(7,8))
par(mar = c(2.5, 4, 2, 1))
#plot(plate3_manyspline)
```

Now that we have these fits, let's extract the parameters. 
```{r}
# This gives us a list by well. For splines, we only need to keep max growth rate (mumax) estimates
#coef(plate1_manyspline)
```

The coef() function returns a matrix, which is not what we want. Let's turn this into a data frame:
```{r}
plate1_manyspline_coef<-as_tibble(coef(plate1_manyspline), rownames=NA)
#str(plate1_manyspline_coef)
```
Note that it did not bring well labels along for some reason (I think rownames=NA is supposed to retain these, not sure what's wrong); we'll have to retrieve those.
```{r}
# We can get the names from the coef() object
temp<-dimnames(coef(plate1_manyspline))
temp
temp[[1]]
```
Attach these well IDs to the coefficients:
```{r}
plate1_manyspline_coef$sample<-temp[[1]]
plate1_manyspline_coef
```

Let's do the same for plates 2 and 3:
```{r}
plate2_manyspline_coef<-as_tibble(coef(plate2_manyspline), rownames=NA)
temp<-dimnames(coef(plate2_manyspline))
plate2_manyspline_coef$sample<-temp[[1]]

plate3_manyspline_coef<-as_tibble(coef(plate3_manyspline), rownames=NA)
temp<-dimnames(coef(plate3_manyspline))
plate3_manyspline_coef$sample<-temp[[1]]

str(plate2_manyspline_coef)
str(plate3_manyspline_coef)
```

Now we have all our coefficients and their well labels. Pass these objects back through the labeler to get the meta-data associated with each well. Plate 1 first, to illustrate:
```{r}
plate1_manyspline_coef<-label96well(plate1_manyspline_coef, my_labels1)
str(plate1_manyspline_coef)
```
Once plates 2 and 3 are labeled, we can add the plate ID, then combine into a single data frame.
```{r}
# Finish labels
plate2_manyspline_coef<-label96well(plate2_manyspline_coef, my_labels2)
plate3_manyspline_coef<-label96well(plate3_manyspline_coef, my_labels3)

# Add plate IDs
plate1_manyspline_coef<-add_column(plate1_manyspline_coef, Plate=1, .before="y0")
plate2_manyspline_coef<-add_column(plate2_manyspline_coef, Plate=2, .before="y0")
plate3_manyspline_coef<-add_column(plate3_manyspline_coef, Plate=3, .before="y0")

# Merge
allplates_manyspline_coef<-rbind(plate1_manyspline_coef,
                                 plate2_manyspline_coef,
                                 plate3_manyspline_coef)
str(allplates_manyspline_coef)
```

These values are much more reasonable than the ones obtained from growthcurver. Plot:
```{r}
# reorder
allplates_manyspline_coef$Strain<-factor(allplates_manyspline_coef$Strain, 
                                      levels=c("WT", "A1o6", "A1o10", "A2o6", "A2o10",
                                               "F1o6", "F1o10", "F2o6", "F2o10",
                                               "A2a6", "A2a10", "F2a6", "F2a10"))

pLVparams_spline_r_box<-allplates_manyspline_coef %>%
  ggplot(aes(x=Strain, y=mumax, color=Strain))+
  theme_classic()+
  geom_boxplot()+
  geom_jitter(width=0.1)+
  geom_hline(yintercept = WTmedian_r_spline, color="black")+
  theme(legend.position = "none",
        text=element_text(size=xTextSize)) +
  labs(x="", y="Growth Rate (r)")
pLVparams_spline_r_box
```

Combine plots for K and r:
```{r}
plot_grid(
  pLVparams_spline_r_box + 
            scale_color_manual(values=c("black", "red", "red2", "red3", "red4",
                                        "dodgerblue", "dodgerblue2", "dodgerblue3", "dodgerblue4",
                                        "magenta", "magenta3", "purple", "purple3"))+ 
  stat_compare_means(label.x=2, label.y=0.04) +
  stat_compare_means(aes(label = after_stat(p.signif)),method="wilcox.test", 
                     ref.group="WT", label.y=0.14),
  pLVparams_min_k_box + 
            scale_color_manual(values=c("black", "red", "red2", "red3", "red4",
                                        "dodgerblue", "dodgerblue2", "dodgerblue3", "dodgerblue4",
                                        "magenta", "magenta3", "purple", "purple3"))+
      stat_compare_means(label.x = 2, label.y=0.14) +
  stat_compare_means(aes(label = after_stat(p.signif)),method="wilcox.test",
                     ref.group="WT", label.y=0.28),
  ncol=1, align="v")
#ggsave("pLVGrowthParamsCG_merge_wilcox.png", height=7, width=10, units="in", dpi=300)
```


##CFU data
Adding in the CFU/mL data from 24 hour cultures. Read in NGM medium only data from file:
```{r}
CG_CFU <- read_excel("CG_CFU_per_mL.xlsx", sheet = "plate read cfu")
str(CG_CFU)
```
Let's add a logCFU column to make plotting a little easier. 
```{r}
CG_CFU <- CG_CFU %>%
  mutate(logCFU=log10(CFU))
str(CG_CFU)
```
This also introduces Infs, which we can use to take out any missing data:
```{r}
CG_CFU<-CG_CFU[!is.infinite(CG_CFU$logCFU),]
```

Let's get the WT median:
```{r}
WTmedian_CFU<-median(CG_CFU$logCFU[CG_CFU$Community=="WT"])
```

Now we can plot (same basic code as for growth curve parameters):
```{r}
# reorder
CG_CFU$ID<-factor(CG_CFU$ID, levels=c("WT", "A1o6", "A1o10", "A2o6", "A2o10",
                                               "F1o6", "F1o10", "F2o6", "F2o10",
                                               "A2a6", "A2a10", "F2a6", "F2a10"))

pCG_CFU<-CG_CFU %>%
  ggplot(aes(x=ID, y=logCFU, color=ID))+
  theme_classic()+
  geom_boxplot()+
  geom_jitter(width=0.1)+
  geom_hline(yintercept = WTmedian_CFU, color="black")+
  theme(legend.position = "none",
        text=element_text(size=xTextSize)) +
  labs(x="", y=expression(log[10](CFU/mL)))
pCG_CFU
```
Add this plot to the grid with the logistic growth parameters:
```{r}
plot_grid(
  pLVparams_spline_r_box + 
            scale_color_manual(values=c("black", "red", "red2", "red3", "red4",
                                        "dodgerblue", "dodgerblue2", "dodgerblue3", "dodgerblue4",
                                        "magenta", "magenta3", "purple", "purple3"))+ 
  stat_compare_means(label.x=2, label.y=0.04) +
  stat_compare_means(aes(label = after_stat(p.signif)),method="wilcox.test", 
                     ref.group="WT", label.y=0.14),
  
  pLVparams_min_k_box + 
            scale_color_manual(values=c("black", "red", "red2", "red3", "red4",
                                        "dodgerblue", "dodgerblue2", "dodgerblue3", "dodgerblue4",
                                        "magenta", "magenta3", "purple", "purple3")) +
  stat_compare_means(label.x = 2, label.y=0.14) +
  stat_compare_means(aes(label = after_stat(p.signif)),method="wilcox.test",
                     ref.group="WT", label.y=0.28),
  
  pCG_CFU + 
            scale_color_manual(values=c("black", "red", "red2", "red3", "red4",
                                        "dodgerblue", "dodgerblue2", "dodgerblue3", "dodgerblue4",
                                        "magenta", "magenta3", "purple", "purple3")) +
  stat_compare_means(label.x = 2, label.y=8) +
  stat_compare_means(aes(label = after_stat(p.signif)),method="wilcox.test",
                     ref.group="WT", label.y=9.7),

  ncol=1, align="v", labels="AUTO")
ggsave("FigS5_CG_LVGrowthParams_CFU_merge_wilcox.png", 
       height=8.5, width=7, units="in", dpi=300)
```

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# Pairwise competitions (Figure 2)
## Pairwise competitions in vitro (no worms)
Read in the data:
```{r}
NRRL2_CG_Morph_Compete<-read_excel("NRRL2CXMorphologyCompetition.xlsx", sheet="summary")
names(NRRL2_CG_Morph_Compete)
NRRL2_CG_Morph_Compete<-as_tibble(NRRL2_CG_Morph_Compete, stringsAsFactors="TRUE")

#glimpse(NRRL2_CG_Morph_Compete)
#View(NRRL2_CG_Morph_Compete)

# max proportion alternate
# when total counts sufficient
max(NRRL2_CG_Morph_Compete$fAlt[NRRL2_CG_Morph_Compete$cAlt>5]) #99.45%

# rename ancestor
NRRL2_CG_Morph_Compete$strain2<-replace(NRRL2_CG_Morph_Compete$strain2,
                                        NRRL2_CG_Morph_Compete$strain2=="CG0",
                                        "WT") 
```

plot out raw proportion fAlt data
```{r}
# first reorder levels
unique(NRRL2_CG_Morph_Compete$strain1)
NRRL2_CG_Morph_Compete$strain1 <-factor(NRRL2_CG_Morph_Compete$strain1,
                                        levels=c("A2a6", "A2a10", "F2a6", "F2a10"))
unique(NRRL2_CG_Morph_Compete$strain2)
NRRL2_CG_Morph_Compete$strain2 <-factor(NRRL2_CG_Morph_Compete$strain2,
                                        levels=c("WT", "A1o6", "A1o10", "A2o6", "A2o10",
                                                 "F1o6", "F1o10", "F2o6", "F2o10"))

# Take out the day that appears in only one set
NRRL2_CG_Morph_Compete<-NRRL2_CG_Morph_Compete  %>%
  filter(day!=21)

pNRRL2_MorphCompeteInVitro_fAlt<-NRRL2_CG_Morph_Compete %>%
  ggplot(aes(x=day, y=fAlt, color=strain1)) +
  geom_line(aes(linetype=factor(rep)))+
  theme_bw()+
    scale_color_viridis_d(begin=0.2, end=0.8, option="inferno")+
  theme(
    axis.text=element_text(size=xTextSize), 
    axis.title=element_text(size=xTextSize+2),
    strip.text=element_text(size=xTextSize),
    plot.title=element_text(hjust=0.5, size=xTextSize+2, face="bold"), 
    legend.text=element_text(size=xTextSize),
    legend.title =element_text(size=xTextSize),
    plot.margin = margin(r=40)
    )  +
  labs(y="Fraction Alternate Morph", x="Day", title="In Vitro Competition",
       linetype="Isolate", color="Alt Morph")+
  facet_wrap(~strain2)
pNRRL2_MorphCompeteInVitro_fAlt
ggsave("Figure S6_InVitroTimeSeries.png", width=10, height=8, units="in", dpi=300)
```
While we're here, check the range of the data:
```{r}
min(NRRL2_CG_Morph_Compete$fAlt[NRRL2_CG_Morph_Compete$day==14])
max(NRRL2_CG_Morph_Compete$fAlt[NRRL2_CG_Morph_Compete$day==14])
```


Now we can take the various deltas. Let's start by holding the day 14 data from the pairwise comparisons. We'll add some columns to hold the deltas, then fill them using the strain1 and strain2 labels to find the right data in the other data frames.
```{r}
NRRL2_CG_Morph_Compete_14<-NRRL2_CG_Morph_Compete %>%
  filter(day==14) %>%
  add_column(delta_r=NA, delta_CFU=NA)
#glimpse(NRRL2_CG_Morph_Compete_14)
```

Now to grab the deltas. First check out the objects - CFU
```{r}
str(CG_CFU)
```

and growth rates
```{r}
str(allplates_manyspline_coef)
```

Make the deltas (we'll do Alt-Ori).
```{r}
my_dim<-dim(NRRL2_CG_Morph_Compete_14)
for (i in 1:my_dim[1]){
  strain_a<-as.character(NRRL2_CG_Morph_Compete_14$strain1[i])
  strain_o<-as.character(NRRL2_CG_Morph_Compete_14$strain2[i])
  NRRL2_CG_Morph_Compete_14$delta_r[i]<-median(allplates_manyspline_coef$mumax[allplates_manyspline_coef$Strain==strain_a &
                                                allplates_manyspline_coef$Rep==NRRL2_CG_Morph_Compete_14$rep[i]]) - 
                                           median(allplates_manyspline_coef$mumax[allplates_manyspline_coef$Strain==strain_o &
                                                                                 allplates_manyspline_coef$Rep==NRRL2_CG_Morph_Compete_14$rep[i]])
  NRRL2_CG_Morph_Compete_14$delta_CFU<-median(CG_CFU$logCFU[CG_CFU$ID==strain_a &
                                              CG_CFU$Replicate==NRRL2_CG_Morph_Compete_14$rep[i]]) - 
                                           median(CG_CFU$logCFU[CG_CFU$ID==strain_o &
                                                  CG_CFU$Replicate==NRRL2_CG_Morph_Compete_14$rep[i]])
}

glimpse(NRRL2_CG_Morph_Compete_14)
```

Linear fits. Growth rate is not significant
```{r}
lm_deltagrowth<-lm(delta_r~fAlt, data=NRRL2_CG_Morph_Compete_14)
summary(lm_deltagrowth)
```
Nor is delta log(CFU)
```{r}
lm_deltaCFU<-lm(delta_CFU~fAlt, data=NRRL2_CG_Morph_Compete_14)
summary(lm_deltaCFU)
```

Plot out:
```{r}
pCompeteDeltaGrowth_byORI<-NRRL2_CG_Morph_Compete_14 %>%
  ggplot(aes(x=fAlt, y=delta_r, color=strain2))+
  geom_jitter(width=0.1)+
  theme_light()+
   stat_smooth(method = "lm", 
              formula = y ~ x, 
              geom = "smooth",
              color="grey40") +
  #scale_color_viridis_d(begin=0.1, end=0.9)+
  scale_color_manual(values=c("black", "red", "red2", "red3", "red4",
                                        "dodgerblue", "dodgerblue2", "dodgerblue3", "dodgerblue4")) +
    theme(
    axis.text=element_text(size=xTextSize), 
    axis.title=element_text(size=xTextSize+2),
    #axis.text.x=element_blank(),
    legend.title=element_blank(),
    #legend.position = "none",
    plot.title=element_text(hjust=0.5, size=xTextSize+2, face="bold"), 
    legend.text=element_text(size=xTextSize))  +
  labs(y="Change in \nGrowth Rate", x="Fraction Alt Morph", title="")
#pCompeteDeltaGrowth_byORI
```
 Color by alt morph
```{r}
pCompeteDeltaGrowth_byALT<-NRRL2_CG_Morph_Compete_14 %>%
  ggplot(aes(x=fAlt, y=delta_r, color=strain1))+
  geom_jitter(width=0.1)+
  theme_light()+
   stat_smooth(method = "lm", 
              formula = y ~ x, 
              geom = "smooth",
              color="grey40") +
  scale_color_viridis_d(begin=0.2, end=0.8, option="inferno")+
    theme(
    axis.text=element_text(size=xTextSize), 
    axis.title=element_text(size=xTextSize+2),
    #axis.text.x=element_blank(),
    legend.title=element_blank(),
    #legend.position = "none",
    plot.title=element_text(hjust=0.5, size=xTextSize+2, face="bold"), 
    legend.text=element_text(size=xTextSize))  +
  labs(y="Change in \nGrowth Rate", x="Fraction Alt Morph", title="")
#pCompeteDeltaGrowth_byALT
```
 

And plot vs CFU?
```{r}
pCompeteDeltaCFU_byORI<-NRRL2_CG_Morph_Compete_14 %>%
  ggplot(aes(x=fAlt, y=delta_CFU, color=strain2))+
  geom_jitter(width=0.1)+
  theme_light()+
   stat_smooth(method = "lm", 
              formula = y ~ x, 
              geom = "smooth",
              color="grey40") +
  #scale_color_viridis_d(begin=0.1, end=0.9)+
  scale_color_manual(values=c("black", "red", "red2", "red3", "red4",
                                        "dodgerblue", "dodgerblue2", "dodgerblue3", "dodgerblue4")) +
    theme(
    axis.text=element_text(size=xTextSize), 
    axis.title=element_text(size=xTextSize+2),
    #axis.text.x=element_blank(),
    legend.title=element_blank(),
    #legend.position = "none",
    plot.title=element_text(hjust=0.5, size=xTextSize+2, face="bold"), 
    legend.text=element_text(size=xTextSize))  +
  labs(y="Change in \nlog(Max CFU)", x="Fraction Alt Morph", title="")
#pCompeteDeltaCFU_byORI
```
again, color by alt morph?
```{r}
pCompeteDeltaCFU_byALT<-NRRL2_CG_Morph_Compete_14 %>%
  ggplot(aes(x=fAlt, y=delta_CFU, color=strain1))+
  geom_jitter(width=0.1)+
  theme_light()+
  stat_smooth(method = "lm", 
              formula = y ~ x, 
              geom = "smooth",
              color="grey40") +
  scale_color_viridis_d(begin=0.2, end=0.8, option="inferno")+
    theme(
    axis.text=element_text(size=xTextSize), 
    axis.title=element_text(size=xTextSize+2),
    #axis.text.x=element_blank(),
    legend.title=element_blank(),
    #legend.position = "none",
    plot.title=element_text(hjust=0.5, size=xTextSize+2, face="bold"), 
    legend.text=element_text(size=xTextSize))  +
  labs(y="Change in \nlog(Max CFU)", x="Fraction Alt Morph", title="")
#pCompeteDeltaCFU_byALT
```
And together:
```{r}
#(pCompeteDeltaGrowth_byORI+pCompeteDeltaGrowth_byALT + patchwork::plot_layout(axis_titles = "collect"))/
#  (pCompeteDeltaCFU_byORI+pCompeteDeltaCFU_byALT + patchwork::plot_layout(axis_titles = "collect")) + 
  #patchwork::plot_layout(guides = 'collect', axis_titles = "collect") +
#   patchwork::plot_annotation(tag_levels = 'A') & 
#  #theme(legend.position = 'bottom',
#  #      legend.text=element_text(size=xTextSize-2)) &
#  xlim(0,1)

(pCompeteDeltaGrowth_byORI+pCompeteDeltaCFU_byORI) /
  (pCompeteDeltaGrowth_byALT+pCompeteDeltaCFU_byALT) +
  plot_layout(guides = 'collect') &
  xlim(0,1)

#plot_grid(pCompeteDeltaGrowth_byORI, pCompeteDeltaCFU_byORI,
#          pCompeteDeltaGrowth_byALT, pCompeteDeltaCFU_byALT,
#          ncol=2, labels="AUTO")

ggsave("Figure S7_CompeteDeltas.png", width=10, height=8, units="in", dpi=300)
```
Label by same vs different pairs:
```{r}
# Same vs different?
NRRL2_CG_Morph_Compete_d14<-NRRL2_CG_Morph_Compete_14 %>% # TRUE if competing within community + pass
  mutate(SamePair=if_else(comm1==comm2 & gen1==gen2, 1, 0))
#View(NRRL2_CG_Morph_Compete_d14)
```

Condensed plot of competition data, day 14 only:
```{r}
# Condensed plot of competition data
pNRRL2_CG_Morph_Compete_d14_Same_small<-NRRL2_CG_Morph_Compete_d14 %>%
  ggplot(aes(x=strain2, y=fAlt, color=factor(SamePair), pch=strain1)) +
  geom_jitter(height=0, width=0.1, size=2)+
  scale_shape_manual(values=c(0, 15, 1, 16))+
  theme_bw()+
  scale_color_viridis_d(option="inferno", begin=0.3, end=0.7, direction=-1)+
  #scale_colour_discrete()+
  theme(
    axis.text.x = element_text(size=xTextSize, angle = 45, vjust = 1, hjust=1), 
    axis.text.y = element_text(size=xTextSize), 
    axis.title.y=element_text(size=xTextSize+2),
    #axis.text.x=element_blank(),
    #legend.title=element_blank(),
    #legend.position = "none",
    legend.title=element_text(size=xTextSize),
    strip.text = element_text(size=xTextSize),
    plot.title=element_text(hjust=0.5, size=xTextSize+2, face="bold"), 
    legend.text=element_text(size=xTextSize),
    plot.margin = margin(r=40)
    )  +
  labs(y="fAlt", x="", 
       color="Matched", pch="Alt Morph",
       title="In Vitro Competition, Day 14")
  #facet_wrap(~strain2)
pNRRL2_CG_Morph_Compete_d14_Same_small
```

Again:
```{r}
pNRRL2_CG_Morph_Compete_d14_Same_small_facet<-NRRL2_CG_Morph_Compete_d14 %>%
    ggplot(aes(x=strain2, y=fAlt, color=strain1, pch=as.factor(SamePair))) +
  geom_jitter(width=0.05)+
  scale_shape_manual(values=c(16, 1))+
  theme_bw()+
  scale_color_viridis_d(begin=0.2, end=0.8, option="inferno")+
  theme(
    axis.text=element_text(size=xTextSize), 
    axis.title=element_text(size=xTextSize+2),
    strip.text=element_text(size=xTextSize),
    plot.title=element_text(hjust=0.5, size=xTextSize+2, face="bold"), 
    legend.text=element_text(size=xTextSize),
    legend.title =element_text(size=xTextSize),
    axis.text.x = element_text(angle=90, vjust = 0.6),
    plot.margin = margin(r=40)
    )  +
  labs(y="Fraction Alternate Morph", x="Original Morph", title="In Vitro Competition, Day 14",
       color="Alt Morph", pch="Matched")+
  facet_wrap(~strain1)
pNRRL2_CG_Morph_Compete_d14_Same_small_facet
```
Statistics. First reduce the data frame to just the proportion fAlt and the factors:
```{r}
NRRL2_CG_Morph_Compete_d14_s<- NRRL2_CG_Morph_Compete_d14 %>%
  dplyr::select(strain1, strain2, gen1, gen2, comm1, comm2, SamePair, fAlt)
```

Contrasts for beta regression
```{r}
# strain ID
contrasts(NRRL2_CG_Morph_Compete_d14_s$strain1)<-contr.sum(levels(NRRL2_CG_Morph_Compete_d14_s$strain1))
colnames(contrasts(NRRL2_CG_Morph_Compete_d14_s$strain1))<-head(levels(NRRL2_CG_Morph_Compete_d14_s$strain1),-1)
contrasts(NRRL2_CG_Morph_Compete_d14_s$strain2)<-contr.sum(levels(NRRL2_CG_Morph_Compete_d14_s$strain2))
colnames(contrasts(NRRL2_CG_Morph_Compete_d14_s$strain2))<-head(levels(NRRL2_CG_Morph_Compete_d14_s$strain2),-1)

#generation
NRRL2_CG_Morph_Compete_d14_s$gen1<-as.factor(NRRL2_CG_Morph_Compete_d14_s$gen1)
NRRL2_CG_Morph_Compete_d14_s$gen2<-as.factor(NRRL2_CG_Morph_Compete_d14_s$gen2)
contrasts(NRRL2_CG_Morph_Compete_d14_s$gen1)<-contr.sum(levels(NRRL2_CG_Morph_Compete_d14_s$gen1))
colnames(contrasts(NRRL2_CG_Morph_Compete_d14_s$gen1))<-head(levels(NRRL2_CG_Morph_Compete_d14_s$gen1),-1)
contrasts(NRRL2_CG_Morph_Compete_d14_s$gen2)<-contr.sum(levels(NRRL2_CG_Morph_Compete_d14_s$gen2))
colnames(contrasts(NRRL2_CG_Morph_Compete_d14_s$gen2))<-head(levels(NRRL2_CG_Morph_Compete_d14_s$gen2),-1)

# community
NRRL2_CG_Morph_Compete_d14_s$comm1<-as.factor(NRRL2_CG_Morph_Compete_d14_s$comm1)
NRRL2_CG_Morph_Compete_d14_s$comm2<-as.factor(NRRL2_CG_Morph_Compete_d14_s$comm2)
contrasts(NRRL2_CG_Morph_Compete_d14_s$comm1)<-contr.sum(levels(NRRL2_CG_Morph_Compete_d14_s$comm1))
colnames(contrasts(NRRL2_CG_Morph_Compete_d14_s$comm1))<-head(levels(NRRL2_CG_Morph_Compete_d14_s$comm1),-1)
contrasts(NRRL2_CG_Morph_Compete_d14_s$comm2)<-contr.sum(levels(NRRL2_CG_Morph_Compete_d14_s$comm2))
colnames(contrasts(NRRL2_CG_Morph_Compete_d14_s$comm2))<-head(levels(NRRL2_CG_Morph_Compete_d14_s$comm2),-1)
```


Determine whether strain identities are significant factors.
```{r}
#pairwise_betar_strain<-betareg(fAlt ~ strain1 * strain2, data=NRRL2_CG_Morph_Compete_d14_s)
pairwise_betar_strain<-betareg(fAlt ~ strain1 + strain2, data=NRRL2_CG_Morph_Compete_d14_s)
pairwise_betar_strain_est<-broom::tidy(pairwise_betar_strain)
pairwise_betar_strain_est
#write.csv(pairwise_betar_strain_est, file = 'pairwise_betar_strainpairs_est.csv', row.names = FALSE)
write.csv(pairwise_betar_strain_est, file = 'pairwise_betar_strain_est.csv', row.names = FALSE)
```

Diagnostics
```{r}
plot(pairwise_betar)
```

Now test for generation
```{r}
pairwise_betar_gen<-betareg(fAlt ~ gen1 + gen2, data=NRRL2_CG_Morph_Compete_d14_s)
pairwise_betar_gen_est<-broom::tidy(pairwise_betar_gen)
pairwise_betar_gen_est
```
Confirm contrasts
```{r}
contrasts(NRRL2_CG_Morph_Compete_d14_s$gen2)
```

Diagnostics:
```{r}
plot(pairwise_betar_gen)
```

Same regression, with community:
```{r}
pairwise_betar_comm<-betareg(fAlt ~ comm1 + comm2, data=NRRL2_CG_Morph_Compete_d14_s)
pairwise_betar_comm_est<-broom::tidy(pairwise_betar_comm)
pairwise_betar_comm_est
```

Diagnostics
```{r}
plot(pairwise_betar_comm)
```

Full model (all factors, leaving out passage number of original morph since there is confounding with unique community value for ancestor, and because otherwise this factor is ns):
```{r}
pairwise_betar<-betareg(fAlt ~ gen1 + comm1 + comm2, data=NRRL2_CG_Morph_Compete_d14_s)
pairwise_betar_est<-broom::tidy(pairwise_betar)
pairwise_betar_est
write.csv(pairwise_betar_est, file = 'pairwise_betar_est.csv', row.names = FALSE)
```

Diagnostics
```{r}
plot(pairwise_betar)
```

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
## Pairwise competition with worms on plates
Read in data:
```{r}
CG_Compete_PlusWorm<-read_excel("NRRL2CXMorphologyCompetition.xlsx", sheet="20230731PlusWorm")
names(CG_Compete_PlusWorm)
CG_Compete_PlusWorm<-as_tibble(CG_Compete_PlusWorm, stringsAsFactors="TRUE")

#glimpse(CG_Compete_PlusWorm)
#View(CG_Compete_PlusWorm)
# max proportion alternate
max(CG_Compete_PlusWorm$fAlt, na.rm=TRUE) #82.6%
```

Plot out raw proportion fAlt data
```{r}
# rename ancestor
CG_Compete_PlusWorm$ori<-replace(CG_Compete_PlusWorm$ori,
                                CG_Compete_PlusWorm$ori=="ANC",
                                        "WT") 

# reorder levels
#unique(CG_Compete_PlusWorm$alt)
CG_Compete_PlusWorm$alt <-factor(CG_Compete_PlusWorm$alt,
                                        levels=c("A2a10", "F2a10"))
#unique(CG_Compete_PlusWorm$ori)
CG_Compete_PlusWorm$ori <-factor(CG_Compete_PlusWorm$ori,
                                        levels=c("WT", "A1o10", "A2o10",
                                                 "F1o10", "F2o10"))
# plot
CG_Compete_PlusWorm %>%
  ggplot(aes(x=day, y=fAlt, color=alt)) +
  geom_line(aes(linetype=factor(isolate)))+
  theme_bw()+
  scale_colour_discrete()+
  theme(
    axis.text=element_text(size=xTextSize), 
    axis.title=element_text(size=xTextSize+2),
    strip.text=element_text(size=xTextSize),
    plot.title=element_text(hjust=0.5, size=xTextSize+2, face="bold"), 
    legend.text=element_text(size=xTextSize))  +
  labs(y="Fraction Alternate Morph", x="Day", title="+Worms",
       linetype="Isolate", color="Alt Morph")+
  facet_grid(vars(ori), vars(dAlt)) # by original morph and starting alt dilution (1:10 or 1:1)
```

Maybe plot this as a difference map instead of raw data for simplicity?
```{r}
temp1<-CG_Compete_PlusWorm %>%
  dplyr::select(day, isolate, ori, alt, condition, dAlt, fAlt) %>%
  pivot_wider(names_from = day, values_from=fAlt, 
              names_prefix="day") %>%
  #mutate(delta7=day7-day0, delta14=day14-day7) %>% # get the deltas between time points
  #dplyr::select(isolate, condition, dAlt, day0, day14, delta7, delta14) %>%
  dplyr::select(isolate, ori, alt, condition, dAlt, day0, day7) %>%
  rename(f1=day0, f2=day7)
temp2<-CG_Compete_PlusWorm %>%
  dplyr::select(day, isolate, ori, alt, condition, dAlt, fAlt) %>%
  pivot_wider(names_from = day, values_from=fAlt, 
              names_prefix="day") %>%
  #mutate(delta7=day7-day0, delta14=day14-day7) %>% # get the deltas between time points
  #dplyr::select(isolate, condition, dAlt, day0, day14, delta7, delta14) %>%
  dplyr::select(isolate, ori, alt, condition, dAlt, day7, day14) %>%
  rename(f1=day7, f2=day14)

CG_Compete_PlusWorm_Diff<-rbind(temp1, temp2)
rm(temp1, temp2)

CG_Compete_PlusWorm_Diff$Community<-substr(CG_Compete_PlusWorm_Diff$alt, 1,1)

pCG_Compete_PlusWorm_Diff<-CG_Compete_PlusWorm_Diff %>%
  ggplot(aes(x=f1, y=f2, color=ori))+
  geom_point(size=2)+
  theme_bw()+
  geom_abline(slope=1, intercept=0)+
  #scale_colour_viridis_d(begin=0.92, end=0)+
  #scale_color_brewer(palette="Dark2")+
  scale_color_manual(values=c("black", "red2",  "red4",
                                        "dodgerblue2", "dodgerblue4")) +
  theme(
    axis.text.x=element_text(size=xTextSize, angle = 45, vjust = 1, hjust=1),
    axis.text.y=element_text(size=xTextSize),
    axis.title=element_text(size=xTextSize+2),
    strip.text=element_text(size=xTextSize),
    plot.title=element_text(hjust=0.5, size=xTextSize+2, face="bold"), 
    legend.text=element_text(size=xTextSize))  +
  labs(y="Final fAlt", x="Initial fAlt",
       title="+Worms", color="")+
  facet_wrap(~alt)
pCG_Compete_PlusWorm_Diff
```

fAlt data from chunks cut out of plates passaged in quadruplicate from day 14 of the experiment above. Diameters taken at 3 days, CFUs taken after 7 further days

```{r}
CG_Compete_WormDiameter<-read_excel("NRRL2CXMorphologyCompetition.xlsx", sheet="20230817WormDiameter")
names(CG_Compete_WormDiameter)
CG_Compete_WormDiameter<-as_tibble(CG_Compete_WormDiameter, stringsAsFactors="TRUE")
glimpse(CG_Compete_WormDiameter)

# rename ancestor
CG_Compete_WormDiameter$Ori<-replace(CG_Compete_WormDiameter$Ori,
                                CG_Compete_WormDiameter$Ori=="ANC",
                                        "WT") 
# reorder
unique(CG_Compete_WormDiameter$Ori)
CG_Compete_WormDiameter$Ori <-factor(CG_Compete_WormDiameter$Ori,
                                  levels=c("WT", "A1o10", "A2o10",
                                           "F1o10", "F2o10"))

my_comparisons <- list(c("A1o10", "A2o10"),
                       c("F1o10", "F2o10"),
                       c("WT", "A1o10"), 
                        c("WT", "A2o10"), 
                        c("WT", "F1o10"),
                        c("WT", "F2o10")
                        )
pCG_Compete_WormDiameter<-CG_Compete_WormDiameter %>%
  ggplot(aes(x=Ori, y=Diameter))+
  geom_jitter(width=0.2, size=2, aes(color=Alt))+
  theme_bw()+
  scale_colour_viridis_d(begin=0.4, end=0.75, option="inferno")+
  #scale_color_brewer(palette="Dark2")+
  #scale_color_manual(values=c("chartreuse3", "darkorchid2")) +
  theme(
    axis.text.x=element_text(size=xTextSize, angle = 45, vjust = 1, hjust=1),
    axis.text.y=element_text(size=xTextSize),
    axis.title=element_text(size=xTextSize+2),
    strip.text=element_text(size=xTextSize),
    plot.title=element_text(hjust=0.5, size=xTextSize+2, face="bold"), 
    legend.text=element_text(size=xTextSize),
    #legend.position = "top"
    #legend.position=c(0.8, 0.8)
    )  +
  stat_compare_means(comparisons=my_comparisons,
                     label = "p.signif")+
  #stat_compare_means(label.y=1.2) +
  labs(title="+Worms", y="Diameter (cm)", x="", color="")
pCG_Compete_WormDiameter
```
Global test:
```{r}
kruskal.test(Diameter~Ori, data=CG_Compete_WormDiameter)
```

and the CFU data
```{r}
CG_Compete_WormChunk<-read_excel("NRRL2CXMorphologyCompetition.xlsx", sheet="20230814WormChunk")
#names(CG_Compete_WormChunk)
CG_Compete_WormChunk<-as_tibble(CG_Compete_WormChunk, stringsAsFactors="TRUE")
#glimpse(CG_Compete_WormChunk)

# first reorder levels
# rename ancestor
CG_Compete_WormChunk$Ori<-replace(CG_Compete_WormChunk$Ori,
                                CG_Compete_WormChunk$Ori=="ANC",
                                        "WT") 

#unique(CG_Compete_WormChunk$Ori)
CG_Compete_WormChunk$Ori <-factor(CG_Compete_WormChunk$Ori,
                                        levels=c("WT", "A1o10", "A2o10",
                                                 "F1o10", "F2o10"))

pCG_Compete_WormChunk<-CG_Compete_WormChunk %>%
  ggplot(aes(x=Chunk, y=fAlt)) +
  geom_jitter(width=0.1, size=2, aes(color=Alt))+
  theme_bw()+
  ylim(-0.1, 1.1)+
  #scale_colour_discrete()+
  #scale_color_manual(values=c("chartreuse3", "darkorchid2")) +
    scale_colour_viridis_d(begin=0.4, end=0.75, option="inferno")+
  theme(
    axis.text.x=element_text(size=xTextSize, angle = 45, vjust = 1, hjust=1),
    #axis.text.x=element_blank(),
    axis.text.y=element_text(size=xTextSize),
    axis.title=element_text(size=xTextSize+2),
    strip.text=element_text(size=xTextSize),
    plot.title=element_text(hjust=0.5, size=xTextSize+2, face="bold"), 
    legend.text=element_text(size=xTextSize))  +
  labs(y="fAlt", x="", title="+Worms",
       color="")+
  facet_wrap(~Ori, nrow=1)+
  stat_compare_means(method="wilcox.test", 
                     label.y=1.05,
                     aes(label = paste0("p =", ..p.format..)))
pCG_Compete_WormChunk
```


FIGURE 2
```{r}
# Version with the condensed in vitro day 14 data

#pCG_Compete_AB<-plot_grid(pNRRL2_MorphCompeteInVitro_fAlt,
#                          pNRRL2_CG_Morph_Compete_d14_Same_small,
#                          ncol=1,
#                          rel_heights = c(1.8, 1),
#                          labels="AUTO")
#pCG_Compete_CD<-plot_grid(pCG_Compete_PlusWorm_Diff, 
#                          pCG_Compete_WormDiameter,
#                          nrow=1,
#                          rel_widths=c(1, 0.7), 
#                          labels=c("C", "D"))
#pCG_Compete_CDE<-plot_grid(pCG_Compete_CD,
#                           pCG_Compete_WormChunk,
#                           ncol=1,
#                           labels=c("", "E"))
#pCG_Compete<-plot_grid(pCG_Compete_AB,
#                       pCG_Compete_CDE,
#                       ncol=2,
#                       #rel_heights = c(1.8, 0.8, 0.9, 1),
#                       labels=c("", ""))

pNRRL2_CG_Morph_Compete_d14_Same_small_facet / 
  (pCG_Compete_PlusWorm_Diff+pCG_Compete_WormDiameter)/
     pCG_Compete_WormChunk +
  plot_annotation(tag_levels = 'A') +
  plot_layout(heights=c(1.8,1,1))


#pCG_Compete
#ggsave("Fig2_CG_Compete.png", width=14, height=7, units="in", dpi=400)
ggsave("Fig2_CG_Compete.tiff", height=336, width=220, units="mm")
# full page width = 168 mm
```

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Motility
## Motility in Different Agar Concentrations

Read in data:
```{r}
motility_1p5 <- read_excel("CG_motility_all.xlsx", sheet = 3)
motility_p5 <- read_excel("CG_motility_all.xlsx", sheet = 2)
motility_p35 <- read_excel("CG_motility_all.xlsx", sheet = 1)
```

Quick check:
```{r}
glimpse(motility_p5)
```

Now pivot each one. First 1.5%
```{r}
motility_1p5 <- motility_1p5 %>%
  pivot_longer(cols = A1o6:WT,
               names_to = "Samples",
               values_to = "Diameter"
               )
glimpse(motility_1p5)
```

0.5% agar:
```{r}
motility_p5 <- motility_p5[,-1] #remove column 1 (date_time) - not needed
motility_p5 <- motility_p5 %>%
  pivot_longer(cols = A1o6:WT,
               names_to = "Samples",
               values_to = "Diameter"
               )
#glimpse(motility_p5)
```

And 0.35%
```{r}
motility_p35 <- motility_p35 %>%
  pivot_longer(cols = A1o6:WT,
               names_to = "Samples",
               values_to = "Diameter"
               )
#glimpse(motility_p35)
```

Combine to a single data frame
```{r}
motility_agarconc<-rbind(motility_1p5, motility_p5, motility_p35)
#glimpse(motility_agarconc)
```

add columns for Community, Morph, Pass
```{r}
motility_agarconc<-motility_agarconc %>%
  mutate(Community=substr(Samples, 1, 2),
         Morph=substr(Samples, 3, 3),
         Pass=substr(Samples, 4, 5))
glimpse(motility_agarconc)
```

Need to tidy this up:
```{r}
motility_agarconc<-motility_agarconc %>%
  mutate(Morph=replace(Morph, Community=="WT", "o")) %>% # WT is original morph
  mutate(Pass=replace(Pass, Community=="WT", 0)) # and is passage 0
glimpse(motility_agarconc)
```

Label the last time point for convenience
```{r}
# label the last time point
motility_agarconc<-motility_agarconc %>%
  group_by(agar) %>%
  mutate(isLastTime = (days == max(days)))
glimpse(motility_agarconc)
```

I've made an ID column to remove the poorly growing A2o6 isolate 2 in these experiments
```{r}
motility_agarconc$ID <- paste(motility_agarconc$isolate,motility_agarconc$Samples)
motility_agarconc<-motility_agarconc %>%
  filter(ID!="2 A2o6")
```

Plot out last time only:
```{r}
# and plot
pmotility_agarconc_LastDay<-motility_agarconc %>%
  filter(isLastTime==TRUE) %>%
  mutate(Morph=recode(Morph, "a"="Alternate", "o"="Original")) %>% # recode labels
  ggplot(aes(x=factor(Community), y=Diameter,
             color=factor(Morph))) + #, group=factor(Pass))) +
  #scale_color_manual(values=c("red2", "darkblue")) +
  scale_colour_viridis_d(begin=0.4, end=0.75, option="inferno")+
  #geom_boxplot(aes(fill=Community)) +
  #scale_fill_brewer(palette="Set3") +
  geom_jitter(aes(shape=factor(Pass)), width=0.1)+
  theme_classic()+
  theme(
    axis.text=element_text(size=xTextSize),
    axis.title = element_text(size=xTextSize+1),
    plot.title=element_text(hjust=0.5, size=xTextSize),
    strip.text=element_text(size=xTextSize),
    legend.text = element_text(size=xTextSize),
    legend.title = element_text(size=xTextSize)
  )+
  facet_wrap(~agar, scales="free_y") +
  labs(title="Agar Concentration", x="Community",
       y="Diameter (cm)", color="Morph", shape="Pass")

pmotility_agarconc_LastDay
```

Stats. Filter data for non-parametrics
```{r}
motility_agarconc_lasttime<-motility_agarconc %>%
  filter(isLastTime==TRUE) %>%
  mutate(Morph=recode(Morph, "a"="Alternate", "o"="Original"))

motility_agarconc_lasttime_35<-motility_agarconc_lasttime %>%
  filter(agar==0.35) %>%
  mutate(Pass=as.factor(Pass))
motility_agarconc_lasttime_5<-motility_agarconc_lasttime %>%
  filter(agar==0.5)%>%
  mutate(Pass=as.factor(Pass))
motility_agarconc_lasttime_1p5<-motility_agarconc_lasttime %>%
  filter(agar==1.5)%>%
  mutate(Pass=as.factor(Pass))
```

Test for pass as factor.
```{r}
temp<-motility_agarconc_lasttime_35 %>%
  filter(Morph=="Alternate")
kruskal.test(Diameter~Pass, data=temp)
kruskal.test(Diameter~Community, data=temp)
temp<-motility_agarconc_lasttime_35 %>%
  filter(Morph=="Original")
kruskal.test(Diameter~Pass, data=temp)
kruskal.test(Diameter~Community, data=temp)

temp<-motility_agarconc_lasttime_5 %>%
  filter(Morph=="Alternate")
kruskal.test(Diameter~Pass, data=temp)
kruskal.test(Diameter~Community, data=temp)
temp<-motility_agarconc_lasttime_5 %>%
  filter(Morph=="Original")
kruskal.test(Diameter~Pass, data=temp)
kruskal.test(Diameter~Community, data=temp)

temp<-motility_agarconc_lasttime_1p5 %>%
  filter(Morph=="Alternate")
kruskal.test(Diameter~Pass, data=temp)
kruskal.test(Diameter~Community, data=temp)
temp<-motility_agarconc_lasttime_1p5 %>%
  filter(Morph=="Original")
kruskal.test(Diameter~Pass, data=temp)
kruskal.test(Diameter~Community, data=temp)
```


Alternate vs original morphs
```{r}

wilcox.test(Diameter~Morph, data=motility_agarconc_lasttime_35)
```
```{r}
wilcox.test(Diameter~Morph, data=motility_agarconc_lasttime_5)
```

```{r}
wilcox.test(Diameter~Morph, data=motility_agarconc_lasttime_1p5)
```

Create a data summary:
```{r}
motility_agarconc_summ<-motility_agarconc %>%
  group_by(agar, Community, Morph, Pass, days) %>% #pick what you want to summarize
  summarize(min = min(Diameter), 
            max = max(Diameter), #saying what we want to summarize, stats and data
            mean = mean(Diameter), 
            q1= quantile(Diameter, probs = 0.25), 
            median = median(Diameter), 
            q3= quantile(Diameter, probs = 0.75),
            sd = sd(Diameter)) %>%
  mutate_if(is.numeric, round, digits=2) #values, if something is numeric, round to 2 decimals

#View(motility_agarconc_summ)
```

Let's get swarm diameters for the ancestor for use as reference lines:
```{r}
LastTime_p35<-round(max(motility_agarconc$days[motility_agarconc$agar==0.35]), digits = 2)
LastTime_p5<-max(motility_agarconc$days[motility_agarconc$agar==0.5])
LastTime_1p5<-max(motility_agarconc$days[motility_agarconc$agar==1.5])
ancestor_median_p35<-motility_agarconc_summ$median[motility_agarconc_summ$agar==0.35 &
                                           motility_agarconc_summ$Community=="WT" &
                                           motility_agarconc_summ$days==LastTime_p35]
ancestor_median_p5<-motility_agarconc_summ$median[motility_agarconc_summ$agar==0.5 &
                                           motility_agarconc_summ$Community=="WT" &
                                           motility_agarconc_summ$days==LastTime_p5]
ancestor_median_1p5<-motility_agarconc_summ$median[motility_agarconc_summ$agar==1.5 &
                                           motility_agarconc_summ$Community=="WT" &
                                           motility_agarconc_summ$days==LastTime_1p5]
```


~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
## Motility on Soft 0.35% Agar, Passes 5-10

Start with community A data. Read in:
```{r}
motilityA_p35 <- read_excel("CG_motility_all.xlsx", sheet = '.35 As')
motilityA_p35 <- motilityA_p35 %>%
  pivot_longer(cols = A1o1:WT, #change first and last column name accordingly
               names_to = "Samples",
               values_to = "Diameter"
               )
#head(motilityA_p35)
```

Create some new columns for labels:
```{r}
motilityA_p35<-motilityA_p35 %>%
  mutate(Community=substr(Samples, 1, 2),
         Morph=substr(Samples, 3, 3),
         Pass=substr(Samples, 4, 5))
```

And clean up:
```{r}
motilityA_p35<-motilityA_p35 %>%
  mutate(Morph=replace(Morph, Community=="WT", "o")) %>% # ..that WT is original morph
  mutate(Pass=replace(Pass, Community=="WT", 0)) # and is passage 0
motilityA_p35$Pass<-as.numeric(motilityA_p35$Pass)
#View(motilityA_p35)
```

Get rid of missing data:
```{r}
motilityA_p35 <- motilityA_p35[!(is.na(motilityA_p35$Diameter)), ]
#View(motilityA_p35)
```

What time points exist?
```{r}
unique(motilityA_p35$days)
```

Let's summarize at day 1.8 for consistency with previous data:
```{r}
motilityA_p35_day1p8_summ<-motilityA_p35 %>%
  filter(days==1.833) %>%
  group_by(Community, Morph, Pass) %>% #pick what you want to summarize
  summarize(min = min(Diameter), 
            max = max(Diameter), #saying what we want to summarize
            mean = mean(Diameter, na.rm=TRUE), 
            q1= quantile(Diameter, probs = 0.25, na.rm=TRUE), 
            median = median(Diameter, na.rm=TRUE), 
            q3= quantile(Diameter, probs = 0.75, na.rm=TRUE),
            sd = sd(Diameter, na.rm=TRUE),
            nreps=n()) %>%
  mutate_if(is.numeric, round, digits=2) #values, if something is numeric, round to 2 decimals

#View(motilityA_p35_day1p8_summ)
```

And plot all replicates:
```{r}
day1p8_WTmedian_A<-median(motilityA_p35$Diameter[motilityA_p35$Community=="WT" &
                                                        motilityA_p35$days==1.833])
rep.35A.day1p8.facet<-motilityA_p35 %>%
  filter(days==1.833 & Community!="WT") %>%
  ggplot(aes(x=as.factor(Pass), y=Diameter)) +
  #geom_point(size=2) +
  theme_light()+
  geom_jitter(size=2, width=0, height=0.2, aes(color=factor(isolate)))+
  scale_color_viridis_d(option="turbo")+
  #scale_shape_manual(values=c(16,16))+
  geom_hline(aes(yintercept = day1p8_WTmedian_A, group = Pass), colour = 'firebrick4') + #WT median
    theme(
    axis.text=element_text(size=xTextSize),
    axis.title = element_text(size=xTextSize+1),
    title=element_text(hjust=0.5, size=xTextSize),
    strip.text=element_text(size=xTextSize),
    legend.text = element_text(size=xTextSize),
    legend.position = "none"
  )+
  facet_wrap(~Community) + 
  stat_compare_means(label.x=2, label.y=2.5, aes(label = paste0("p = ", after_stat(p.format))))+
  labs(title="Community A", x="Pass",
       y="Diameter (cm)", color="Isolate")
rep.35A.day1p8.facet
```


Now the community F data. Read in:
```{r}
motilityF_p35 <- read_excel("CG_motility_all.xlsx", sheet = '.35 Fs')
motilityF_p35 <- motilityF_p35 %>%
  pivot_longer(cols = F1o1:WT, #change first and last column name accordingly
               names_to = "Samples",
               values_to = "Diameter"
               )
head(motilityF_p35)
```

Make some data types change so we can use them:
```{r}
motilityF_p35$isolate<-as.factor(motilityF_p35$isolate)

motilityF_p35 <- motilityF_p35 %>%
  mutate_if(is.numeric, round, digits=2)

#View(motilityF_p35)
```


Create some new columns for labels:
```{r}
motilityF_p35<-motilityF_p35 %>%
  mutate(Community=substr(Samples, 1, 2),
         Morph=substr(Samples, 3, 3),
         Pass=substr(Samples, 4, 5))
```

And clean up:
```{r}
motilityF_p35 <- motilityF_p35[!(is.na(motilityF_p35$Diameter)), ]

motilityF_p35<-motilityF_p35 %>%
  mutate(Morph=replace(Morph, Community=="WT", "o")) %>% # ..that WT is original morph
  mutate(Pass=replace(Pass, Community=="WT", 0)) # and is passage 0
motilityF_p35$Pass<-as.numeric(motilityF_p35$Pass)
#glimpse(motilityF_p35)
```

What time points exist?
```{r}
unique(motilityF_p35$days)
```

Let's summarize at day 1.67 for consistency with previous data:
```{r}
motilityF_p35_day1p7_summ<-motilityF_p35 %>%
  filter(days==1.67) %>%
  group_by(Community, Morph, Pass) %>% #pick what you want to summarize
  summarize(min = min(Diameter), 
            max = max(Diameter), #saying what we want to summarize
            mean = mean(Diameter, na.rm=TRUE), 
            q1= quantile(Diameter, probs = 0.25, na.rm=TRUE), 
            median = median(Diameter, na.rm=TRUE), 
            q3= quantile(Diameter, probs = 0.75, na.rm=TRUE),
            sd = sd(Diameter, na.rm=TRUE),
            nreps=n()) %>%
  mutate_if(is.numeric, round, digits=2) #values, if something is numeric, round to 2 decimals

#View(motilityF_p35_day1p7_summ)
```

And plot all replicates:
```{r}
day1p8_WTmedian_F<-median(motilityF_p35$Diameter[motilityF_p35$Community=="WT" &
                                                        motilityF_p35$days==1.67])
rep.35F.day1p8.facet <- motilityF_p35 %>%
  filter(days==1.67 & Community!="WT") %>%
  ggplot(aes(x=as.factor(Pass), y=Diameter)) +
  theme_light()+
  geom_jitter(size=2, width=0, height=0.2, aes(color=factor(isolate)))+
  scale_color_viridis_d(option="turbo")+
  #scale_shape_manual(values=c(16,16))+
  geom_hline(aes(yintercept = day1p8_WTmedian_F, group = Pass), 
             colour = 'firebrick4') + #WT median
    theme(
    axis.text=element_text(size=xTextSize),
    axis.title = element_text(size=xTextSize+1),
    title=element_text(hjust=0.5, size=xTextSize),
    strip.text=element_text(size=xTextSize),
    legend.text = element_text(size=xTextSize)
  )+
  facet_wrap(~Community) + 
  stat_compare_means(label.x=2, label.y=2.1, aes(label = paste0("p = ", after_stat(p.format))))+
  labs(title="Community F", x="Pass",
       y="", color="Isolate")

rep.35F.day1p8.facet
```

Now we can put the plots together:
```{r}
pMultiPassDiameter_AF<-plot_grid(rep.35A.day1p8.facet, rep.35F.day1p8.facet, 
                                 ncol=2, rel_widths = c(0.8, 1), labels=c("B", "C"))
pCGMotilitySummary<-plot_grid(pmotility_agarconc_LastDay, 
                              pMultiPassDiameter_AF,
                              ncol=1, rel_heights=c(1,0.9), labels=c("A", ""))

pCGMotilitySummary

#ggsave("Fig3_pCGMotilitySummary.png", width=10, height=8, units="in", dpi=400)
ggsave("Fig3_pCGMotilitySummary.tiff", width=228, height=152, units="mm")
# 2/3 page 114 mm width
```


~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# Motility in Varying Nutrient Concentration
## Community F, NGM 0.2-4X
2023-05-18. Isolates were colonies (n=3) of original or alternate morph picked from a new streak-out of the worm digest glycerol stock of community F2 pass 6. Grew overnight in 1 mL LB, spun down 900 uL for 2 min at 8000xg, and resuspended in same vol of liquid NGM 0.25X peptone. From these, constructed 10^8 stocks in the correct liquid NGM, and dispensed in triplicate as 150 uL into 96 well plate (technical replicates from each stock). Plate was covered with BreatheEasy and moved to 25C with shaking for 6 hours. Plates were poured and cooled to standard specs, then inoculated with 1 uL in the center of the plate.

Note that there were no ancestor controls here - we are instead comparing across nutrient densities. Also note that I am using isolate IDs 1-3 for convenience; these are F2o6 #5-7 and F2a6 #7-9.

First, read in data:
```{r}
nd_diam_F <- read_excel("CG_motility_all.xlsx", sheet = "nutrientF")
#view(nd_diam_F)
nd_diam_F<-nd_diam_F %>%
    mutate(Morph=recode(Morph, "a"="Alternate", "o"="Original")) # recode labels
```

Data are already in a ggplot-usable format, no need to modify. Let's go ahead and plot.
Clearly, all isolates and replicates within a given morph are behaving similarly. Interestingly, the standard NGM peptone concentration (1X) seems to allow larger diameters than either the low or high peptone condition, but only really for the original isolates.
```{r}
nd_diam_F %>%
  ggplot(aes(x=days, y=Diameter, color=Morph)) +
  geom_point(size=2) +
  scale_colour_viridis_d(begin=0.4, end=0.75, option="inferno")+
  #scale_color_manual(values=c("red2", "darkblue")) +
  #geom_smooth(method = "lm", fill = NA)+
  geom_smooth(method="lm", formula = y ~ log(x), fill="NA")+
  theme_light()+
  labs(title="Nutrient Concentration", 
       x="Time (Days)", y="Diameter", color="Morph") +
  theme(text = element_text(size = 14)) +
  facet_wrap(~Peptone, ncol=3)
```

Can we get slopes between time points? First let's make a unique ID:
```{r}
nd_diam_F <- nd_diam_F %>%
  unite("ID", Morph:techrep, remove=FALSE) # create an ID by merging morph, rep, and techrep
unique(nd_diam_F$ID)
```

Using this ID we can trace individual replicates over time points:
```{r}
my_times<-unique(nd_diam_F$hours)
my_times
```
Set up a data object to keep the values:
```{r}
my_wells<-unique(nd_diam_F$SourceWell)
my_len<-length(my_wells)
nd_diam_slope_F<-tibble(SourceWell=rep(my_wells,times=5), 
                      hours=c(rep(my_times[2], my_len),
                              rep(my_times[3], my_len),
                              rep(my_times[4], my_len),
                              rep(my_times[5], my_len),
                              rep(my_times[6], my_len)),
                      slope=NA)
#view(nd_diam_slope_F)
```

And set up a loop:
```{r}
for(i in 2:6){
  for(j in seq_along(my_wells)){
    my_slope<-(nd_diam_F$Diameter[nd_diam_F$hours==my_times[i] & 
                                    nd_diam_F$SourceWell == my_wells[j]] - 
                 nd_diam_F$Diameter[nd_diam_F$hours==my_times[i-1] & 
                                      nd_diam_F$SourceWell == my_wells[j]])/(my_times[i] - my_times[i-1])
    nd_diam_slope_F$slope[nd_diam_slope_F$hours==my_times[i] & 
                            nd_diam_slope_F$SourceWell == my_wells[j]] <- my_slope
  }
}

```

Check
```{r}
view(nd_diam_slope_F)
```

Create some labels for the slopes
```{r}
nd_diam_slope_F$Morph<-NA
nd_diam_slope_F$isolate<-NA
nd_diam_slope_F$techrep<-NA
nd_diam_slope_F$Peptone<-NA

for(j in seq_along(my_wells)){
  nd_diam_slope_F$Morph[nd_diam_slope_F$SourceWell==my_wells[j]] <- unique(nd_diam_F$Morph[nd_diam_F$SourceWell==my_wells[j]])
  nd_diam_slope_F$isolate[nd_diam_slope_F$SourceWell==my_wells[j]] <- unique(nd_diam_F$isolate[nd_diam_F$SourceWell==my_wells[j]])
  nd_diam_slope_F$techrep[nd_diam_slope_F$SourceWell==my_wells[j]] <- unique(nd_diam_F$techrep[nd_diam_F$SourceWell==my_wells[j]])
  nd_diam_slope_F$Peptone[nd_diam_slope_F$SourceWell==my_wells[j]] <- unique(nd_diam_F$Peptone[nd_diam_F$SourceWell==my_wells[j]])
  }
```

Add days:
```{r}
nd_diam_slope_F<- nd_diam_slope_F %>%
  mutate(days=hours/24)
#nd_diam_slope_F<-nd_diam_slope_F %>%
#    mutate(Morph=recode(Morph, "a"="Alternate", "o"="Original")) # recode labels
```


Plot out slopes. Expansion rate of the original morphs spikes then drops after about 24 hours in low and high peptone but not in the medium peptone condition. Whereas expansion of the alternate morphs is nearly flat across conditions - the high-peptone colonies started larger (as of 17h) but didn't really expand any faster from there.
```{r}
nd_diam_slope_F %>%
  ggplot(aes(x=days, y=slope, color=Morph))+
    geom_jitter(size=2, width=0.02) +
  geom_smooth(method="lm", formula = y ~ log(x), fill="NA")+
  theme_light()+
  scale_colour_viridis_d(begin=0.4, end=0.75, option="inferno")+
  #scale_color_manual(values=c("red2", "darkblue")) +
  labs(title="", x="Time (Days)", y="Expansion (cm) per Hour", color="Morph") +
  theme(text = element_text(size = xTextSize)) +
  facet_wrap(~Peptone, ncol=3)
```


Summarize the data (across technical replicates)
```{r}
nd_diam_summary_F <- nd_diam_F %>%
  group_by(Peptone, Morph, Pass, isolate, days) %>% #pick what you want to summarize
  summarize(min = min(Diameter), 
            max = max(Diameter), #saying what we want to summarize, stats and data
            mean = mean(Diameter), 
            q1= quantile(Diameter, probs = 0.25), 
            median = median(Diameter), 
            q3= quantile(Diameter, probs = 0.75),
            sd = sd(Diameter)) %>%
  mutate_if(is.numeric, round, digits=2) #values, if something is numeric, round to 2 decimals

View(nd_diam_summary_F)
```

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
## Community A, NGM 0.2-4X
Also pass 6, this time with ancestor and with some extra dilutions. Rows E-G are 10X serial dilutions of the corresponding wells in row A.

First, read in data:
```{r}
nd_diam_A <- read_excel("CG_motility_all.xlsx", sheet = "nutrientA")
#view(nd_diam_A)
```

Clean up:
```{r}
nd_diam_A<-nd_diam_A %>%
  mutate(Morph=replace(Morph, Community=="ANC", "o")) %>% # ..that WT is original morph
  mutate(Pass=replace(Pass, Community=="ANC", 0)) # and is passage 0
nd_diam_A<-nd_diam_A %>%
  mutate(Morph=recode(Morph, "a"="Alternate", "o"="Original")) # recode labels
```


Data are already in a ggplot-usable format, no need to modify. Let's go ahead and plot. 
Clearly, all isolates and replicates within a given morph are behaving similarly. Interestingly, the standard NGM peptone concentration (1X) seems to allow larger diameters than either the low or high peptone condition, but only for the original isolates.
```{r}
nd_diam_A %>%
  filter(Dilution == 0) %>% # only the regular dilution data
  ggplot(aes(x=hours, y=Diameter, color=Morph)) +
  geom_point(size=2) +
  scale_colour_viridis_d(begin=0.4, end=0.75, option="inferno")+
    #scale_color_manual(values=c("red2", "darkblue")) +
  #geom_smooth(method = "lm", fill = NA)+
  geom_smooth(method="lm", formula = y ~ log(x), fill="NA")+
  theme_light()+
  labs(title="Peptone Concentration", 
       x="Time (h)", y="Diameter", color="Morph") +
  theme(text = element_text(size = 14)) +
  facet_wrap(~Peptone, ncol=3)
```

Can we get slopes between time points? First let's make a unique ID:
```{r}
nd_diam_A <- nd_diam_A %>%
  unite("ID", c(SourceWell, Peptone, Dilution), remove=FALSE) # create an ID by merging features
#View(nd_diam_A)
#unique(nd_diam_A$ID)
```

Using this ID we can trace individual replicates over time points. 
```{r}
my_times<-unique(nd_diam_A$hours)
my_times
```
Set up a data object to keep the values:
```{r}
my_wells<-unique(nd_diam_A$ID)
my_len<-length(my_wells)
nd_diam_slope_A<-tibble(ID=rep(my_wells,times=4), 
                      hours=c(rep(my_times[2], my_len),
                              rep(my_times[3], my_len),
                              rep(my_times[4], my_len),
                              rep(my_times[5], my_len)),
                      slope=NA)
#view(nd_diam_slope_A)
```

And set up a loop to go across wells and get the slope of the diameter between time points of the same plate.
```{r}
for(i in 2:5){
  for(j in seq_along(my_wells)){
    if(my_times[i]==68 & substr(my_wells[j],1,1)=="B"){ # B wells drop out after 48h
    nd_diam_slope_A$slope[nd_diam_slope_A$hours==my_times[i] & 
                            nd_diam_slope_A$ID == my_wells[j]] <- NA} 
    else{  
    my_slope<-(nd_diam_A$Diameter[nd_diam_A$hours==my_times[i] & 
                                    nd_diam_A$ID == my_wells[j]] - 
                 nd_diam_A$Diameter[nd_diam_A$hours==my_times[i-1] & 
                                      nd_diam_A$ID == my_wells[j]])/(my_times[i] - my_times[i-1])
    nd_diam_slope_A$slope[nd_diam_slope_A$hours==my_times[i] & 
                            nd_diam_slope_A$ID == my_wells[j]] <- my_slope
    }
  }
}

```

Check
```{r}
view(nd_diam_slope_A)
```

Create some labels for the slopes
```{r}
nd_diam_slope_A$Morph<-NA
nd_diam_slope_A$isolate<-NA
nd_diam_slope_A$techrep<-NA
nd_diam_slope_A$Peptone<-NA
nd_diam_slope_A$Dilution<-NA

for(j in seq_along(my_wells)){
  nd_diam_slope_A$Morph[nd_diam_slope_A$ID==my_wells[j]] <- 
    unique(nd_diam_A$Morph[nd_diam_slope_A$ID==my_wells[j]])
  nd_diam_slope_A$isolate[nd_diam_slope_A$ID==my_wells[j]] <- 
    unique(nd_diam_A$isolate[nd_diam_slope_A$ID==my_wells[j]])
  nd_diam_slope_A$techrep[nd_diam_slope_A$ID==my_wells[j]] <-
    unique(nd_diam_A$techrep[nd_diam_slope_A$ID==my_wells[j]])
  nd_diam_slope_A$Peptone[nd_diam_slope_A$ID==my_wells[j]] <-
    unique(nd_diam_A$Peptone[nd_diam_slope_A$ID==my_wells[j]])
    nd_diam_slope_A$Dilution[nd_diam_slope_A$ID==my_wells[j]] <- 
    unique(nd_diam_A$Dilution[nd_diam_slope_A$ID==my_wells[j]])

}
nd_diam_slope_A$SourceWell<-substr(nd_diam_slope_A$ID,1,2)
```

Add days:
```{r}
nd_diam_slope_A<- nd_diam_slope_A %>%
  mutate(days=hours/24)
```

Remove the NAs:
```{r}
nd_diam_slope_A<-nd_diam_slope_A[complete.cases(nd_diam_slope_A),]
```

And disallow negative slopes, as these presumably are measurement error:
```{r}
idx<-which(nd_diam_slope_A$slope<0)
nd_diam_slope_A$slope[idx]<-0
```

Plot out slopes (Log fits) to check
```{r}
nd_diam_slope_A %>%
  filter(Dilution==0) %>% # just the regular stuff first
  ggplot(aes(x=hours, y=slope, color=Morph))+
    geom_jitter(size=2, width=0.02) +
  geom_smooth(method="lm", formula = y ~ log(x), fill="NA")+
  theme_light()+
  scale_colour_viridis_d(begin=0.4, end=0.75, option="inferno")+
  #scale_color_manual(values=c("red2", "darkblue")) +
  labs(title="", x="Time (h)", y="Expansion (cm) per Hour", color="Morph") +
  theme(text = element_text(size = xTextSize)) +
  facet_wrap(~Peptone, ncol=3)
```

What happens with dilution of the original inoculum?
```{r}
# well IDs for dilution series inocula
well_list=c("A1", "A4", "A7",
            "E1", "E4", "E7",
            "F1", "F4", "F7",
            "G1", "G4", "G7")
```

Plot data with log fits:
```{r}
nd_diam_A %>%
  filter(SourceWell %in% well_list) %>%
    ggplot(aes(x=hours, y=Diameter, color=factor(Dilution)))+
    geom_jitter(size=1, width=0.02)+
    theme_light()+
  scale_color_brewer(palette = "Dark2") +
  geom_smooth(method="lm", formula = y ~ log(x), fill="NA", linewidth=0.7)+
    theme(text = element_text(size = xTextSize),
          axis.text.x = element_text(angle=90)) +
  labs(title="", x="Time (h)", y="Diameter (cm)", color="Dilution") +
  facet_grid(vars(Morph), vars(Peptone))
```

Spreading rates?
```{r}
p_nd_diam_slope_A_lmlines_log_dilution_flip<-nd_diam_slope_A %>%
  filter(SourceWell %in% well_list) %>%
#  mutate(Morph=recode(Morph, "a"="Alternate", "o"="Original")) %>% # recode labels
  ggplot(aes(x=hours, y=slope, color=factor(Dilution)))+
    geom_jitter(size=1, width=0.02) +
  geom_smooth(method="lm", formula = y ~ log(x), fill="NA", linewidth=0.7)+
  theme_light()+
  scale_color_brewer(palette = "Dark2") +
  ylim(-0.05, 0.15)+
  labs(title="", x="Time (h)", y="Expansion (cm/h)", color="Dilution") +
  theme(text = element_text(size = xTextSize),
        axis.text.x = element_text(angle=90)) +
  facet_grid(vars(Morph), vars(Peptone), scales="free_y")
p_nd_diam_slope_A_lmlines_log_dilution_flip
```
Expansion rates grouped by inoculum density 
```{r}
p_nd_diam_slope_A_dilutions<-nd_diam_slope_A %>%
  filter(SourceWell %in% well_list) %>%
  ggplot(aes(x=hours, y=slope, color=factor(Morph), pch=factor(Peptone), linetype=factor(Peptone)))+
    geom_jitter(size=1, width=0.02) +
  geom_smooth(method="lm", formula = y ~ log(x), fill="NA", linewidth=0.7)+
  theme_light()+
  #scale_color_brewer(palette = "Dark2") +
  scale_colour_viridis_d(begin=0.4, end=0.75, option="inferno")+
  scale_linetype_manual(values=c("solid", "dashed", "dotted"))+
    scale_shape_manual(values=c(15, 16, 18))+
    scale_x_continuous(breaks = seq(20, 60, by = 10)) +
  ylim(-0.05, 0.15)+
  labs(title="", x="Time (h)", y="Expansion (cm/h)", color="Morph", pch="Peptone", linetype="Peptone") +
  theme(text = element_text(size = xTextSize-2),
        axis.text.x = element_text(angle=90)) +
  #facet_grid(vars(Dilution), vars(Peptone), scales="free_y")
  facet_wrap(~Dilution, nrow=1)
p_nd_diam_slope_A_dilutions
```
Same idea with the raw data:
```{r}
p_nd_diam_A_dilutions<-nd_diam_A %>%
  filter(SourceWell %in% well_list) %>%
    ggplot(aes(x=hours, y=Diameter, color=factor(Morph), pch=factor(Peptone), linetype=factor(Peptone)))+
    geom_jitter(size=1, width=0.02)+
    theme_light()+
  #scale_color_brewer(palette = "Dark2") +
  scale_colour_viridis_d(begin=0.4, end=0.75, option="inferno")+
  scale_linetype_manual(values=c("solid", "dashed", "dotted"))+
    scale_shape_manual(values=c(15, 16, 18))+
    scale_x_continuous(breaks = seq(10, 60, by = 10)) +
  geom_smooth(method="lm", formula = y ~ log(x), fill="NA", linewidth=0.7)+
    theme(text = element_text(size = xTextSize-2),
          axis.text.x = element_text(angle=90)) +
  labs(title="", x="Time (h)", y="Diameter (cm)", color="Morph",
       pch="Peptone", linetype="Peptone") +
  #facet_grid(vars(Morph), vars(Peptone))
  facet_wrap(~Dilution, nrow = 1)
p_nd_diam_A_dilutions
```

Summarize the data (across technical replicates)
```{r}
nd_diam_summary_A <- nd_diam_A %>%
  filter(Dilution==0) %>% # just the regular stuff, to combine with other data set
  group_by(Peptone, Morph, Pass, isolate, days) %>% #pick what you want to summarize
  summarize(min = min(Diameter), 
            max = max(Diameter), #saying what we want to summarize, stats and data
            mean = mean(Diameter), 
            q1= quantile(Diameter, probs = 0.25), 
            median = median(Diameter), 
            q3= quantile(Diameter, probs = 0.75),
            sd = sd(Diameter)) %>%
  mutate_if(is.numeric, round, digits=2) #values, if something is numeric, round to 2 decimals

#View(nd_diam_summary_A)
```

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
## Combining the data
Let's put the F2 and A2 nutrient data sets together
```{r}
temp1<-nd_diam_A %>%
      filter(Dilution==0) %>% # just the dilution 0 data for comparability
  dplyr::select(days, hours, Strain, Peptone, Community, Morph, ID, Pass, isolate, techrep, Diameter)

temp2<-nd_diam_F %>%
    dplyr::select(days, hours, Strain, Peptone, Community, Morph, ID, Pass, isolate, techrep, Diameter)
nd_diam<-rbind(temp1, temp2)  
rm(temp1, temp2)
```

Plot out together?
```{r}
nd_diam$Community<-factor(nd_diam$Community,
                          levels=c("ANC", "A2", "F2"))

p_nd_diam_lmlines_log_short<-nd_diam %>%
  ggplot(aes(x=hours, y=Diameter, color=Morph, pch=factor(Peptone), linetype=factor(Peptone)))+
    geom_jitter(size=1, width=0.02) +
  geom_smooth(method="lm", formula = y ~ log(x), fill="NA", linewidth=0.7)+
  theme_light()+
  scale_colour_viridis_d(begin=0.4, end=0.75, option="inferno")+
    #scale_color_manual(values=c("red2", "darkblue")) +
  scale_linetype_manual(values=c("solid", "dashed", "dotted"))+
    scale_shape_manual(values=c(15, 16, 18))+
    scale_x_continuous(breaks = seq(10, 60, by = 10)) +
  labs(title="", x="Time (h)", y="Diameter (cm)", 
       color="Morph", pch="Peptone", linetype="Peptone") +
  theme(text = element_text(size = xTextSize-2),
        axis.text.x = element_text(angle=90)) +
  facet_wrap(~Community, scales="free_x")
p_nd_diam_lmlines_log_short
```

And the slopes
```{r}
temp1<-nd_diam_slope_A %>%
  filter(Dilution==0) %>% # just the regular stuff first
  dplyr::select(hours, slope, Morph, isolate, techrep, Peptone) %>%
  mutate(Community="A2")
temp2<-nd_diam_slope_F %>%
  dplyr::select(hours, slope, Morph, isolate, techrep, Peptone) %>%
  mutate(Community="F2")
nd_diam_slope<-rbind(temp1, temp2)
rm(temp1, temp2)
```


Plot out the slope data
```{r}
p_nd_diam_slope_lmlines_log_short<-nd_diam_slope %>%
  ggplot(aes(x=hours, y=slope, color=Morph, pch=factor(Peptone), linetype=factor(Peptone)))+
    geom_jitter(size=1, width=0.02) +
  geom_smooth(method="lm", formula = y ~ log(x), fill="NA", linewidth=0.7)+
  theme_light()+
  #scale_color_manual(values=c("red2", "darkblue")) +
  scale_colour_viridis_d(begin=0.4, end=0.75, option="inferno")+
  scale_linetype_manual(values=c("solid", "dashed", "dotted"))+
  scale_shape_manual(values=c(15, 16, 18))+
  scale_x_continuous(breaks = seq(20, 60, by = 10)) +
  labs(title="", x="Time (h)", y="Expansion (cm/h)", 
       color="Morph", linetype="Peptone", pch="Peptone") +
  theme(text = element_text(size = xTextSize-2),
        axis.text.x = element_text(angle=90)) +
  facet_wrap(~Community, scales="free_x")
p_nd_diam_slope_lmlines_log_short
```

And combine the motility data:
```{r}
p_nd_diam_lmlines_log_short  + 
  p_nd_diam_slope_lmlines_log_short +
  p_nd_diam_A_dilutions +
  p_nd_diam_slope_A_dilutions +
  plot_annotation(tag_levels = 'A') +
       plot_layout(guides = 'collect') 


#ggsave("Fig4_NutrientMotility.png", width=12, height=7, units="in", dpi=400)
ggsave("Fig4_NutrientMotility.tiff", width=240, height=150, units="mm")
# one column 80 mm width
```


~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
## Statistics for NGM 0.2-4X Data
### Set 1: Constant Inoculum
Statistics for panels A-B, comparing across morphs, communities, and peptone concentrations for a fixed inoculum density. For simplicity we transform the data so the fit is linear:
```{r}
nd_diam<-nd_diam %>%
  mutate(logtime=log(hours))
```

check
```{r}
nd_diam %>%
  ggplot(aes(x=logtime, y=Diameter, color=Morph, pch=factor(Peptone), linetype=factor(Peptone)))+
    geom_jitter(size=1, width=0.02) +
  geom_smooth(method="lm", formula = y ~ x, fill="NA", linewidth=0.7)+
  theme_light()+
  scale_colour_viridis_d(begin=0.4, end=0.75, option="inferno")+
    #scale_color_manual(values=c("red2", "darkblue")) +
  scale_linetype_manual(values=c("solid", "dashed", "dotted"))+
    scale_shape_manual(values=c(15, 16, 18))+
  labs(title="", x="Time (h)", y="Diameter (cm)", 
       color="Morph", pch="Peptone", linetype="Peptone") +
  theme(text = element_text(size = xTextSize),
        axis.text.x = element_text(angle=90)) +
  facet_wrap(~Community, scales="free_x")
```
Nested regressions for LRTs, on the raw data. 
```{r}
nd_diam$Peptone<-as.factor(nd_diam$Peptone) # first make these factors 
nd_diam$Morph<-as.factor(nd_diam$Morph) 
nd_diam$Pass<-as.factor(nd_diam$Pass)

# Nested models with the most terms
nd_diam_model_full <- lm(Diameter ~ logtime + Peptone + Morph + Community, data=nd_diam)
nd_diam_model_pooled<- lm(Diameter ~ logtime + Peptone + Morph, data=nd_diam)
```

LRTs. Do we need community ID as a factor?
```{r}
lrtest(nd_diam_model_full, nd_diam_model_pooled)
```
Apparently so. Make the reduced models accordingly:
```{r}
nd_diam_model_pept<-lm(Diameter ~ logtime + Peptone + Community, data=nd_diam)
nd_diam_model_morph<-lm(Diameter ~ logtime + Morph + Community, data=nd_diam)
nd_diam_model_minimal<-lm(Diameter ~ logtime + Community, data=nd_diam)
```

Next. Contribution of peptone
```{r}
lrtest(nd_diam_model_full, nd_diam_model_morph)
```

And of morph
```{r}
lrtest(nd_diam_model_full, nd_diam_model_pept)
```

Check the specific interactions within morphotype. Peptone in original morphs:
```{r}
nd_diam_model_ori_full<-nd_diam %>%
  filter(Morph == "Original") %>%
  lm(Diameter~logtime + Peptone + Community, data=.)
summary(nd_diam_model_ori_full)
```
Now for slopes. First manage data frame - establish factors and log time
```{r}
nd_diam_slope <- nd_diam_slope %>%
  mutate(logtime=log(hours))
nd_diam_slope$Peptone<-as.factor(nd_diam_slope$Peptone) # first make these factors 
nd_diam_slope$Morph<-as.factor(nd_diam_slope$Morph) #
```

Check
```{r}
nd_diam_slope %>%
  ggplot(aes(x=hours, y=slope, color=Morph, pch=Peptone, linetype=Peptone))+
    geom_jitter(size=1, width=0.02) +
  geom_smooth(method="lm", formula = y ~ x, fill="NA", linewidth=0.7)+
  theme_light()+
  #scale_color_manual(values=c("red2", "darkblue")) +
  scale_colour_viridis_d(begin=0.4, end=0.75, option="inferno")+
  scale_linetype_manual(values=c("solid", "dashed", "dotted"))+
  scale_shape_manual(values=c(15, 16, 18))+
  labs(title="", x="Time (h)", y="Expansion (cm/h)", 
       color="Morph", linetype="Peptone", pch="Peptone") +
  theme(text = element_text(size = xTextSize),
        axis.text.x = element_text(angle=90)) +
  facet_wrap(~Community, scales="free_x")
```

And regressions on slope. Full model:
```{r}
# Nested models
nd_diam_slope_model_full <- lm(slope ~ logtime + Peptone + Morph + Community, data=nd_diam_slope)
summary(nd_diam_slope_model_full)
```

First LRT. Do we need community ID as a factor?
```{r}
nd_diam_slope_model_pooled<- lm(slope ~ logtime + Peptone + Morph, data=nd_diam_slope)
lrtest(nd_diam_slope_model_full, nd_diam_slope_model_pooled)
```
Apparently so. Make the reduced models accordingly:
```{r}
nd_diam_slope_model_pept<-lm(slope ~ logtime + Peptone + Community, data=nd_diam_slope)
nd_diam_slope_model_morph<-lm(slope ~ logtime + Morph + Community, data=nd_diam_slope)
nd_diam_slope_model_minimal<-lm(slope ~ logtime + Community, data=nd_diam_slope)
```

Next. Contribution of peptone
```{r}
lrtest(nd_diam_slope_model_full, nd_diam_slope_model_morph)
```

And of morph
```{r}
lrtest(nd_diam_slope_model_full, nd_diam_slope_model_pept)
```

Check the specific interactions within morphotype. Full model for original morphs only:
```{r}
nd_diam_model_slope_ori_full<-nd_diam_slope %>%
  filter(Morph == "Original") %>%
  lm(slope~logtime + Peptone + Community, data=.)
summary(nd_diam_model_slope_ori_full)
```

And for alternate morphs:
```{r}
nd_diam_model_slope_alt_full<-nd_diam_slope %>%
  filter(Morph == "Alternate") %>%
  lm(slope~logtime + Peptone + Community, data=.)
summary(nd_diam_model_slope_alt_full)
```
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
### Set 2: Inoculum Dilutions
Now statistics for the diluted inoculum data. For simplicity we filter & transform the data so the fit is linear:
```{r}
nd_diam_A_dilutions<-nd_diam_A %>%
  filter(SourceWell %in% well_list) %>% # filter only the data we need
  mutate(logtime=log(hours))

nd_diam_A_slope_dilutions<-nd_diam_slope_A %>%
  filter(SourceWell %in% well_list) %>% # filter only the data we need
  mutate(logtime=log(hours))

nd_diam_A_dilutions$Peptone<-as.factor(nd_diam_A_dilutions$Peptone) # make these factors 
nd_diam_A_dilutions$Morph<-as.factor(nd_diam_A_dilutions$Morph) 
nd_diam_A_dilutions$Dilution<-as.factor(nd_diam_A_dilutions$Dilution)

nd_diam_A_slope_dilutions$Peptone<-as.factor(nd_diam_A_slope_dilutions$Peptone) # make these factors 
nd_diam_A_slope_dilutions$Morph<-as.factor(nd_diam_A_slope_dilutions$Morph) 
nd_diam_A_slope_dilutions$Dilution<-as.factor(nd_diam_A_slope_dilutions$Dilution)
```

Establish the highest-order model:
```{r}
nd_diam_A_dilutions_model_full <- lm(Diameter ~ logtime + Peptone + Morph + Dilution , data=nd_diam_A_dilutions)
summary(nd_diam_A_dilutions_model_full)
```

Reduced model for morph:
```{r}
nd_diam_A_dilutions_model_morphless <- lm(Diameter ~ logtime + Peptone + Dilution , data=nd_diam_A_dilutions)
lrtest(nd_diam_A_dilutions_model_full, nd_diam_A_dilutions_model_morphless)
```

ok now let's separate the morphs:
```{r}
nd_diam_A_dilutions_o<-nd_diam_A_dilutions %>%
  filter(Morph=="Original")
nd_diam_A_dilutions_a<-nd_diam_A_dilutions %>%
  filter(Morph=="Alternate")

nd_diam_A_slope_dilutions_o<- nd_diam_A_slope_dilutions %>%
  filter(Morph=="Original")
nd_diam_A_slope_dilutions_a<- nd_diam_A_slope_dilutions %>%
  filter(Morph=="Alternate")
```

Regressions for raw data, alternate morphs, inoculum dilutions. Want a mixed effects model here to check for effects on intercept:
```{r}
nd_diam_A_dilutions_a_lme<-lmer(Diameter ~ logtime + Peptone + (1|Dilution), data=nd_diam_A_dilutions_a, REML = F)
summary(nd_diam_A_dilutions_a_lme)
coef(nd_diam_A_dilutions_a_lme)
confint(nd_diam_A_dilutions_a_lme)
```
Do we need the peptone term at all?
```{r}
nd_diam_A_dilutions_a_lme3<-lmer(Diameter ~ logtime + (1|Dilution), data=nd_diam_A_dilutions_a, REML = F)
anova(nd_diam_A_dilutions_a_lme3, nd_diam_A_dilutions_a_lme)
```
Yes, we should keep it. The model keeps going singular when slopes are added as a mixed effect, so let's just do this one as LRT on the expansion rate data:
```{r}
temp<-lm(slope ~ Peptone + Dilution, data=nd_diam_A_slope_dilutions_a)
temp2<-lm(slope ~ Peptone, data=nd_diam_A_slope_dilutions_a)
lrtest(temp, temp2)
```

For original morphs now.
```{r}
nd_diam_A_dilutions_o_lme<-lmer(Diameter ~ logtime + Peptone + (1|Dilution), data=nd_diam_A_dilutions_o, REML = F)
summary(nd_diam_A_dilutions_o_lme)
coef(nd_diam_A_dilutions_o_lme)
confint(nd_diam_A_dilutions_o_lme)
```
There's a problem with the fits again - corr -1 indicates that the full slope-intercept models aren't fitting well.
```{r}
nd_diam_A_dilutions_o_lme3<-lmer(Diameter ~ logtime + (1|Dilution), data=nd_diam_A_dilutions_o, REML = F)
anova(nd_diam_A_dilutions_o_lme3, nd_diam_A_dilutions_o_lme)
#summary(nd_diam_A_dilutions_o_lme3)
```
The model keeps going singular when slopes are added as a mixed effect, so let's do LRT on the expansion rate data again:
```{r}
temp<-lm(slope ~ Peptone + Dilution, data=nd_diam_A_slope_dilutions_o)
temp2<-lm(slope ~ Peptone, data=nd_diam_A_slope_dilutions_o)
lrtest(temp, temp2)
```
Consider only the lowest dilution:
```{r}
nd_diam_A_slope_dilutions_o<-nd_diam_A_slope_dilutions_o %>%
  mutate(LowD = (Dilution=="-3"))
temp<-lm(slope ~ Peptone + LowD, data=nd_diam_A_slope_dilutions_o)
temp2<-lm(slope ~ Peptone, data=nd_diam_A_slope_dilutions_o)
lrtest(temp, temp2)
```

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
## Growth parameters and colony expansion
I also want to know what the relationship is between growth rate in the media and expansion rate on agar surfaces. 

### Community F pass 6
Read in the growth data for the F6 isolates (5-point rolling average):
```{r}
plate_nutrient <- read_excel("20230518_NV_CG_NGM_25C.xlsx", sheet = "raw")
```

And the labels:
```{r}
my_labels_nutrient<-read_excel("20230518_NV_CG_NGM_25C.xlsx", sheet="Labels", col_names=TRUE)
```

Check the contents briefly:
```{r}
head(plate_nutrient)
```

We'll use growthrates for our fits because I like it better. Convert to long format:
```{r}
plate_nutrient_long<-plate_nutrient %>%
  dplyr::select(-c("A2", "A3", "A4", "A5", "A6", "A7", "A8", "A9", "A10",
            "H2", "H3", "H4", "H5", "H6", "H7", "H8", "H9", "H10")) %>% # remove blanks
  pivot_longer(cols = B2:G10,
               names_to = "sample",
               values_to = "OD600")
glimpse(plate_nutrient_long)
```

Now we can add labels to these objects directly (since growthrates will let us make use of these labels if we want to)
```{r}
plate_nutrient_long<-label96well(plate_nutrient_long, my_labels_nutrient)
str(plate_nutrient_long)
```
Relabel morphs to be consistent with motility data:
```{r}
plate_nutrient_long <- plate_nutrient_long %>%
  mutate(Morph=recode(Morph, "a"="Alternate", "o"="Original")) # recode labels
```


Also need to add the new labels (isolate, technical replicate, and peptone multiplier):
```{r}
plate_nutrient_long <- plate_nutrient_long %>%
  add_column(Isolate=NA, 
             TechRep=NA,
             Peptone=NA)
  
  # Take well IDs
well_list1<-unique(my_labels_nutrient$Well)
  
attach(my_labels_nutrient)

for (i in seq_along(well_list1)){
    idx<-which(plate_nutrient_long$sample==well_list1[i]) # Find indices corresponding to each well
    plate_nutrient_long$Isolate[idx]<-Isolate[i]
    plate_nutrient_long$TechRep[idx]<-TechRep[i]
    plate_nutrient_long$Peptone[idx]<-Peptone[i]
    }
detach(my_labels_nutrient)

str(plate_nutrient_long)
```

We can plot out with ggplot:
```{r}
plate_nutrient_long %>%
  mutate(Peptone=factor(Peptone)) %>%
  mutate(Isolate=factor(Isolate)) %>%
  ggplot(aes(time, OD600)) + 
  geom_point(aes(color=Isolate)) + 
  facet_grid(Peptone ~ Morph)
```
Some bumps remaining, let's see how splines do. I want estimates for each well, so we'll tell growthrates to separate by well:
```{r}
# Single-well fit for illustration, as in the vignette
splitted.data.nutrientplate<-multisplit(plate_nutrient_long, "sample")
dat<-splitted.data.nutrientplate[[1]] # should be the first data set in alphanumeric order (well B10)
dat
```

```{r}
unique(dat$sample)
```

Fit splines to each well across the plate. 
```{r}
plate_nutrient_manyspline<-all_splines(OD600~time | sample, data=plate_nutrient_long, spar=0.95)
par(mfrow=c(7,8))
par(mar = c(2.5, 4, 2, 1))
plot(plate_nutrient_manyspline)
```

Now that we have these fits, let's extract the parameters. 
```{r}
# This gives us a list by well. For splines, we only need to keep max growth rate (mumax) estimates
coef(plate_nutrient_manyspline)
```

The coef() function returns a matrix, which is not what we want. Let's turn this into a data frame:
```{r}
plate_nutrient_manyspline_coef<-as_tibble(coef(plate_nutrient_manyspline), rownames=NA)
str(plate_nutrient_manyspline_coef)
```
Note that it did not bring well labels along for some reason (I think rownames=NA is supposed to retain these, not sure what's wrong); we'll have to retrieve those.
```{r}
# We can get the names from the coef() object
temp<-dimnames(coef(plate_nutrient_manyspline))
temp
temp[[1]]
```
Attach these well IDs to the coefficients:
```{r}
plate_nutrient_manyspline_coef$sample<-temp[[1]]
plate_nutrient_manyspline_coef
```

Now we have all our coefficients and their well labels. Pass these objects back through the labeler to get the meta-data associated with each well, then add the new labels.
```{r}
plate_nutrient_manyspline_coef<-label96well(plate_nutrient_manyspline_coef, my_labels_nutrient)

plate_nutrient_manyspline_coef <- plate_nutrient_manyspline_coef %>%
  add_column(Isolate=NA, 
             TechRep=NA,
             Peptone=NA)
  
  # Take well IDs
well_list1<-unique(my_labels_nutrient$Well)
  
attach(my_labels_nutrient)

for (i in seq_along(well_list1)){
    idx<-which(plate_nutrient_manyspline_coef$sample==well_list1[i]) # Find indices corresponding to each well
    plate_nutrient_manyspline_coef$Isolate[idx]<-Isolate[i]
    plate_nutrient_manyspline_coef$TechRep[idx]<-TechRep[i]
    plate_nutrient_manyspline_coef$Peptone[idx]<-Peptone[i]
    }
detach(my_labels_nutrient)

str(plate_nutrient_manyspline_coef)
```

Now we can plot out:
```{r}
pLVparams_spline_r_box_nutrient<-plate_nutrient_manyspline_coef %>%
  mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=Morph, y=mumax, color=Strain))+
  theme_classic()+
  geom_boxplot()+
  geom_jitter(width=0.1)+
  #geom_hline(yintercept = WTmedian_r_spline, color="black")+
  theme(legend.position = "none",
        text=element_text(size=xTextSize)) +
  labs(x="Morph", y="Max Growth Rate (r)") +
  facet_wrap(~Peptone, ncol=3)
pLVparams_spline_r_box_nutrient + stat_compare_means(label.y=0.19)
```
1X peptone is the only time we get a real growth difference between alternate and original morphs, interestingly.

Let's correlate. We have the colony expansion rate data from above:
```{r}
str(nd_diam_slope_F)
```

I guess we could try is to correlate the max expansion rate or max diameter and the max growth rate? As before, create a unique ID in the growth rate tibble:
```{r}
plate_nutrient_manyspline_coef_F <- plate_nutrient_manyspline_coef %>%
  mutate(Morph=recode(Morph, "a"="Alternate", "o"="Original")) %>% # recode label
  unite("ID", Morph:TechRep, remove=FALSE) # create an ID by merging morph, rep, and techrep
unique(plate_nutrient_manyspline_coef_F$ID)
```
Same as in the diameter slope data?
```{r}
nd_diam_slope_F <- nd_diam_slope_F %>%
  unite("ID", Morph:techrep, remove=FALSE) # create an ID by merging morph, rep, and techrep
unique(nd_diam_slope_F$ID)
```
And in the diameters?
```{r}
unique(nd_diam_F$ID)
```
No, have to fix that one. What are the data?
```{r}
view(nd_diam_F)
```

Make a new ID:
```{r}
nd_diam_F<-nd_diam_F %>%
  dplyr::select(-Pass) %>%
  unite("ID2", Morph:techrep, remove=FALSE)
unique(nd_diam_F$ID2)
```

ok, so far so good. Now get the max growth rate (at any time) for each ID and peptone level:
```{r}
my_ids<-unique(nd_diam_slope_F$ID)
my_levels<-unique(nd_diam_slope_F$Peptone)

# Create a tibble to hold the data

nd_diam_slope_rate_F<-tibble(ID=rep(my_ids, times=length(my_levels)),
                           Peptone=NA,
                           spreadrate=NA,
                           mumax=NA,
                           maxdiam=NA)
idx<-1
for (i in seq_along(my_ids)){
  for (j in seq_along(my_levels)){
    nd_diam_slope_rate_F$ID[idx]<-my_ids[i]
    nd_diam_slope_rate_F$Peptone[idx]<-my_levels[j]
    nd_diam_slope_rate_F$spreadrate[idx]<-max(nd_diam_slope_F$slope[nd_diam_slope_F$ID==my_ids[i] & 
                                                             nd_diam_slope_F$Peptone==my_levels[j]])
    nd_diam_slope_rate_F$mumax[idx]<-plate_nutrient_manyspline_coef_F$mumax[plate_nutrient_manyspline_coef_F$ID==my_ids[i] & 
                                                             plate_nutrient_manyspline_coef_F$Peptone==my_levels[j]]
    nd_diam_slope_rate_F$maxdiam[idx]<-max(nd_diam_F$Diameter[nd_diam_F$ID2==my_ids[i] & 
                                                             nd_diam_F$Peptone==my_levels[j]])
    idx<-idx+1
  }
}

```

Check the object:
```{r}
str(nd_diam_slope_rate_F)
```
Separate out morphs:
```{r}
nd_diam_slope_rate_F$Morph<-substr(nd_diam_slope_rate_F$ID, 1, 1)

nd_diam_slope_rate_F<- nd_diam_slope_rate_F %>%
    mutate(Morph=recode(Morph, "A"="Alternate", "O"="Original")) # recode labels
```


Now we can plot:
```{r}
p_diam_rate_F<-nd_diam_slope_rate_F %>%
  mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=mumax, y=maxdiam, color=Peptone)) +
  geom_jitter(size=2, width=0.02)+
  theme_light()+
  theme(text=element_text(size=xTextSize)) +
  labs(x="Max Growth Rate (r)", y="Max Diameter") +
  facet_wrap(~Morph, ncol=2)
p_diam_rate_F
```

```{r}
p_spreadrate_rate_F<-nd_diam_slope_rate_F %>%
   mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=mumax, y=spreadrate, color=Peptone)) +
  geom_jitter(size=2, width=0.02)+
  theme_light()+
  theme(text=element_text(size=xTextSize)) +
  labs(x="Max Growth Rate (r)", y="Max Spread Rate") +
  facet_wrap(~Morph, ncol=2)
p_spreadrate_rate_F
```

Linear fits to these data, or first:
```{r}
nd_rate_temp_F<-nd_diam_slope_rate_F %>%
  filter(Morph=="Original")
lm_nd_diam_slope_rate_ORI_F<-lm(maxdiam~mumax, data=nd_rate_temp_F)
summary(lm_nd_diam_slope_rate_ORI_F)

nd_rate_temp_F<-nd_diam_slope_rate_F %>%
  filter(Morph=="Original")
lm_nd_diam_slope_rate_ORI_F<-lm(spreadrate~mumax, data=nd_rate_temp_F)
summary(lm_nd_diam_slope_rate_ORI_F)
```

And alternate morphs:
```{r}
nd_rate_temp_F<-nd_diam_slope_rate_F %>%
  filter(Morph=="Alternate")
lm_nd_diam_slope_rate_ALT_F<-lm(maxdiam~mumax, data=nd_rate_temp_F)
summary(lm_nd_diam_slope_rate_ALT_F)

nd_rate_temp_F<-nd_diam_slope_rate_F %>%
  filter(Morph=="Alternate")
lm_nd_diam_slope_rate_ALT_F<-lm(spreadrate~mumax, data=nd_rate_temp_F)
summary(lm_nd_diam_slope_rate_ALT_F)
```


So, no. How about carrying capacity? Let's fit the logistic:
```{r}
p     <- c(y0 = 0.01, mumax = 0.1, K = 0.5)
lower <- c(y0 = 1e-6, mumax = 0,   K = 0)
upper <- c(y0 = 0.05, mumax = 5,   K = 1.5)

many_logistic_nutrient_F <- all_growthmodels(OD600 ~ grow_logistic(time, parms) | sample, data= plate_nutrient_long, 
                                           p = p, lower = lower, upper = upper, transform = "log")
par(mfrow=c(7,8))
par(mar = c(2.5, 4, 2, 1))
plot(many_logistic_nutrient_F)
```
Coefficients:
```{r}
coef(many_logistic_nutrient_F)
```


Add these to the object:
```{r}
# Create a tibble
many_logistic_nutrient_coef_F<-as_tibble(coef(many_logistic_nutrient_F), rownames=NA)
#str(many_logistic_nutrient_coef)

# Add the well IDs
# We can get the names from the coef() object
temp<-dimnames(coef(many_logistic_nutrient_F))
#temp
temp[[1]]
many_logistic_nutrient_coef_F$sample<-temp[[1]]
str(many_logistic_nutrient_coef_F)
```

Now we have all our coefficients and their well labels. Pass these objects back through the labeler to get the meta-data associated with each well, then add the new labels.
```{r}
many_logistic_nutrient_coef_F<-label96well(many_logistic_nutrient_coef_F, my_labels_nutrient)

many_logistic_nutrient_coef_F <- many_logistic_nutrient_coef_F %>%
  add_column(Isolate=NA, 
             TechRep=NA,
             Peptone=NA)
  
  # Take well IDs
well_list1<-unique(my_labels_nutrient$Well)
  
attach(my_labels_nutrient)

for (i in seq_along(well_list1)){
    idx<-which(many_logistic_nutrient_coef_F$sample==well_list1[i]) # Find indices corresponding to each well
    many_logistic_nutrient_coef_F$Isolate[idx]<-Isolate[i]
    many_logistic_nutrient_coef_F$TechRep[idx]<-TechRep[i]
    many_logistic_nutrient_coef_F$Peptone[idx]<-Peptone[i]
    }
detach(my_labels_nutrient)

str(many_logistic_nutrient_coef_F)
```

Relabel:
```{r}
many_logistic_nutrient_coef_F<- many_logistic_nutrient_coef_F %>%
    mutate(Morph=recode(Morph, "a"="Alternate", "o"="Original")) # recode labels
```


Now we can plot out:
```{r}
pmanyparams_K_box_nutrient_F<-many_logistic_nutrient_coef_F %>%
  mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=Morph, y=K, color=Strain))+
  theme_classic()+
  geom_boxplot()+
  geom_jitter(width=0.1)+
  #geom_hline(yintercept = WTmedian_r_spline, color="black")+
  theme(legend.position = "none",
        text=element_text(size=xTextSize)) +
  labs(x="Morph", y="Carrying Capacity (OD600)") +
  facet_wrap(~Peptone, ncol=3)
pmanyparams_K_box_nutrient_F + stat_compare_means()
```

Add these to the rest of the parameter data. As before, create a unique ID in the growth rate tibble:
```{r}
many_logistic_nutrient_coef_F <- many_logistic_nutrient_coef_F %>%
  unite("ID", Morph:TechRep, remove=FALSE) # create an ID by merging morph, rep, and techrep
unique(many_logistic_nutrient_coef_F$ID)
```

Are these in the same order or...
```{r}
nd_diam_slope_rate_F$ID
many_logistic_nutrient_coef_F$ID
```
Nope, have to find.
```{r}
nd_diam_slope_rate_F$K<-NA

my_len<-dim(nd_diam_slope_rate_F)[1]
for (i in seq_len(my_len)){
  my_id<-nd_diam_slope_rate_F$ID[i]
  my_level<-nd_diam_slope_rate_F$Peptone[i]
  nd_diam_slope_rate_F$K[i]<-many_logistic_nutrient_coef_F$K[many_logistic_nutrient_coef_F$ID==my_id & 
                                     many_logistic_nutrient_coef_F$Peptone==my_level]
}
str(nd_diam_slope_rate_F)
```

And plot K vs diameter:
```{r}
p_diam_K_F<-nd_diam_slope_rate_F %>%
  mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=K, y=maxdiam, color=Peptone)) +
  geom_jitter(size=2, width=0.02)+
  #geom_smooth(method="lm", fill="NA")+
  theme_light()+
  theme(text=element_text(size=xTextSize)) +
  labs(x="K (OD600)", y="Max Diameter") +
  facet_wrap(~Morph, ncol=2)
p_diam_K_F
```
Fit linear models myself (geom_smooth wants to fit each peptone group by itself)
```{r}
nd_rate_temp_F<-nd_diam_slope_rate_F %>%
  filter(Morph=="Original")
lm_nd_diam_slope_rate_ORI_F<-lm(maxdiam~K, data=nd_rate_temp_F)
summary(lm_nd_diam_slope_rate_ORI_F)
```
and for alt morphs
```{r}
nd_rate_temp_F<-nd_diam_slope_rate_F %>%
  filter(Morph=="Alternate")
lm_nd_diam_slope_rate_ALT_F<-lm(maxdiam~K, data=nd_rate_temp_F)
summary(lm_nd_diam_slope_rate_ALT_F)
```

And vs spreading rate:
```{r}
p_spreadrate_K_F<-nd_diam_slope_rate_F %>%
   mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=K, y=spreadrate, color=Peptone)) +
  geom_jitter(size=2, width=0.02)+
  theme_light()+
  theme(text=element_text(size=xTextSize)) +
  labs(x="K (OD600)", y="Max Spread Rate") +
  facet_wrap(~Morph, ncol=2)
p_spreadrate_K_F
```

And linear fits, first ORI:
```{r}
nd_rate_temp_F<-nd_diam_slope_rate_F %>%
  filter(Morph=="Original")
lm_nd_diam_slope_rate_ORI<-lm(spreadrate~K, data=nd_rate_temp_F)
summary(lm_nd_diam_slope_rate_ORI_F)
```

Then alt:
```{r}
nd_rate_temp_F<-nd_diam_slope_rate_F %>%
  filter(Morph=="Alternate")
lm_nd_diam_slope_rate_ALT<-lm(spreadrate~K, data=nd_rate_temp_F)
summary(lm_nd_diam_slope_rate_ALT_F)
```


#### Community A pass 6
Read in the growth data for the F6 isolates (5-point rolling average):
```{r}
plate_nutrient_A <- read_excel("20230724_NV_CG_NGM_25C.xlsx", sheet = "raw")
```

And the labels:
```{r}
my_labels_nutrient_A<-read_excel("20230724_NV_CG_NGM_25C.xlsx", sheet="Labels", col_names=TRUE)
```

Check the contents briefly:
```{r}
head(plate_nutrient_A)
```

We'll use growthrates for our fits because I like it better. Convert to long format:
```{r}
plate_nutrient_long_A<-plate_nutrient_A %>%
  dplyr::select(-c("A2", "A3", "A4", "A5", "A6", "A7", "A8", "A9", "A10",
            "H2", "H3", "H4", "H5", "H6", "H7", "H8", "H9", "H10")) %>% # remove blanks
  pivot_longer(cols = B2:G11,
               names_to = "sample",
               values_to = "OD600")
glimpse(plate_nutrient_long_A)
```

Now we can add labels to these objects directly (since growthrates will let us make use of these labels if we want to)
```{r}
plate_nutrient_long_A<-label96well(plate_nutrient_long_A, my_labels_nutrient_A)
str(plate_nutrient_long_A)
```

Also need to add the new labels (isolate, technical replicate, and peptone multiplier):
```{r}
plate_nutrient_long_A <- plate_nutrient_long_A %>%
  add_column(Isolate=NA, 
             TechRep=NA,
             Peptone=NA)
  
  # Take well IDs
well_list1<-unique(my_labels_nutrient_A$Well)
  
attach(my_labels_nutrient_A)

for (i in seq_along(well_list1)){
    idx<-which(plate_nutrient_long_A$sample==well_list1[i]) # Find indices corresponding to each well
    plate_nutrient_long_A$Isolate[idx]<-Isolate[i]
    plate_nutrient_long_A$TechRep[idx]<-TechRep[i]
    plate_nutrient_long_A$Peptone[idx]<-Peptone[i]
    }
detach(my_labels_nutrient_A)

str(plate_nutrient_long_A)
```

We can plot out with ggplot:
```{r}
plate_nutrient_long_A %>%
  mutate(Peptone=factor(Peptone)) %>%
  mutate(Isolate=factor(Isolate)) %>%
  ggplot(aes(time, OD600)) + 
  geom_point(aes(color=Isolate)) + 
  facet_grid(Peptone ~ Morph)
```

Fit splines to each well. 
```{r}
plate_nutrient_manyspline_A<-all_splines(OD600~time | sample, data=plate_nutrient_long_A, spar=0.95)
par(mfrow=c(8,8))
par(mar = c(2.5, 2, 1, 1))
plot(plate_nutrient_manyspline_A)
```

Now that we have these fits, let's extract the parameters. 
```{r}
# This gives us a list by well. For splines, we only need to keep max growth rate (mumax) estimates
coef(plate_nutrient_manyspline_A)
```

The coef() function returns a matrix, which is not what we want. Let's turn this into a data frame:
```{r}
plate_nutrient_manyspline_coef_A<-as_tibble(coef(plate_nutrient_manyspline_A), rownames=NA)
str(plate_nutrient_manyspline_coef_A)
```

Retrieve well labels:
```{r}
# We can get the names from the coef() object
temp<-dimnames(coef(plate_nutrient_manyspline_A))
temp
temp[[1]]
```
Attach these well IDs to the coefficients:
```{r}
plate_nutrient_manyspline_coef_A$sample<-temp[[1]]
plate_nutrient_manyspline_coef_A
```

Now we have all our coefficients and their well labels. Pass these objects back through the labeler to get the meta-data associated with each well, then add the new labels.
```{r}
plate_nutrient_manyspline_coef_A<-label96well(plate_nutrient_manyspline_coef_A, my_labels_nutrient_A)

plate_nutrient_manyspline_coef_A <- plate_nutrient_manyspline_coef_A %>%
  add_column(Isolate=NA, 
             TechRep=NA,
             Peptone=NA)
  
  # Take well IDs
well_list1<-unique(my_labels_nutrient_A$Well)
  
attach(my_labels_nutrient_A)

for (i in seq_along(well_list1)){
    idx<-which(plate_nutrient_manyspline_coef_A$sample==well_list1[i]) # Find indices corresponding to each well
    plate_nutrient_manyspline_coef_A$Isolate[idx]<-Isolate[i]
    plate_nutrient_manyspline_coef_A$TechRep[idx]<-TechRep[i]
    plate_nutrient_manyspline_coef_A$Peptone[idx]<-Peptone[i]
    }
detach(my_labels_nutrient_A)

str(plate_nutrient_manyspline_coef_A)
```

Now we can plot out:
```{r}
pLVparams_spline_r_box_nutrient_A<-plate_nutrient_manyspline_coef_A %>%
#  filter(Pass!=0) %>% # leave out the ancestor
  mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=Morph, y=mumax, color=Strain))+
  theme_classic()+
  geom_boxplot()+
  geom_jitter(width=0.1)+
  #geom_hline(yintercept = WTmedian_r_spline, color="black")+
  theme(legend.position = "none",
        text=element_text(size=xTextSize)) +
  labs(x="Morph", y="Max Growth Rate (r)") +
  facet_wrap(~Peptone, ncol=3)
pLVparams_spline_r_box_nutrient_A + stat_compare_means(label.y=0.19)
```
For these isolates we get a difference in 0.2X and in 1X.

Let's correlate. We have the colony expansion rate data from above:
```{r}
str(nd_diam_slope_A)
```

Correlate the max expansion rate or max diameter and the max growth rate? As before, create a unique ID in the growth rate tibble. We don't have enough ancestral data for growth, so we'll remove the single replicate.
```{r}
plate_nutrient_manyspline_coef_A_6 <- plate_nutrient_manyspline_coef_A %>%
  dplyr::filter(Morph!="Ancestor") %>%
  unite("ID", Morph:TechRep, remove=FALSE) # create an ID by merging morph, rep, and techrep
unique(plate_nutrient_manyspline_coef_A_6$ID)
```

Same as in the diameter slope data?
```{r}
nd_diam_slope_A <- nd_diam_slope_A %>%
  unite("ID", Morph:techrep, remove=FALSE) # create an ID by merging morph, rep, and techrep
unique(nd_diam_slope_A$ID)
```
And in the diameters?
```{r}
unique(nd_diam_A$ID)
```
No, have to fix that one. What are the data?
```{r}
view(nd_diam_A)
```

Make a new ID:
```{r}
nd_diam_A<-nd_diam_A %>%
  dplyr::select(-Pass) %>%
  unite("ID2", Morph:techrep, remove=FALSE)
unique(nd_diam_A$ID2)
```

ok, so far so good. Now get the max growth rate (at any time) for each ID and peptone level:
```{r}
my_ids<-unique(nd_diam_slope_A$ID)
my_levels<-unique(nd_diam_slope_A$Peptone)

# Create a tibble to hold the data

nd_diam_slope_rate_A<-tibble(ID=rep(my_ids, times=length(my_levels)),
                           Peptone=NA,
                           spreadrate=NA,
                           mumax=NA,
                           maxdiam=NA)
idx<-1
for (i in seq_along(my_ids)){
  for (j in seq_along(my_levels)){
    nd_diam_slope_rate_A$ID[idx]<-my_ids[i]
    nd_diam_slope_rate_A$Peptone[idx]<-my_levels[j]
    nd_diam_slope_rate_A$spreadrate[idx]<-max(nd_diam_slope_A$slope[nd_diam_slope_A$ID==my_ids[i] & 
                                                             nd_diam_slope_A$Peptone==my_levels[j]])
    nd_diam_slope_rate_A$maxdiam[idx]<-max(nd_diam_A$Diameter[nd_diam_A$ID2==my_ids[i] & 
                                                             nd_diam_A$Peptone==my_levels[j]])
#    if(sum(plate_nutrient_manyspline_coef_A$ID==my_ids[i]) >0){    

      nd_diam_slope_rate_A$mumax[idx]<-
      plate_nutrient_manyspline_coef_A_6$mumax[plate_nutrient_manyspline_coef_A_6$ID==my_ids[i] &                                                        plate_nutrient_manyspline_coef_A_6$Peptone==my_levels[j]]
 #     }
    idx<-idx+1
  }
}

```

Check the object:
```{r}
str(nd_diam_slope_rate_A)
View(nd_diam_slope_rate_A)
```
Separate out morphs:
```{r}
nd_diam_slope_rate_A$Morph<-substr(nd_diam_slope_rate_A$ID, 1, 1)
nd_diam_slope_rate_A<-nd_diam_slope_rate_A %>%
   mutate(Morph=recode(Morph, "A"="Alternate", "O"="Original"))
```

Now we can plot:
```{r}
p_diam_rate_A<-nd_diam_slope_rate_A %>%
  mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=mumax, y=maxdiam, color=Peptone)) +
  geom_jitter(size=2, width=0.02)+
  theme_light()+
  theme(text=element_text(size=xTextSize)) +
  labs(x="Max Growth Rate (r)", y="Max Diameter") +
  facet_wrap(~Morph, ncol=2)
p_diam_rate_A
```

```{r}
p_spreadrate_rate_A<-nd_diam_slope_rate_A %>%
   mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=mumax, y=spreadrate, color=Peptone)) +
  geom_jitter(size=2, width=0.02)+
  theme_light()+
  theme(text=element_text(size=xTextSize)) +
  labs(x="Max Growth Rate (r)", y="Max Spread Rate") +
  facet_wrap(~Morph, ncol=2)
p_spreadrate_rate_A
```
Linear fits to these data, or first:
```{r}
nd_rate_temp_A<-nd_diam_slope_rate_A %>%
  filter(Morph=="Original")
lm_nd_diam_slope_rate_ORI_A<-lm(maxdiam~mumax, data=nd_rate_temp_A)
summary(lm_nd_diam_slope_rate_ORI_A)

nd_rate_temp_A<-nd_diam_slope_rate_A %>%
  filter(Morph=="Original")
lm_nd_diam_slope_rate_ORI_A<-lm(spreadrate~mumax, data=nd_rate_temp_A)
summary(lm_nd_diam_slope_rate_ORI_A)
```

And alternate morphs:
```{r}
nd_rate_temp_A<-nd_diam_slope_rate_A %>%
  filter(Morph=="Alternate")
lm_nd_diam_slope_rate_ALT_A<-lm(maxdiam~mumax, data=nd_rate_temp_A)
summary(lm_nd_diam_slope_rate_ALT_A)

nd_rate_temp_A<-nd_diam_slope_rate_A %>%
  filter(Morph=="Alternate")
lm_nd_diam_slope_rate_ALT_A<-lm(spreadrate~mumax, data=nd_rate_temp_A)
summary(lm_nd_diam_slope_rate_ALT_A)
```


So, no. How about carrying capacity? Let's fit the logistic:
```{r}
p     <- c(y0 = 0.01, mumax = 0.1, K = 0.5)
lower <- c(y0 = 1e-6, mumax = 0,   K = 0)
upper <- c(y0 = 0.05, mumax = 5,   K = 1.5)

many_logistic_nutrient_A <- all_growthmodels(OD600 ~ grow_logistic(time, parms) | sample, data= plate_nutrient_long_A, 
                                           p = p, lower = lower, upper = upper, transform = "log")
par(mfrow=c(7,8))
par(mar = c(2.5, 4, 2, 1))
plot(many_logistic_nutrient_A)
```
Coefficients:
```{r}
coef(many_logistic_nutrient_A)
```


Add these to the object:
```{r}
# Create a tibble
many_logistic_nutrient_coef_A<-as_tibble(coef(many_logistic_nutrient_A), rownames=NA)
#str(many_logistic_nutrient_coef)

# Add the well IDs
# We can get the names from the coef() object
temp<-dimnames(coef(many_logistic_nutrient_A))
#temp
temp[[1]]
many_logistic_nutrient_coef_A$sample<-temp[[1]]
str(many_logistic_nutrient_coef_A)
```
Now we have all our coefficients and their well labels. Pass these objects back through the labeler to get the meta-data associated with each well, then add the new labels.
```{r}
many_logistic_nutrient_coef_A<-label96well(many_logistic_nutrient_coef_A, my_labels_nutrient_A)

many_logistic_nutrient_coef_A <- many_logistic_nutrient_coef_A %>%
  add_column(Isolate=NA, 
             TechRep=NA,
             Peptone=NA)
  
  # Take well IDs
well_list1<-unique(my_labels_nutrient_A$Well)
  
attach(my_labels_nutrient_A)

for (i in seq_along(well_list1)){
    idx<-which(many_logistic_nutrient_coef_A$sample==well_list1[i]) # Find indices corresponding to each well
    many_logistic_nutrient_coef_A$Isolate[idx]<-Isolate[i]
    many_logistic_nutrient_coef_A$TechRep[idx]<-TechRep[i]
    many_logistic_nutrient_coef_A$Peptone[idx]<-Peptone[i]
    }
detach(my_labels_nutrient_A)

str(many_logistic_nutrient_coef_A)
```
Now we can plot out:
```{r}
pmanyparams_K_box_nutrient_A<-many_logistic_nutrient_coef_A %>%
  mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=Morph, y=K, color=Strain))+
  theme_classic()+
  geom_boxplot()+
  geom_jitter(width=0.1)+
  #geom_hline(yintercept = WTmedian_r_spline, color="black")+
  theme(legend.position = "none",
        text=element_text(size=xTextSize)) +
  labs(x="Morph", y="Carrying Capacity (OD600)") +
  facet_wrap(~Peptone, ncol=3)
pmanyparams_K_box_nutrient_A + stat_compare_means()
```

Add these to the rest of the parameter data. As before, create a unique ID in the growth rate tibble:
```{r}
many_logistic_nutrient_coef_A <- many_logistic_nutrient_coef_A %>%
  dplyr::filter(Morph!="Ancestor") %>%
  unite("ID", Morph:TechRep, remove=FALSE) # create an ID by merging morph, rep, and techrep
unique(many_logistic_nutrient_coef_A$ID)
```
Are these in the same order or...
```{r}
nd_diam_slope_rate_A$ID
many_logistic_nutrient_coef_A$ID
```
Nope, have to find.
```{r}
nd_diam_slope_rate_A$K<-NA

my_len<-dim(nd_diam_slope_rate_A)[1]
for (i in seq_len(my_len)){
  my_id<-nd_diam_slope_rate_A$ID[i]
  my_level<-nd_diam_slope_rate_A$Peptone[i]
  nd_diam_slope_rate_A$K[i]<-many_logistic_nutrient_coef_A$K[many_logistic_nutrient_coef_A$ID==my_id & 
                                                             many_logistic_nutrient_coef_A$Peptone==my_level]
}
str(nd_diam_slope_rate_A)
```

And plot K vs diameter:
```{r}
p_diam_K_A<-nd_diam_slope_rate_A %>%
  mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=K, y=maxdiam, color=Peptone)) +
  geom_jitter(size=2, width=0.02)+
  #geom_smooth(method="lm", fill="NA")+
  theme_light()+
  theme(text=element_text(size=xTextSize)) +
  labs(x="K (OD600)", y="Max Diameter") +
  facet_wrap(~Morph, ncol=2)
p_diam_K_A
```
Fit linear models myself (geom_smooth wants to fit each peptone group by itself)
```{r}
nd_rate_temp_A<-nd_diam_slope_rate_A %>%
  filter(Morph=="Original")
lm_nd_diam_slope_rate_ORI_A<-lm(maxdiam~K, data=nd_rate_temp_A)
summary(lm_nd_diam_slope_rate_ORI_A)
```
and for alt morphs
```{r}
nd_rate_temp_A<-nd_diam_slope_rate_A %>%
  filter(Morph=="Alternate")
lm_nd_diam_slope_rate_ALT_A<-lm(maxdiam~K, data=nd_rate_temp_A)
summary(lm_nd_diam_slope_rate_ALT_A)
```


And vs spreading rate:
```{r}
p_spreadrate_K_A<-nd_diam_slope_rate_A %>%
   mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=K, y=spreadrate, color=Peptone)) +
  geom_jitter(size=2, width=0.02)+
  theme_light()+
  theme(text=element_text(size=xTextSize)) +
  labs(x="K (OD600)", y="Max Spread Rate") +
  facet_wrap(~Morph, ncol=2)
p_spreadrate_K_A
```
And linear fits, first ORI:
```{r}
nd_rate_temp_A<-nd_diam_slope_rate_A %>%
  filter(Morph=="Original")
lm_nd_diam_slope_rate_ORI_A<-lm(spreadrate~K, data=nd_rate_temp_A)
summary(lm_nd_diam_slope_rate_ORI_A)
```

Then alt:
```{r}
nd_rate_temp_A<-nd_diam_slope_rate_A %>%
  filter(Morph=="Alternate")
lm_nd_diam_slope_rate_ALT_A<-lm(spreadrate~K, data=nd_rate_temp_A)
summary(lm_nd_diam_slope_rate_ALT_A)
```

#### Growth vs Spread Pooled
Put the parameter estimates together.
```{r}
nd_diam_slope_rate_A$Community<-"A"
nd_diam_slope_rate_F$Community<-"F"
nd_diam_slope_rate<-rbind(nd_diam_slope_rate_A, nd_diam_slope_rate_F)
```

Composite figures. Parameter estimates:
```{r}
pLVparams_spline_r_box_nutrient<-nd_diam_slope_rate %>%
  mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=Morph, y=mumax, color=Morph))+
  theme_classic()+
  geom_boxplot()+
  geom_jitter(width=0.1)+
  theme(legend.position = "none",
        text=element_text(size=xTextSize)) +
  labs(x="Morph", y="Max Growth Rate (r)") +
  facet_grid(Peptone~Community, scales="free_y")
pLVparams_spline_r_box_nutrient + stat_compare_means(label.y.npc = c(0.28, 0.9, 1.1))
```
And for K:
```{r}
pLVparams_spline_K_box_nutrient<-nd_diam_slope_rate %>%
  mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=Morph, y=K, color=Morph))+
  theme_classic()+
  geom_boxplot()+
  geom_jitter(width=0.1)+
  theme(legend.position = "none",
        text=element_text(size=xTextSize)) +
  labs(x="Morph", y="Capacity (K)") +
  facet_grid(Peptone~Community, scales="free_y")
pLVparams_spline_K_box_nutrient + stat_compare_means(label.y.npc = c(0.28, 0.6, 1.1))
#pLVparams_spline_K_box_nutrient + stat_compare_means(label.y=0.1)
```
Finally the trends:
```{r}
p_diam_K<-nd_diam_slope_rate %>%
  mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=K, y=maxdiam, color=Peptone)) +
  geom_jitter(size=2, width=0.02)+
  #geom_smooth(method="lm", fill="NA")+
  theme_light()+
  theme(text=element_text(size=xTextSize)) +
  labs(x="K (OD600)", y="Max Diameter") +
  facet_grid(Community~Morph)
p_diam_K
```
K vs spread rate:
```{r}
p_spread_K<-nd_diam_slope_rate %>%
  mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=K, y=spreadrate, color=Peptone)) +
  geom_jitter(size=2, width=0.02)+
  theme_light()+
  theme(text=element_text(size=xTextSize)) +
  labs(x="K (OD600)", y="Spreading Rate") +
  facet_grid(Community~Morph)
p_spread_K
```


and in mumax:
```{r}
p_diam_mumax<-nd_diam_slope_rate %>%
  mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=mumax, y=maxdiam, color=Peptone)) +
  geom_jitter(size=2, width=0.02)+
  theme_light()+
  theme(text=element_text(size=xTextSize)) +
  labs(x="Max Growth Rate (r)", y="Max Diameter") +
  facet_grid(Community~Morph)
p_diam_mumax
```

```{r}
p_spread_mumax<-nd_diam_slope_rate %>%
  mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=mumax, y=spreadrate, color=Peptone)) +
  geom_jitter(size=2, width=0.02)+
  theme_light()+
  theme(text=element_text(size=xTextSize)) +
  labs(x="Max Growth Rate (r)", y="Spreading Rate") +
  facet_grid(Community~Morph)
p_spread_mumax
```


```{r}
pLVparams_spline_K_box_nutrient + stat_compare_means(label.y.npc = c(0.28, 0.65, 1.1, 0.29, 0.65, 1.1), 
                                                     label.x.npc = "centre",
                                                     aes(label = paste0("p = ", after_stat(p.format))))
```


Combine plots:
```{r}
p1<-plot_grid(pLVparams_spline_r_box_nutrient + stat_compare_means(label.y.npc = c(0.28, 0.9, 1.1),
                                                     label.x.npc = "centre",
                                                     aes(label = paste0("p = ", after_stat(p.format)))), 
          p_diam_mumax, p_spread_mumax,
          ncol=1, labels="AUTO", rel_heights = c(1, 0.7, 0.7))
#p1
p2<-plot_grid(pLVparams_spline_K_box_nutrient + stat_compare_means(label.y.npc = c(0.28, 0.65, 1.1, 0.29, 0.65, 1.1), 
                                                     label.x.npc = "centre",
                                                     aes(label = paste0("p = ", after_stat(p.format)))), 
          p_diam_K, p_spread_K,
          ncol=1, labels=c("D", "E", "F"), rel_heights=c(1, 0.7, 0.7))
p1|p2
ggsave("FigS9_pGrowthParams_Motility.png", width=14, height=10, units="in", dpi=300)
```


