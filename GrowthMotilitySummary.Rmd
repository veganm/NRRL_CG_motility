---
title: "Growth Motility Summary"
output: pdf_document
---

 This notebook is a summary across existing data sets for surface motility. First, load the necessary:
```{r}
pacman::p_load(readxl, tidyverse, cowplot, RColorBrewer, growthrates, growthcurver, ggpubr)
```
 
Define global:
```{r}
xTextSize<-14
```

Since I will need to add growth rate data, here is a function for adding labels:
```{r}
label96well<-function(mydata, mylabels){
  # This function will take a data file where a column named "sample" contains well IDs
  # and a set of labels corresponding to those wells
  # which must have columns Strain, Community, Rep, Pass, and Morph
  # and move those labels to the "mydata" object according to well ID
  
  # Add blank columns to mydata
  mydata <- mydata %>%
  add_column(Strain=NA, 
             Community=NA,
             Rep=NA,
             Pass=NA,
             Morph=NA)
  
  # Take well IDs
  well_list1<-unique(mylabels$Well)
  
  attach(mylabels)

  for (i in seq_along(well_list1)){
    idx<-which(mydata$sample==well_list1[i]) # Find indices corresponding to each well
    mydata$Strain[idx]<-Strain[i]
    mydata$Community[idx]<-Community[i]
    mydata$Rep[idx]<-Rep[i]
    mydata$Pass[idx]<-Pass[i]
    mydata$Morph[idx]<-Morph[i]
    }
  detach(mylabels) # We're done with this, let it go
  
  return(mydata)
}
```

# Growth Curves
## Growth in 1X NGM
Load in the OD600 data from the Excel files:
```{r}
plate1 <- read_excel("20230217-MD-NGM-p6-p10.xlsx", sheet = "raw")
plate2 <- read_excel("20230218-MD-NGM-p6-p10.xlsx", sheet = "raw")
plate3 <- read_excel("20230219-MD-NGM-p6-p10.xlsx", sheet = "raw")
```

Check the contents briefly:
```{r}
head(plate3)
```

First, let's get rid of any sample-containing wells where there was no growth. Start by getting OD600 range by well:
```{r}
plate1_range<-sapply(plate1, function(plate1) range(plate1))
plate1_range
```

Note that blanks in this plate and plate 3 are [E2, F2, G2, H2] and negative controls [E3, F3, G3, H3]; plate 2 only has the blank wells. 
Do the same for each of the other plates:
```{r}
plate2_range<-sapply(plate2, function(plate2) range(plate2))
plate2_range
```

```{r}
plate3_range<-sapply(plate3, function(plate3) range(plate3))
plate3_range
```

Since the blanks are changing a bit over time, we might want to use the "blank" method for correction. Here, growthcurver will take the ODs from a single column named "blank" and use that to correct the rest of the plate. In each plate, we will therefore name one "blank column (created as the average of the actual blanks):
```{r}
plate1_mod <- mutate(plate1, blank=rowMeans(select(plate1, c(E2, F2, G2, H2))))
View(plate1_mod)
plate1_mod$blank
```
Same for other plates:
```{r}
plate2_mod <- mutate(plate2, blank=rowMeans(select(plate2, c(E2, F2, G2, H2))))
plate3_mod <- mutate(plate3, blank=rowMeans(select(plate3, c(E2, F2, G2, H2))))
```

Let's see what the blanks look like:
```{r}
par(mfrow=c(1,3))
p1_blank<-plot(plate1_mod$time, plate1_mod$blank)
p2_blank<-plot(plate2_mod$time, plate2_mod$blank)
p3_blank<-plot(plate3_mod$time, plate3_mod$blank)
```

Now we can remove the individual columns with no growth:
```{r}
# Find the names of columns where growth is measurable; append "blank" column name
keepNames1<-c(names(which((plate1_range[1,]*2) < plate1_range[2,])), "blank")
keepNames2<-c(names(which((plate2_range[1,]*2) < plate2_range[2,])), "blank")
keepNames3<-c(names(which((plate3_range[1,]*2) < plate3_range[2,])), "blank")

# Select these columns and the blank from the new tibbles
plate1_mod<-select(plate1_mod, all_of(keepNames1))
plate2_mod<-select(plate2_mod, all_of(keepNames2))
plate3_mod<-select(plate3_mod, all_of(keepNames3))

# confirm
names(plate1_mod)
names(plate2_mod)
names(plate3_mod)
```

## Growthcurver

Let's go ahead and try Growthcurver. We'll get parameter estimates for all of the remaining sample wells with and without the blank-well correction. First, with the default ("min") correction:
```{r}
plate1_out_min<-SummarizeGrowthByPlate(plate1_mod, plot_fit=TRUE, plot_file = "plate1_min.pdf")
plate2_out_min<-SummarizeGrowthByPlate(plate2_mod, plot_fit=TRUE, plot_file = "plate2_min.pdf")
plate3_out_min<-SummarizeGrowthByPlate(plate3_mod, plot_fit=TRUE, plot_file = "plate3_min.pdf")
```

The plots look OK - onboard smoothing seems to have done an OK job. Print out estimates and see how we are doing:
```{r}
View(plate1_out_min)
View(plate2_out_min)
View(plate3_out_min)
```

So far so good. What if we use the "blank" correction?
```{r}
plate1_out_blank<-SummarizeGrowthByPlate(plate1_mod, bg_correct = "blank", plot_fit=TRUE, plot_file = "plate1_blank.pdf")
plate2_out_blank<-SummarizeGrowthByPlate(plate2_mod, bg_correct = "blank", plot_fit=TRUE, plot_file = "plate2_blank.pdf")
plate3_out_blank<-SummarizeGrowthByPlate(plate3_mod, bg_correct = "blank", plot_fit=TRUE, plot_file = "plate3_blank.pdf")
```

The fits are very similar, so let's work with the default for now. 

Now let's label these estimates using the well info from each file. For plate 1:
```{r}
my_labels1<-read_excel("20230217-MD-NGM-p6-p10.xlsx", sheet="Labels", col_names=TRUE)
#knitr::kable(my_labels1)
```

And plates 2-3:
```{r}
my_labels2<-read_excel("20230218-MD-NGM-p6-p10.xlsx", sheet="Labels", col_names=TRUE)
my_labels3<-read_excel("20230219-MD-NGM-p6-p10.xlsx", sheet="Labels", col_names=TRUE)
```


And add labels to each set of parameter estimates. First to plate 1:
```{r}
plate1_out_min<- label96well(plate1_out_min, my_labels1)
View(plate1_out_min)
```

and to the other two plates:
```{r}
plate2_out_min<- label96well(plate2_out_min, my_labels2)
plate3_out_min<- label96well(plate3_out_min, my_labels3)
```

Now we can add a column indicating plate ID to these parameter estimates (new first column):
```{r}
plate1_out_min<-add_column(plate1_out_min, Plate=1, .before="sample")
plate2_out_min<-add_column(plate2_out_min, Plate=2, .before="sample")
plate3_out_min<-add_column(plate3_out_min, Plate=3, .before="sample")
```

And combine the parameter estimates into a single object:
```{r}
allplates_LVparams_min<-rbind(plate1_out_min, plate2_out_min, plate3_out_min)
```

Clean up
```{r}
allplates_LVparams_min<-allplates_LVparams_min[complete.cases(allplates_LVparams_min),]
```

Let's prune out the most egregious weird wells:
```{r}
# the "weird wells"
View(allplates_LVparams_min[which(allplates_LVparams_min$t_mid>16),])
View(allplates_LVparams_min[which(allplates_LVparams_min$t_mid<10.2),])
```

```{r}
# take out the weird wells
allplates_LVparams_min<-allplates_LVparams_min[which(allplates_LVparams_min$t_mid<=16),]
allplates_LVparams_min<-allplates_LVparams_min[which(allplates_LVparams_min$t_mid>=10.2),]
```

Carrying capacity doesn't seem to have changed much, and the estimates of growth rate from growthcurver tend to be unstable - we'll estimate those from spline fits farther down. Let's plot K here:
```{r}
WTmedian_k<-median(allplates_LVparams_min$k[allplates_LVparams_min$Strain=="WT"])

# reorder
allplates_LVparams_min$Strain<-factor(allplates_LVparams_min$Strain, 
                                      levels=c("WT", "A1o6", "A1o10", "A2o6", "A2o10",
                                               "F1o6", "F1o10", "F2o6", "F2o10",
                                               "A2a6", "A2a10", "F2a6", "F2a10"))

pLVparams_min_k_box<-allplates_LVparams_min %>%
  ggplot(aes(x=Strain, y=k, color=Strain))+
  theme_classic()+
  geom_boxplot()+
  geom_jitter(width=0.1)+
  geom_hline(yintercept = WTmedian_k, color="black")+
  theme(legend.position = "none",
        text=element_text(size=xTextSize)) +
  labs(x="", y="Saturation OD600 (K)")
pLVparams_min_k_box + 
            scale_color_manual(values=c("black", "red", "red2", "red3", "red4",
                                        "dodgerblue", "dodgerblue2", "dodgerblue3", "dodgerblue4",
                                        "magenta", "magenta3", "purple", "purple3"))
```

We can also add hypothesis tests to the plots (here, each vs. ancestor):
```{r}
pLVparams_min_k_box + 
            scale_color_manual(values=c("black", "red", "red2", "red3", "red4",
                                        "dodgerblue", "dodgerblue2", "dodgerblue3", "dodgerblue4",
                                        "magenta", "magenta3", "purple", "purple3"))+
      stat_compare_means(label.x = 2, label.y=0.14) +
  stat_compare_means(aes(label = after_stat(p.signif)),method="wilcox.test",                     
                     ref.group="WT", label.y=0.28)
```


## Growthrates
The spline fits here will give better estimates of growth rate r.
Growthrates requires the data to be in a different format. Let's pivot the data out. Recall that the "plate[X]_mod" objects contain the original-layout OD600 data with no-growth wells removed.
```{r}
plate1_mod_long<-plate1_mod %>%
  select(!blank) %>% # don't need blank well here
  pivot_longer(cols = A1:H1,
               names_to = "sample",
               values_to = "OD600")
plate2_mod_long<-plate2_mod %>%
  select(!blank) %>% # don't need blank well here
  pivot_longer(cols = A1:H1,
               names_to = "sample",
               values_to = "OD600")
plate3_mod_long<-plate3_mod %>%
  select(!blank) %>% # don't need blank well here
  pivot_longer(cols = A1:H1,
               names_to = "sample",
               values_to = "OD600")
```

Now we can add labels to these objects directly (since growthrates will let us make use of these labels if we want to)
```{r}
plate1_mod_long<-label96well(plate1_mod_long, my_labels1)
plate2_mod_long<-label96well(plate2_mod_long, my_labels2)
plate3_mod_long<-label96well(plate3_mod_long, my_labels3)

# Confirm
str(plate1_mod_long)
str(plate2_mod_long)
str(plate3_mod_long)
```

We can plot out with ggplot to check the data:
```{r}
plate1_mod_long %>%
  mutate(Pass=factor(Pass)) %>%
  ggplot(aes(time, OD600)) + 
  geom_point(aes(color=Pass)) + 
  facet_grid(Community ~ Morph)
```

Plate 2:
```{r}
plate2_mod_long %>%
  mutate(Pass=factor(Pass)) %>%
  ggplot(aes(time, OD600)) + 
  geom_point(aes(color=Pass)) + 
  facet_grid(Community ~ Morph)
```

Plate 3:
```{r}
plate3_mod_long %>%
  mutate(Pass=factor(Pass)) %>%
  ggplot(aes(time, OD600)) + 
  geom_point(aes(color=Pass)) + 
  facet_grid(Community ~ Morph)
```

Now we can fit splines. I want estimates for each well, so we'll tell growthrates to separate by well:
```{r}
# Single-well fit for illustration, as in the vignette
splitted.data.plate1<-multisplit(plate1_mod_long, "sample")
dat<-splitted.data.plate1[[1]] # should be the first data set (well A1)
dat
```

```{r}
unique(dat$sample)
```
Starting with plate 1, fit splines:
```{r}
plate1_manyspline<-all_splines(OD600~time | sample, data=plate1_mod_long, spar=0.9)
par(mfrow=c(7,8))
par(mar = c(2.5, 4, 2, 1))
plot(plate1_manyspline)
```
Plots look good; smoothing is working well. Let's do the same for each of the other plates. Plate 2:
```{r}
plate2_manyspline<-all_splines(OD600~time | sample, data=plate2_mod_long, spar=0.9)
par(mfrow=c(7,8))
par(mar = c(2.5, 4, 2, 1))
plot(plate2_manyspline)
```

Plate 3:
```{r}
plate3_manyspline<-all_splines(OD600~time | sample, data=plate3_mod_long, spar=0.9)
par(mfrow=c(7,8))
par(mar = c(2.5, 4, 2, 1))
plot(plate3_manyspline)
```

Now that we have these fits, let's extract the parameters. 
```{r}
# This gives us a list by well. For splines, we only need to keep max growth rate (mumax) estimates
coef(plate1_manyspline)
```

The coef() function returns a matrix, which is not what we want. Let's turn this into a data frame:
```{r}
plate1_manyspline_coef<-as_tibble(coef(plate1_manyspline), rownames=NA)
str(plate1_manyspline_coef)
```
Note that it did not bring well labels along for some reason (I think rownames=NA is supposed to retain these, not sure what's wrong); we'll have to retrieve those.
```{r}
# We can get the names from the coef() object
temp<-dimnames(coef(plate1_manyspline))
temp
temp[[1]]
```
Attach these well IDs to the coefficients:
```{r}
plate1_manyspline_coef$sample<-temp[[1]]
plate1_manyspline_coef
```

Let's do the same for plates 2 and 3:
```{r}
plate2_manyspline_coef<-as_tibble(coef(plate2_manyspline), rownames=NA)
temp<-dimnames(coef(plate2_manyspline))
plate2_manyspline_coef$sample<-temp[[1]]

plate3_manyspline_coef<-as_tibble(coef(plate3_manyspline), rownames=NA)
temp<-dimnames(coef(plate3_manyspline))
plate3_manyspline_coef$sample<-temp[[1]]

str(plate2_manyspline_coef)
str(plate3_manyspline_coef)
```

Now we have all our coefficients and their well labels. Pass these objects back through the labeler to get the meta-data associated with each well. Plate 1 first, to illustrate:
```{r}
plate1_manyspline_coef<-label96well(plate1_manyspline_coef, my_labels1)
str(plate1_manyspline_coef)
```
Once plates 2 and 3 are labeled, we can add the plate ID, then combine into a single data frame.
```{r}
# Finish labels
plate2_manyspline_coef<-label96well(plate2_manyspline_coef, my_labels2)
plate3_manyspline_coef<-label96well(plate3_manyspline_coef, my_labels3)

# Add plate IDs
plate1_manyspline_coef<-add_column(plate1_manyspline_coef, Plate=1, .before="y0")
plate2_manyspline_coef<-add_column(plate2_manyspline_coef, Plate=2, .before="y0")
plate3_manyspline_coef<-add_column(plate3_manyspline_coef, Plate=3, .before="y0")

# Merge
allplates_manyspline_coef<-rbind(plate1_manyspline_coef,
                                 plate2_manyspline_coef,
                                 plate3_manyspline_coef)
str(allplates_manyspline_coef)
```

Now we can plot out exactly as before:
```{r}
WTmedian_r_spline<-median(allplates_manyspline_coef$mumax[allplates_manyspline_coef$Strain=="WT"])

# Colored by isolate
allplates_manyspline_coef %>%
  ggplot(aes(x=Strain, y=mumax, color=factor(Rep)))+
  theme_classic()+
  geom_jitter(width=0.1)+
  geom_hline(yintercept = WTmedian_r_spline, color="black")+
  labs(x="", y="Growth Rate (r)", color="Isolate")
```
And colored by plate:
```{r}
# Colored by isolate
allplates_manyspline_coef %>%
  ggplot(aes(x=Strain, y=mumax, color=factor(Plate)))+
  theme_classic()+
  geom_jitter(width=0.1)+
  geom_hline(yintercept = WTmedian_r_spline, color="black")+
  labs(x="", y="Growth Rate (r)", color="Run")
```

Run 3 is pretty consistently giving lower values for growth rate; same thing was seen when fitting using growthcurver. What happens if that run is excluded?
```{r}
WTmedian_r_spline_12<-median(allplates_manyspline_coef$mumax[allplates_manyspline_coef$Strain=="WT" &
                                                               allplates_manyspline_coef$Plate!=3])

pallplates_manyspline_r_plate1plate2<-allplates_manyspline_coef %>%
  filter(Plate!=3) %>%
  ggplot(aes(x=Strain, y=mumax, color=factor(Rep)))+
  theme_classic()+
  geom_jitter(width=0.1)+
  geom_hline(yintercept = WTmedian_r_spline_12, color="black")+
  labs(x="", y="Growth Rate (r)", color="Isolate")
pallplates_manyspline_r_plate1plate2
```
Not sure it makes that much difference. I'll keep the third replicate for now; should check & see if it separates out as a factor thought.

These values are much more reasonable than the ones obtained from growthcurver. Let's replace that plot with a plot of these data:
```{r}
# reorder
allplates_manyspline_coef$Strain<-factor(allplates_manyspline_coef$Strain, 
                                      levels=c("WT", "A1o6", "A1o10", "A2o6", "A2o10",
                                               "F1o6", "F1o10", "F2o6", "F2o10",
                                               "A2a6", "A2a10", "F2a6", "F2a10"))

pLVparams_spline_r_box<-allplates_manyspline_coef %>%
  ggplot(aes(x=Strain, y=mumax, color=Strain))+
  theme_classic()+
  geom_boxplot()+
  geom_jitter(width=0.1)+
  geom_hline(yintercept = WTmedian_r_spline, color="black")+
  theme(legend.position = "none",
        text=element_text(size=xTextSize)) +
  labs(x="", y="Growth Rate (r)")
pLVparams_spline_r_box
```

Combine with plot of OD600 carrying capacity:
```{r}
plot_grid(
  pLVparams_spline_r_box + 
            scale_color_manual(values=c("black", "red", "red2", "red3", "red4",
                                        "dodgerblue", "dodgerblue2", "dodgerblue3", "dodgerblue4",
                                        "magenta", "magenta3", "purple", "purple3"))+ 
  stat_compare_means(label.x=2, label.y=0.04) +
  stat_compare_means(aes(label = after_stat(p.signif)),method="wilcox.test", 
                     ref.group="WT", label.y=0.14),
  pLVparams_min_k_box + 
            scale_color_manual(values=c("black", "red", "red2", "red3", "red4",
                                        "dodgerblue", "dodgerblue2", "dodgerblue3", "dodgerblue4",
                                        "magenta", "magenta3", "purple", "purple3"))+
      stat_compare_means(label.x = 2, label.y=0.14) +
  stat_compare_means(aes(label = after_stat(p.signif)),method="wilcox.test",
                     ref.group="WT", label.y=0.28),
  ncol=1, align="v")
#ggsave("pLVGrowthParamsCG_merge_wilcox.png", height=7, width=10, units="in", dpi=300)
```


##CFU data
Adding in the CFU/mL data from 24 hour cultures. Read in NGM medium only data from file:
```{r}
CG_CFU <- read_excel("CG_CFU_per_mL.xlsx", sheet = "plate read cfu")
str(CG_CFU)
```
Let's add a logCFU column to make plotting a little easier. 
```{r}
CG_CFU <- CG_CFU %>%
  mutate(logCFU=log10(CFU))
str(CG_CFU)
```
This also introduces Infs, which we can use to take out any missing data:
```{r}
CG_CFU<-CG_CFU[!is.infinite(CG_CFU$logCFU),]
```

Let's get the WT median:
```{r}
WTmedian_CFU<-median(CG_CFU$logCFU[CG_CFU$Community=="WT"])
```

Now we can plot (same basic code as for growth curve parameters):
```{r}
# reorder
CG_CFU$ID<-factor(CG_CFU$ID, levels=c("WT", "A1o6", "A1o10", "A2o6", "A2o10",
                                               "F1o6", "F1o10", "F2o6", "F2o10",
                                               "A2a6", "A2a10", "F2a6", "F2a10"))

pCG_CFU<-CG_CFU %>%
  ggplot(aes(x=ID, y=logCFU, color=ID))+
  theme_classic()+
  geom_boxplot()+
  geom_jitter(width=0.1)+
  geom_hline(yintercept = WTmedian_CFU, color="black")+
  theme(legend.position = "none",
        text=element_text(size=xTextSize)) +
  labs(x="", y=expression(log[10](CFU/mL)))
pCG_CFU
```
Add this plot to the grid with the lgistic growth parameters:
```{r}
plot_grid(
  pLVparams_spline_r_box + 
            scale_color_manual(values=c("black", "red", "red2", "red3", "red4",
                                        "dodgerblue", "dodgerblue2", "dodgerblue3", "dodgerblue4",
                                        "magenta", "magenta3", "purple", "purple3"))+ 
  stat_compare_means(label.x=2, label.y=0.04) +
  stat_compare_means(aes(label = after_stat(p.signif)),method="wilcox.test", 
                     ref.group="WT", label.y=0.14),
  
  pLVparams_min_k_box + 
            scale_color_manual(values=c("black", "red", "red2", "red3", "red4",
                                        "dodgerblue", "dodgerblue2", "dodgerblue3", "dodgerblue4",
                                        "magenta", "magenta3", "purple", "purple3")) +
  stat_compare_means(label.x = 2, label.y=0.14) +
  stat_compare_means(aes(label = after_stat(p.signif)),method="wilcox.test",
                     ref.group="WT", label.y=0.28),
  
  pCG_CFU + 
            scale_color_manual(values=c("black", "red", "red2", "red3", "red4",
                                        "dodgerblue", "dodgerblue2", "dodgerblue3", "dodgerblue4",
                                        "magenta", "magenta3", "purple", "purple3")) +
  stat_compare_means(label.x = 2, label.y=8) +
  stat_compare_means(aes(label = after_stat(p.signif)),method="wilcox.test",
                     ref.group="WT", label.y=9.7),

  ncol=1, align="v", labels="AUTO")
#ggsave("pCG_LVGrowthParams_CFU_merge_wilcox.png", 
 #      height=8.5, width=7, units="in", dpi=300)
```

## Pairwise in vitro competitions
Read in the data:
```{r}
NRRL2_CG_Morph_Compete<-read_excel("NRRL2CXMorphologyCompetition.xlsx", sheet="summary")
names(NRRL2_CG_Morph_Compete)
NRRL2_CG_Morph_Compete<-as_tibble(NRRL2_CG_Morph_Compete, stringsAsFactors="TRUE")

#glimpse(NRRL2_CG_Morph_Compete)
#View(NRRL2_CG_Morph_Compete)

# max proportion alternate
# when total counts sufficient
max(NRRL2_CG_Morph_Compete$fAlt[NRRL2_CG_Morph_Compete$cAlt>5]) #99.45%

# rename ancestor
NRRL2_CG_Morph_Compete$strain2<-replace(NRRL2_CG_Morph_Compete$strain2,
                                        NRRL2_CG_Morph_Compete$strain2=="CG0",
                                        "WT") 
```

plot out raw proportion fAlt data
```{r}
# first reorder levels
unique(NRRL2_CG_Morph_Compete$strain1)
NRRL2_CG_Morph_Compete$strain1 <-factor(NRRL2_CG_Morph_Compete$strain1,
                                        levels=c("A2a6", "A2a10", "F2a6", "F2a10"))
unique(NRRL2_CG_Morph_Compete$strain2)
NRRL2_CG_Morph_Compete$strain2 <-factor(NRRL2_CG_Morph_Compete$strain2,
                                        levels=c("WT", "A1o6", "A1o10", "A2o6", "A2o10",
                                                 "F1o6", "F1o10", "F2o6", "F2o10"))

# Take out the day that appears in only one set
NRRL2_CG_Morph_Compete<-NRRL2_CG_Morph_Compete  %>%
  filter(day!=21)

pNRRL2_MorphCompeteInVitro_fAlt<-NRRL2_CG_Morph_Compete %>%
  ggplot(aes(x=day, y=fAlt, color=strain1)) +
  geom_line(aes(linetype=factor(rep)))+
  theme_bw()+
  scale_colour_discrete()+
  theme(
    axis.text=element_text(size=xTextSize), 
    axis.title=element_text(size=xTextSize+2),
    strip.text=element_text(size=xTextSize),
    plot.title=element_text(hjust=0.5, size=xTextSize+2, face="bold"), 
    legend.text=element_text(size=xTextSize),
    legend.title =element_text(size=xTextSize),
    plot.margin = margin(r=40)
    )  +
  labs(y="Fraction Alternate Morph", x="Day", title="In Vitro Competition",
       linetype="Isolate", color="Alt Morph")+
  facet_wrap(~strain2)
pNRRL2_MorphCompeteInVitro_fAlt

```

Now we can take the various deltas. Let's set aside the day 14 data from the pairwise comparisons. We'll add some columns to hold the deltas, then fill them using the strain1 and strain2 labels to find the right data in the other data frames.
```{r}
NRRL2_CG_Morph_Compete_14<-NRRL2_CG_Morph_Compete %>%
  filter(day==14) %>%
  add_column(delta_r=NA, delta_CFU=NA)
glimpse(NRRL2_CG_Morph_Compete_14)
```
Now to grab the deltas. First check out the objects - CFU
```{r}
str(CG_CFU)
```

and growth rates
```{r}
str(allplates_manyspline_coef)
```

Make the deltas (we'll do Alt-Ori).
```{r}
my_dim<-dim(NRRL2_CG_Morph_Compete_14)
for (i in 1:my_dim[1]){
  strain_a<-NRRL2_CG_Morph_Compete_14$strain1[i]
  strain_o<-NRRL2_CG_Morph_Compete_14$strain2[i]
  NRRL2_CG_Morph_Compete_14$delta_r[i]<-median(allplates_manyspline_coef$mumax[allplates_manyspline_coef$Strain==strain_a &
                                                                                 allplates_manyspline_coef$Rep==NRRL2_CG_Morph_Compete_14$rep[i]]) - 
                                           median(allplates_manyspline_coef$mumax[allplates_manyspline_coef$Strain==strain_o &
                                                                                 allplates_manyspline_coef$Rep==NRRL2_CG_Morph_Compete_14$rep[i]])
  NRRL2_CG_Morph_Compete_14$delta_CFU<-median(CG_CFU$logCFU[CG_CFU$ID==strain_a &
                                              CG_CFU$Replicate==NRRL2_CG_Morph_Compete_14$rep[i]]) - 
                                           median(CG_CFU$logCFU[CG_CFU$ID==strain_o &
                                                  CG_CFU$Replicate==NRRL2_CG_Morph_Compete_14$rep[i]])
}

glimpse(NRRL2_CG_Morph_Compete_14)
```

Linear fits. Growth rate is not significant
```{r}
lm_deltagrowth<-lm(delta_r~fAlt, data=NRRL2_CG_Morph_Compete_14)
summary(lm_deltagrowth)
```
Nor is delta log(CFU)
```{r}
lm_deltaCFU<-lm(delta_CFU~fAlt, data=NRRL2_CG_Morph_Compete_14)
summary(lm_deltaCFU)
```

Plot out:
```{r}
pCompeteDeltaGrowth_byORI<-NRRL2_CG_Morph_Compete_14 %>%
  ggplot(aes(x=fAlt, y=delta_r, color=strain2))+
  geom_jitter(width=0.1)+
  theme_light()+
    theme(
    axis.text=element_text(size=xTextSize), 
    axis.title=element_text(size=xTextSize+2),
    #axis.text.x=element_blank(),
    legend.title=element_blank(),
    #legend.position = "none",
    plot.title=element_text(hjust=0.5, size=xTextSize+2, face="bold"), 
    legend.text=element_text(size=xTextSize))  +
  labs(y="Change in Growth Rate", x="Fraction Alt Morph", title="")
pCompeteDeltaGrowth_byORI
```
 Color by alt morph?
```{r}
pCompeteDeltaGrowth_byALT<-NRRL2_CG_Morph_Compete_14 %>%
  ggplot(aes(x=fAlt, y=delta_r, color=strain1))+
  geom_jitter(width=0.1)+
  theme_light()+
    theme(
    axis.text=element_text(size=xTextSize), 
    axis.title=element_text(size=xTextSize+2),
    #axis.text.x=element_blank(),
    legend.title=element_blank(),
    #legend.position = "none",
    plot.title=element_text(hjust=0.5, size=xTextSize+2, face="bold"), 
    legend.text=element_text(size=xTextSize))  +
  labs(y="Change in Growth Rate", x="Fraction Alt Morph", title="")
pCompeteDeltaGrowth_byALT
```
 

And plot vs CFU?
```{r}
pCompeteDeltaCFU_byORI<-NRRL2_CG_Morph_Compete_14 %>%
  ggplot(aes(x=fAlt, y=delta_CFU, color=strain2))+
  geom_jitter(width=0.1)+
  theme_light()+
    theme(
    axis.text=element_text(size=xTextSize), 
    axis.title=element_text(size=xTextSize+2),
    #axis.text.x=element_blank(),
    legend.title=element_blank(),
    #legend.position = "none",
    plot.title=element_text(hjust=0.5, size=xTextSize+2, face="bold"), 
    legend.text=element_text(size=xTextSize))  +
  labs(y="Change in log(Max CFU)", x="Fraction Alt Morph", title="")
pCompeteDeltaCFU_byORI
```
again, color by alt morph?
```{r}
pCompeteDeltaCFU_byALT<-NRRL2_CG_Morph_Compete_14 %>%
  ggplot(aes(x=fAlt, y=delta_CFU, color=strain1))+
  geom_jitter(width=0.1)+
  theme_light()+
    theme(
    axis.text=element_text(size=xTextSize), 
    axis.title=element_text(size=xTextSize+2),
    #axis.text.x=element_blank(),
    legend.title=element_blank(),
    #legend.position = "none",
    plot.title=element_text(hjust=0.5, size=xTextSize+2, face="bold"), 
    legend.text=element_text(size=xTextSize))  +
  labs(y="Change in log(Max CFU)", x="Fraction Alt Morph", title="")
pCompeteDeltaCFU_byALT
```
And together:
```{r}
plot_grid(pCompeteDeltaGrowth_byORI, pCompeteDeltaCFU_byORI,
          pCompeteDeltaGrowth_byALT, pCompeteDeltaCFU_byALT,
          ncol=2, labels="AUTO")
ggsave("pCompeteDeltas.png", width=10, height=8, units="in", dpi=300)
```


## Pairwise competition with worms on plates
Read in data:
```{r}
CG_Compete_PlusWorm<-read_excel("NRRL2CXMorphologyCompetition.xlsx", sheet="20230731PlusWorm")
names(CG_Compete_PlusWorm)
CG_Compete_PlusWorm<-as_tibble(CG_Compete_PlusWorm, stringsAsFactors="TRUE")

#glimpse(CG_Compete_PlusWorm)
#View(CG_Compete_PlusWorm)
# max proportion alternate
max(CG_Compete_PlusWorm$fAlt, na.rm=TRUE) #82.6%
```


Plot out raw proportion fAlt data
```{r}
# rename ancestor
CG_Compete_PlusWorm$ori<-replace(CG_Compete_PlusWorm$ori,
                                CG_Compete_PlusWorm$ori=="ANC",
                                        "WT") 

# reorder levels
unique(CG_Compete_PlusWorm$alt)
CG_Compete_PlusWorm$alt <-factor(CG_Compete_PlusWorm$alt,
                                        levels=c("A2a10", "F2a10"))
unique(CG_Compete_PlusWorm$ori)
CG_Compete_PlusWorm$ori <-factor(CG_Compete_PlusWorm$ori,
                                        levels=c("WT", "A1o10", "A2o10",
                                                 "F1o10", "F2o10"))
# plot
CG_Compete_PlusWorm %>%
  ggplot(aes(x=day, y=fAlt, color=alt)) +
  geom_line(aes(linetype=factor(isolate)))+
  theme_bw()+
  scale_colour_discrete()+
  theme(
    axis.text=element_text(size=myTextSize), 
    axis.title=element_text(size=myTextSize+2),
    strip.text=element_text(size=myTextSize),
    plot.title=element_text(hjust=0.5, size=myTextSize+2, face="bold"), 
    legend.text=element_text(size=myTextSize))  +
  labs(y="Fraction Alternate Morph", x="Day", title="+Worms",
       linetype="Isolate", color="Alt Morph")+
  facet_grid(vars(ori), vars(dAlt)) # by original morph and starting alt dilution (1:10 or 1:1)

```


 maybe a difference map?
```{r}
temp1<-CG_Compete_PlusWorm %>%
  dplyr::select(day, isolate, ori, alt, condition, dAlt, fAlt) %>%
  pivot_wider(names_from = day, values_from=fAlt, 
              names_prefix="day") %>%
  #mutate(delta7=day7-day0, delta14=day14-day7) %>% # get the deltas between time points
  #dplyr::select(isolate, condition, dAlt, day0, day14, delta7, delta14) %>%
  dplyr::select(isolate, ori, alt, condition, dAlt, day0, day7) %>%
  rename(f1=day0, f2=day7)
temp2<-CG_Compete_PlusWorm %>%
  dplyr::select(day, isolate, ori, alt, condition, dAlt, fAlt) %>%
  pivot_wider(names_from = day, values_from=fAlt, 
              names_prefix="day") %>%
  #mutate(delta7=day7-day0, delta14=day14-day7) %>% # get the deltas between time points
  #dplyr::select(isolate, condition, dAlt, day0, day14, delta7, delta14) %>%
  dplyr::select(isolate, ori, alt, condition, dAlt, day7, day14) %>%
  rename(f1=day7, f2=day14)

CG_Compete_PlusWorm_Diff<-rbind(temp1, temp2)
rm(temp1, temp2)

CG_Compete_PlusWorm_Diff$Community<-substr(CG_Compete_PlusWorm_Diff$alt, 1,1)

pCG_Compete_PlusWorm_Diff<-CG_Compete_PlusWorm_Diff %>%
  ggplot(aes(x=f1, y=f2, color=ori))+
  geom_point(size=2)+
  theme_bw()+
  geom_abline(slope=1, intercept=0)+
  #scale_colour_viridis_d(begin=0.92, end=0)+
  scale_color_brewer(palette="Dark2")+
  theme(
    axis.text.x=element_text(size=xTextSize, angle = 45, vjust = 1, hjust=1),
    axis.text.y=element_text(size=xTextSize),
    axis.title=element_text(size=xTextSize+2),
    strip.text=element_text(size=xTextSize),
    plot.title=element_text(hjust=0.5, size=xTextSize+2, face="bold"), 
    legend.text=element_text(size=xTextSize))  +
  labs(y="Final fAlt", x="Initial fAlt",
       title="+Worms", color="")+
  facet_wrap(~alt)
pCG_Compete_PlusWorm_Diff

```



fAlt data from chunks cut out of plates passaged in quadruplicate from day 14 of the experiment above. Diameters taken at 3 days, CFUs taken after 7 further days

```{r}
CG_Compete_WormDiameter<-read_excel("NRRL2CXMorphologyCompetition.xlsx", sheet="20230817WormDiameter")
names(CG_Compete_WormDiameter)
CG_Compete_WormDiameter<-as_tibble(CG_Compete_WormDiameter, stringsAsFactors="TRUE")
glimpse(CG_Compete_WormDiameter)

# rename ancestor
CG_Compete_WormDiameter$Ori<-replace(CG_Compete_WormDiameter$Ori,
                                CG_Compete_WormDiameter$Ori=="ANC",
                                        "WT") 
# reorder
unique(CG_Compete_WormDiameter$Ori)
CG_Compete_WormDiameter$Ori <-factor(CG_Compete_WormDiameter$Ori,
                                  levels=c("WT", "A1o10", "A2o10",
                                           "F1o10", "F2o10"))


pCG_Compete_WormDiameter<-CG_Compete_WormDiameter %>%
  ggplot(aes(x=Ori, y=Diameter, color=Alt))+
  geom_jitter(width=0.2, size=2)+
  theme_bw()+
  #scale_colour_viridis_d(begin=0.92, end=0)+
  #scale_color_brewer(palette="Dark2")+
  scale_color_manual(values=c("chartreuse3", "darkorchid2")) +
  theme(
    axis.text.x=element_text(size=xTextSize-2, angle = 45, vjust = 1, hjust=1),
    axis.text.y=element_text(size=xTextSize),
    axis.title=element_text(size=xTextSize+2),
    strip.text=element_text(size=xTextSize),
    plot.title=element_text(hjust=0.5, size=xTextSize+2, face="bold"), 
    legend.text=element_text(size=xTextSize),
    #legend.position = "top"
    #legend.position=c(0.8, 0.8)
    )  +
  labs(title="+Worms", y="Diameter (cm)", x="", color="")
pCG_Compete_WormDiameter

```


and the CFU data
```{r}
CG_Compete_WormChunk<-read_excel("NRRL2CXMorphologyCompetition.xlsx", sheet="20230814WormChunk")
#names(CG_Compete_WormChunk)
CG_Compete_WormChunk<-as_tibble(CG_Compete_WormChunk, stringsAsFactors="TRUE")
#glimpse(CG_Compete_WormChunk)

# first reorder levels
# rename ancestor
CG_Compete_WormChunk$ori<-replace(CG_Compete_WormChunk$ori,
                                CG_Compete_WormChunk$ori=="ANC",
                                        "WT") 

unique(CG_Compete_WormChunk$Ori)
CG_Compete_WormChunk$Ori <-factor(CG_Compete_WormChunk$Ori,
                                        levels=c("ANC", "A1o10", "A2o10",
                                                 "F1o10", "F2o10"))

pCG_Compete_WormChunk<-CG_Compete_WormChunk %>%
  ggplot(aes(x=Chunk, y=fAlt, pch=Chunk)) +
  geom_jitter(width=0.1, size=2, aes(color=Alt))+
  theme_bw()+
  ylim(-0.1, 1.1)+
  #scale_colour_discrete()+
  scale_color_manual(values=c("chartreuse3", "darkorchid2")) +
  theme(
    axis.text.x=element_text(size=xTextSize, angle = 45, vjust = 1, hjust=1),
    #axis.text.x=element_blank(),
    axis.text.y=element_text(size=xTextSize),
    axis.title=element_text(size=xTextSize+2),
    strip.text=element_text(size=xTextSize),
    plot.title=element_text(hjust=0.5, size=xTextSize+2, face="bold"), 
    legend.text=element_text(size=xTextSize))  +
  labs(y="fAlt", x="", title="+Worms",
       color="", pch="")+
  facet_wrap(~Ori, nrow=1)+
  stat_compare_means(method="wilcox.test", 
                     label.y=1.05,
                     aes(label = paste0("p =", ..p.format..)))
pCG_Compete_WormChunk
```




Are day-3 expansion diameter and over-representation of Alt at plate edge correlated? First, let's get over-representation quantified:

```{r}
CG_Compete_WormChunk_OR<-CG_Compete_WormChunk %>%  # pivot out so fAlt at center and edge are accessible
  dplyr::select(Ori, Alt, Well, Isolate, techrep, Chunk, fAlt) %>%
  pivot_wider(names_from = Chunk, values_from = fAlt)

CG_Compete_WormChunk_OR<-CG_Compete_WormChunk_OR %>% # get the difference (OR)
  mutate(delta_fAlt=Edge-Center, # as absolute
         delta_fAlt_normalized=(Edge-Center)/Edge) #and relative

# quick check
CG_Compete_WormChunk_OR %>%
  ggplot(aes(x=Ori, y=delta_fAlt, color=Alt))+
  geom_jitter(width=0.2)
CG_Compete_WormChunk_OR %>% # yikes
  ggplot(aes(x=Ori, y=delta_fAlt_normalized, color=Alt))+
  geom_jitter(width=0.2)

```


Now the expansion diameters at day 3. The data frames are already in the same order, so this is easy
```{r}
CG_Compete_WormChunk_OR$Diameter<-CG_Compete_WormDiameter$Diameter

# quick check
CG_Compete_WormChunk_OR %>%
  ggplot(aes(x=Diameter, y=delta_fAlt, color=Ori))+
  geom_jitter(width=0.2)

```


clearly this is complex. Separate by pair type

```{r}
CG_Compete_WormChunk_OR$PairType<-"Matched"
idx<-which(CG_Compete_WormChunk_OR$Ori=="A1o10" |
             CG_Compete_WormChunk_OR$Ori=="F1o10")
CG_Compete_WormChunk_OR$PairType[idx]<-"Non-Matched"
idx<-which(CG_Compete_WormChunk_OR$Ori=="WT")
CG_Compete_WormChunk_OR$PairType[idx]<-"Ancestor"
```

and plot
```{r}
pCG_Compete_WormChunk_OR_slopes<-CG_Compete_WormChunk_OR %>%
  ggplot(aes(x=Diameter, y=delta_fAlt, color=Alt))+
  geom_jitter(width=0.2)+
  ylim(-0.5, 1)+
  theme_bw()+
  #scale_color_brewer(palette="Dark2")+
  scale_color_manual(values=c("chartreuse3", "darkorchid2")) +
  geom_smooth(method="lm", formula = y ~ x, fill="NA")+
  theme(
    axis.text.x=element_text(size=xTextSize, vjust = 1, hjust=1),
    #axis.text.x=element_blank(),
    axis.text.y=element_text(size=xTextSize),
    axis.title=element_text(size=xTextSize+2),
    strip.text=element_text(size=xTextSize),
    plot.title=element_text(hjust=0.5, size=xTextSize+2, face="bold"), 
    legend.text=element_text(size=xTextSize))  +
  labs(y=expression(fAlt[Edge]-fAlt[Center]), x="Diameter (cm)", 
       title="",
       color="")+
  facet_wrap(~PairType)
pCG_Compete_WormChunk_OR_slopes
#ggsave("pCG_Compete_WormChunk_OR_slopes.png", width=8, height=3, units="in", dpi=400)

```


and fAlt at edge:
```{r}
pCG_Compete_WormChunk_fEdge_slopes<-CG_Compete_WormChunk_OR %>%
  ggplot(aes(x=Diameter, y=Edge, color=Alt))+
  geom_jitter(width=0.2)+
  ylim(-0.1, 1.1)+
  theme_bw()+
  scale_color_manual(values=c("chartreuse3", "darkorchid2")) +
  #scale_color_brewer(palette="Dark2")+
  geom_smooth(method="lm", formula = y ~ x, fill="NA")+
  theme(
    axis.text.x=element_text(size=xTextSize, vjust = 1, hjust=1),
    #axis.text.x=element_blank(),
    axis.text.y=element_text(size=xTextSize),
    axis.title=element_text(size=xTextSize+2),
    strip.text=element_text(size=xTextSize),
    plot.title=element_text(hjust=0.5, size=xTextSize+2, face="bold"), 
    legend.text=element_text(size=xTextSize))  +
  labs(y=expression(fAlt[Edge]), x="Diameter (cm)", 
       title="",
       color="")+
  facet_wrap(~PairType)
pCG_Compete_WormChunk_fEdge_slopes
#ggsave("pCG_Compete_WormChunk_fEdge_slopes.png", width=8, height=3, units="in", dpi=400)

```


And together
```{r}
plot_grid(pCG_Compete_WormChunk_fEdge_slopes,
          pCG_Compete_WormChunk_OR_slopes + ylim(-0.2, 1.1),
          ncol=1, labels="AUTO")
#ggsave("pCG_Compete_WormChunk_slopes.png", width=8, height=6, units="in", dpi=400)

```

FIGURE 2
```{r}
# version with the large grid of the 14-day in vitro data
#pCG_Compete_AB<-plot_grid(pNRRL2_MorphCompeteInVitro_fAlt,
#          pNRRL2_CG_Morph_Compete_d14_Same,
#          nrow=1,
#          #rel_widths = c(1.2, 1), 
#          labels="AUTO")
#pCG_Compete_CD<-plot_grid(pCG_Compete_PlusWorm_Diff, 
#                          pCG_Compete_WormDiameter,
#                          pCG_Compete_WormChunk,
#                          nrow=1,
#                          rel_widths=c(0.6, 0.4, 1), 
#                          labels=c("C", "D", "E"))
#pCG_Compete<-plot_grid(pCG_Compete_AB,
#                       pCG_Compete_CD,
#                       ncol=1,
#                       rel_heights = c(1.5, 1),
#                       labels="none")

# Version with the condensed in vitro day 14 data

pCG_Compete_AB<-plot_grid(pNRRL2_MorphCompeteInVitro_fAlt,
                          pNRRL2_CG_Morph_Compete_d14_Same_small,
                          ncol=1,
                          rel_heights = c(1.8, 1),
                          labels="AUTO")
pCG_Compete_CD<-plot_grid(pCG_Compete_PlusWorm_Diff, 
                          pCG_Compete_WormDiameter,
                          nrow=1,
                          rel_widths=c(1, 0.7), 
                          labels=c("C", "D"))
pCG_Compete_CDE<-plot_grid(pCG_Compete_CD,
                           pCG_Compete_WormChunk,
                           ncol=1,
                           labels=c("", "E"))

pCG_Compete<-plot_grid(pCG_Compete_AB,
                       pCG_Compete_CDE,
                       ncol=2,
                       #rel_heights = c(1.8, 0.8, 0.9, 1),
                       labels=c("", ""))

pCG_Compete
ggsave("Fig2_CG_Compete.png", width=14, height=7, units="in", dpi=400)

```




# Motility
## Motility in Different Agar Concentrations

Read in data:
```{r}
swarmreg1.5 <- read_excel("swarm assay all.xlsx", sheet = 3)
swarm.5 <- read_excel("swarm assay all.xlsx", sheet = 2)
swarm.35 <- read_excel("swarm assay all.xlsx", sheet = 1)
```

Quick check:
```{r}
glimpse(swarm.5)
```

Now pivot each one. First 1.5%
```{r}
plswarm1.5 <- swarmreg1.5 %>%
  pivot_longer(cols = A1o6:WT,
               names_to = "Samples",
               values_to = "Diameter"
               )
glimpse(plswarm1.5)
```

0.5% agar:
```{r}
swarm.5 <- swarm.5[,-1] #remove column 1
plswarm.5 <- swarm.5 %>%
  pivot_longer(cols = A1o6:WT,
               names_to = "Samples",
               values_to = "Diameter"
               )
glimpse(plswarm.5)
```

And 0.35%
```{r}
plswarm.35 <- swarm.35 %>%
  pivot_longer(cols = A1o6:WT,
               names_to = "Samples",
               values_to = "Diameter"
               )

glimpse(plswarm.35)
```

Combine to a single data frame
```{r}
# now I can add a column named "agar" to each data frame
# and combine the data
plswarm<-rbind(plswarm.5, plswarm1.5, plswarm.35)
glimpse(plswarm)
```

add columns for Community, Morph, Pass
```{r}
plswarm<-plswarm %>%
  mutate(Community=substr(Samples, 1, 2),
         Morph=substr(Samples, 3, 3),
         Pass=substr(Samples, 4, 5))
#head(plswarm)
view(plswarm)
```

Need to tidy this up:
```{r}
plswarm<-plswarm %>%
  mutate(Morph=replace(Morph, Community=="WT", "o")) %>% # WT is original morph
  mutate(Pass=replace(Pass, Community=="WT", 0)) # and is passage 0
view(plswarm)
```

And plot.
plotting community pass and replicate. Start with 0.35% agar:
```{r}
# Let's look at differences between morphs within each community and passage:
plot.35 <- plswarm %>%
  filter(agar == .35 & Community!="WT") %>%
  ggplot(aes(x=days, y=Diameter, color=Morph, linetype=factor(isolate)))+
  geom_line()+ 
  facet_grid(rows=vars(Community), cols=vars(Pass)) + 
  labs(title = ".35 agar", linetype = "Isolate")
plot.35
```

0.5% agar data
```{r}
plot.5 <- plswarm %>%
  #filter(agar == .5 & Community!="WT") %>%
  filter(agar == .5) %>%
  ggplot(aes(x=days, y=Diameter, color=Morph, linetype=factor(isolate)))+
  geom_line()+
  facet_grid(rows=vars(Community), cols=vars(Pass)) + 
  labs(title = "0.5 agar", linetype = "Isolate") 
plot.5
```

1.5% agar data
```{r}
plot1.5 <- plswarm %>%
  filter(agar == 1.5 & Community!="WT") %>%
  ggplot(aes(x=days, y=Diameter, color=Morph, linetype=factor(isolate)))+
  geom_line()+ 
  facet_grid(rows=vars(Community), cols=vars(Pass)) + 
  labs(title = "1.5 agar", linetype = "rep")
plot1.5
```


Final swarm diameter facet wrapped by agar, boxplots for both o and a morphs, geom_jitter shows all datapoints shaped by pass and colored by morph. Community is X axis. WT included  
```{r}
# label the last time point
plswarm<-plswarm %>%
  group_by(agar) %>%
  mutate(isLastTime = (days == max(days)))
```


I've made an ID column to remove the poorly growing A2o6 2
```{r}
plswarm$ID <- paste(plswarm$isolate,plswarm$Samples)
#plswarmID
head(plswarm)
```

Let's remove that isolate now:
```{r}
plswarm<-plswarm %>%
  filter(ID!="2 A2o6")
```


Plot out last time only:
```{r}
# and plot
plswarm_MultAgar_LastDay<-plswarm %>%
  filter(isLastTime==TRUE) %>%
  mutate(Morph=recode(Morph, "a"="Alternate", "o"="Original")) %>% # recode labels
  ggplot(aes(x=factor(Community), y=Diameter,
             color=factor(Morph))) + #, group=factor(Pass))) +
  scale_color_manual(values=c("red2", "darkblue")) +
  #geom_boxplot(aes(fill=Community)) +
  scale_fill_brewer(palette="Set3") +
  geom_jitter(aes(shape=factor(Pass)), width=0.1)+
  theme_classic()+
  theme(
    axis.text=element_text(size=xTextSize),
    axis.title = element_text(size=xTextSize+1),
    plot.title=element_text(hjust=0.5, size=xTextSize),
    strip.text=element_text(size=xTextSize),
    legend.text = element_text(size=xTextSize),
    legend.title = element_text(size=xTextSize)
  )+
  facet_wrap(~agar, scales="free_y") +
  labs(title="Agar Concentration", x="Community",
       y="Diameter (cm)", color="Morph", shape="Pass")

plswarm_MultAgar_LastDay

#ggsave("plswarm_finalday_jitter.png", width=8, height=5, units="in", dpi=400)
```

Create a data summary:
```{r}
plswarm_summ<-plswarm %>%
  group_by(agar, Community, Morph, Pass, days) %>% #pick what you want to summarize
  summarize(min = min(Diameter), 
            max = max(Diameter), #saying what we want to summarize, stats and data
            mean = mean(Diameter), 
            q1= quantile(Diameter, probs = 0.25), 
            median = median(Diameter), 
            q3= quantile(Diameter, probs = 0.75),
            sd = sd(Diameter)) %>%
  mutate_if(is.numeric, round, digits=2) #values, if something is numeric, round to 2 decimals

View(plswarm_summ)
```
Let's get swarm diameters for the ancestor for use as reference lines:
```{r}
LastTime_p35<-round(max(plswarm$days[plswarm$agar==0.35]), digits = 2)
LastTime_p5<-max(plswarm$days[plswarm$agar==0.5])
LastTime_1p5<-max(plswarm$days[plswarm$agar==1.5])
ancestor_median_p35<-plswarm_summ$median[plswarm_summ$agar==0.35 &
                                           plswarm_summ$Community=="WT" &
                                           plswarm_summ$days==LastTime_p35]
ancestor_median_p5<-plswarm_summ$median[plswarm_summ$agar==0.5 &
                                           plswarm_summ$Community=="WT" &
                                           plswarm_summ$days==LastTime_p5]
ancestor_median_1p5<-plswarm_summ$median[plswarm_summ$agar==1.5 &
                                           plswarm_summ$Community=="WT" &
                                           plswarm_summ$days==LastTime_1p5]
```



## Motility Diameters, Multiple Passes
Start with community A data. Read in:
```{r}
swarmA.35 <- read_excel("swarm assay all.xlsx", sheet = '.35 As')
plswarmA.35 <- swarmA.35 %>%
  pivot_longer(cols = A1o1:WT, #change first and last column name accordingly
               names_to = "Samples",
               values_to = "Diameter"
               )
head(plswarmA.35)
```

Create some new columns for labels:
```{r}
plswarmA.35<-plswarmA.35 %>%
  mutate(Community=substr(Samples, 1, 2),
         Morph=substr(Samples, 3, 3),
         Pass=substr(Samples, 4, 5))
view(plswarmA.35)
#view(plswarm)
```

And clean up:
```{r}
plswarmA.35<-plswarmA.35 %>%
  mutate(Morph=replace(Morph, Community=="WT", "o")) %>% # ..that WT is original morph
  mutate(Pass=replace(Pass, Community=="WT", 0)) # and is passage 0

view(plswarmA.35)
```

Get rid of missing data:
```{r}
plswarmA.35.naomit <- plswarmA.35[!(is.na(plswarmA.35$Diameter)), ]
view(plswarmA.35.naomit)
```

And plot out:
```{r}
plswarmA.35.naomit$Pass<-as.numeric(plswarmA.35.naomit$Pass)

plot.35A <- plswarmA.35.naomit %>%
  filter(Community!="WT") %>% 
  ggplot(aes(x=days, y=Diameter, color=factor(Pass), linetype=factor(isolate)))+
  geom_line()+
  geom_point(size=1) + 
  facet_grid(rows=vars(Community), cols=vars(Pass)) + 
  labs(title = "Community A, 0.35 agar", linetype = "Isolate", 
       y="Diameter (cm)", x="Days", color="Pass")

plot.35A
```

What time points exist?
```{r}
unique(plswarmA.35.naomit$days)
```

Let's summarize at day 1.8 for consistency with previous data:
```{r}
plswarmA.35.day1p8_summ<-plswarmA.35.naomit %>%
  filter(days==1.833) %>%
  group_by(Community, Morph, Pass) %>% #pick what you want to summarize
  summarize(min = min(Diameter), 
            max = max(Diameter), #saying what we want to summarize
            mean = mean(Diameter, na.rm=TRUE), 
            q1= quantile(Diameter, probs = 0.25, na.rm=TRUE), 
            median = median(Diameter, na.rm=TRUE), 
            q3= quantile(Diameter, probs = 0.75, na.rm=TRUE),
            sd = sd(Diameter, na.rm=TRUE),
            nreps=n()) %>%
  mutate_if(is.numeric, round, digits=2) #values, if something is numeric, round to 2 decimals

View(plswarmA.35.day1p8_summ)
```

And plot. First all replicates:
```{r}
day1p8_WTmedian_A<-median(plswarmA.35.naomit$Diameter[plswarmA.35.naomit$Community=="WT" &
                                                        plswarmA.35.naomit$days==1.833])
rep.35A.day1p8.facet <- plswarmA.35.naomit %>%
  filter(days==1.833 & Community!="WT") %>%
  ggplot(aes(x=as.factor(Pass), y=Diameter, color=factor(isolate),)) +
  #geom_point(size=2) +
  theme_light()+
  geom_jitter(size=2, width=0, height=0.2)+
  #scale_shape_manual(values=c(16,16))+
  geom_hline(aes(yintercept = day1p8_WTmedian_A, group = Pass), colour = 'firebrick4') + #WT median
    theme(
    axis.text=element_text(size=xTextSize),
    axis.title = element_text(size=xTextSize+1),
    title=element_text(hjust=0.5, size=xTextSize),
    strip.text=element_text(size=xTextSize),
    legend.text = element_text(size=xTextSize),
    legend.position = "none"
  )+
  facet_wrap(~Community) + 
  labs(title="Community A", x="Pass",
       y="Diameter (cm)", color="Isolate")
```

View plot:
```{r}
rep.35A.day1p8.facet
```

Now the community F data. Read in:
```{r}
swarmF.35 <- read_excel("swarm assay all.xlsx", sheet = '.35 Fs')
plswarmF.35 <- swarmF.35 %>%
  pivot_longer(cols = F1o1:WT, #change first and last column name accordingly
               names_to = "Samples",
               values_to = "Diameter"
               )
head(plswarmF.35)
```

Make some data types change:
```{r}
plswarmF.35$isolate<-as.factor(plswarmF.35$isolate)

plswarmF.35 <- plswarmF.35 %>%
  mutate_if(is.numeric, round, digits=2)

View(plswarmF.35)
```


Create some new columns for labels:
```{r}
plswarmF.35<-plswarmF.35 %>%
  mutate(Community=substr(Samples, 1, 2),
         Morph=substr(Samples, 3, 3),
         Pass=substr(Samples, 4, 5))
#View(plswarmF.35)
#view(plswarm)
```

And clean up:
```{r}
plswarmF.35 <- plswarmF.35[!(is.na(plswarmF.35$Diameter)), ]

plswarmF.35<-plswarmF.35 %>%
  mutate(Morph=replace(Morph, Community=="WT", "o")) %>% # ..that WT is original morph
  mutate(Pass=replace(Pass, Community=="WT", 0)) # and is passage 0

View(plswarmF.35)
```

And plot out:
```{r}
plswarmF.35$Pass<-as.numeric(plswarmF.35$Pass)

plot.35F <- plswarmF.35 %>%
  filter(Community!="WT") %>% 
  ggplot(aes(x=days, y=Diameter, color=factor(Pass), linetype=factor(isolate)))+
  geom_line()+
  geom_point(size=1) + 
  facet_grid(rows=vars(Community), cols=vars(Pass)) + 
  labs(title = "Community F, 0.35 agar", linetype = "Isolate", 
       y="Diameter (cm)", x="Days", color="Pass")

plot.35F
```

What time points exist?
```{r}
unique(plswarmF.35$days)
```

Let's summarize at day 1.67 for consistency with previous data:
```{r}
plswarmF.35.day1p7_summ<-plswarmF.35 %>%
  filter(days==1.67) %>%
  group_by(Community, Morph, Pass) %>% #pick what you want to summarize
  summarize(min = min(Diameter), 
            max = max(Diameter), #saying what we want to summarize
            mean = mean(Diameter, na.rm=TRUE), 
            q1= quantile(Diameter, probs = 0.25, na.rm=TRUE), 
            median = median(Diameter, na.rm=TRUE), 
            q3= quantile(Diameter, probs = 0.75, na.rm=TRUE),
            sd = sd(Diameter, na.rm=TRUE),
            nreps=n()) %>%
  mutate_if(is.numeric, round, digits=2) #values, if something is numeric, round to 2 decimals

View(plswarmF.35.day1p7_summ)
```

And plot. First all replicates:
```{r}
day1p8_WTmedian_F<-median(plswarmF.35$Diameter[plswarmF.35$Community=="WT" &
                                                        plswarmF.35$days==1.67])
rep.35F.day1p8.facet <- plswarmF.35 %>%
  filter(days==1.67 & Community!="WT") %>%
  ggplot(aes(x=as.factor(Pass), y=Diameter, color=factor(isolate),)) +
  theme_light()+
  geom_jitter(size=2, width=0, height=0.2)+
  #scale_shape_manual(values=c(16,16))+
  geom_hline(aes(yintercept = day1p8_WTmedian_F, group = Pass), 
             colour = 'firebrick4') + #WT median
    theme(
    axis.text=element_text(size=xTextSize),
    axis.title = element_text(size=xTextSize+1),
    title=element_text(hjust=0.5, size=xTextSize),
    strip.text=element_text(size=xTextSize),
    legend.text = element_text(size=xTextSize)
  )+
  facet_wrap(~Community) + 
  labs(title="Community F", x="Pass",
       y="", color="Isolate")
```

View plot:
```{r}
rep.35F.day1p8.facet
```
Now we can put the data together:
```{r}
pMultiPassDiameter_AF<-plot_grid(rep.35A.day1p8.facet, rep.35F.day1p8.facet, 
                                 ncol=2, rel_widths = c(0.8, 1), labels=c("B", "C"))
pCGMotilitySummary<-plot_grid(plswarm_MultAgar_LastDay, 
                              pMultiPassDiameter_AF,
                              ncol=1, rel_heights=c(1,0.9), labels=c("A", ""))
#pCGMotilitySummary<-plot_grid(plswarm_MultAgar_LastDay, 
#                              rep.35A.day1p8.facet, rep.35F.day1p8.facet,
#                              ncol=3, rel_widths=c(1, 0.4, 0.5), labels="AUTO")
pCGMotilitySummary
ggsave("Fig4ABC_pCGMotilitySummary.png", width=10, height=8, units="in", dpi=400)
```



## Swarm Diameters, Nutrient Concentration Varied
2023-05-18. Isolates were colonies (n=3) of original or alternate morph picked from a new streak-out of the worm digest glycerol stock of community F2 pass 6. Grew overnight in 1 mL LB, spun down 900 uL for 2 min at 8000xg, and resuspended in same vol of liquid NGM 0.25X peptone. From these, constructed 10^8 stocks in the correct liquid NGM, and dispensed in triplicate as 150 uL into 96 well plate (technical replicates from each stock). Plate was covered with BreatheEasy and moved to 25C with shaking for 6 hours. Plates were poured and cooled to standard specs, then inoculated with 1 uL in the center of the plate.

Note that there were no ancestor controls here - we are instead comparing across nutrient densities. Also note that I am using isolate IDs 1-3 for convenience; these are F2o6 #5-7 and F2a6 #7-9.

First, read in data:
```{r}
nd_diam_F <- read_excel("swarm assay all.xlsx", sheet = "nutrientF")
view(nd_diam_F)
nd_diam_F<-nd_diam_F %>%
    mutate(Morph=recode(Morph, "a"="Alternate", "o"="Original")) # recode labels
```

Data are already in a ggplot-usable format, no need to modify. Let's go ahead and plot:
```{r}
p_nd_diam_F<-nd_diam_F %>%
  ggplot(aes(x=days, y=Diameter, color=Morph, shape=factor(isolate))) +
  geom_point(size=2) +
  #geom_smooth(method = "lm", fill = NA)+
  theme_light()+
    scale_color_manual(values=c("red2", "darkblue")) +
  labs(title="Nutrient Concentration", 
       x="Time (Days)", y="Diameter", color="Morph", shape="Isolate") +
  theme(text = element_text(size = 14)) +
  facet_wrap(~Peptone, ncol=3)
p_nd_diam_F
```
Clearly, all isolates and replicates within a given morph are behaving similarly. Interestingly, the standard NGM peptone concentration (1X) seems to allow larger diameters than either the low or high peptone condition, but only really for the original isolates.

let's get some log-linear fits.
```{r}
p_nd_diam_F_lmlines<-nd_diam_F %>%
    mutate(Morph=recode(Morph, "a"="Alternate", "o"="Original")) %>% # recode labels
  ggplot(aes(x=days, y=Diameter, color=Morph)) +
  geom_point(size=2) +
    scale_color_manual(values=c("red2", "darkblue")) +
  #geom_smooth(method = "lm", fill = NA)+
  geom_smooth(method="lm", formula = y ~ log(x), fill="NA")+
  theme_light()+
  labs(title="Nutrient Concentration", 
       x="Time (Days)", y="Diameter", color="Morph") +
  theme(text = element_text(size = 14)) +
  facet_wrap(~Peptone, ncol=3)
p_nd_diam_F_lmlines
```

Can we get slopes between time points? First let's make a unique ID:
```{r}
nd_diam_F <- nd_diam_F %>%
  unite("ID", Morph:techrep, remove=FALSE) # create an ID by merging morph, rep, and techrep
unique(nd_diam_F$ID)
```

Using this ID we can trace individual replicates over time points:
```{r}
my_times<-unique(nd_diam_F$hours)
my_times
```
Set up a data object to keep the values:
```{r}
my_wells<-unique(nd_diam_F$SourceWell)
my_len<-length(my_wells)
nd_diam_slope_F<-tibble(SourceWell=rep(my_wells,times=5), 
                      hours=c(rep(my_times[2], my_len),
                              rep(my_times[3], my_len),
                              rep(my_times[4], my_len),
                              rep(my_times[5], my_len),
                              rep(my_times[6], my_len)),
                      slope=NA)
view(nd_diam_slope_F)
```

And set up a loop:
```{r}
for(i in 2:6){
  for(j in seq_along(my_wells)){
    my_slope<-(nd_diam_F$Diameter[nd_diam_F$hours==my_times[i] & 
                                    nd_diam_F$SourceWell == my_wells[j]] - 
                 nd_diam_F$Diameter[nd_diam_F$hours==my_times[i-1] & 
                                      nd_diam_F$SourceWell == my_wells[j]])/(my_times[i] - my_times[i-1])
    nd_diam_slope_F$slope[nd_diam_slope_F$hours==my_times[i] & 
                            nd_diam_slope_F$SourceWell == my_wells[j]] <- my_slope
  }
}

```

Check
```{r}
view(nd_diam_slope_F)
```

Create some labels for the slopes
```{r}
nd_diam_slope_F$Morph<-NA
nd_diam_slope_F$isolate<-NA
nd_diam_slope_F$techrep<-NA
nd_diam_slope_F$Peptone<-NA

for(j in seq_along(my_wells)){
  nd_diam_slope_F$Morph[nd_diam_slope_F$SourceWell==my_wells[j]] <- unique(nd_diam_F$Morph[nd_diam_F$SourceWell==my_wells[j]])
  nd_diam_slope_F$isolate[nd_diam_slope_F$SourceWell==my_wells[j]] <- unique(nd_diam_F$isolate[nd_diam_F$SourceWell==my_wells[j]])
  nd_diam_slope_F$techrep[nd_diam_slope_F$SourceWell==my_wells[j]] <- unique(nd_diam_F$techrep[nd_diam_F$SourceWell==my_wells[j]])
  nd_diam_slope_F$Peptone[nd_diam_slope_F$SourceWell==my_wells[j]] <- unique(nd_diam_F$Peptone[nd_diam_F$SourceWell==my_wells[j]])
  }
```

Add days:
```{r}
nd_diam_slope_F<- nd_diam_slope_F %>%
  mutate(days=hours/24)
nd_diam_slope_F<-nd_diam_slope_F %>%
    mutate(Morph=recode(Morph, "a"="Alternate", "o"="Original")) # recode labels
```


Plot out slopes:
```{r}
p_nd_diam_slope_F<-nd_diam_slope_F %>%
  ggplot(aes(x=days, y=slope, color=Morph, shape=factor(isolate)))+
    geom_jitter(size=2, width=0.02) +
  theme_light()+
    scale_color_manual(values=c("red2", "darkblue")) +
  labs(title="Nutrient Concentration", 
       x="Time (Days)", y="Expansion (cm) per Hour", color="Morph", shape="Isolate") +
  theme(text = element_text(size = xTextSize)) +
  facet_wrap(~Peptone, ncol=3)
p_nd_diam_slope_F
```
Expansion rate of the original morphs spikes then drops after about 24 hours in low and high peptone but not in the medium peptone condition. Whereas expansion of the alternate morphs is nearly flat across conditions - the high-peptone colonies started larger (as of 17h) but didn't really expand any faster from there.

Plot with log fits
```{r}
p_nd_diam_slope_F_lmlines_log<-nd_diam_slope_F %>%
  ggplot(aes(x=days, y=slope, color=Morph))+
    geom_jitter(size=2, width=0.02) +
  geom_smooth(method="lm", formula = y ~ log(x), fill="NA")+
  theme_light()+
    scale_color_manual(values=c("red2", "darkblue")) +
  labs(title="", x="Time (Days)", y="Expansion (cm) per Hour", color="Morph") +
  theme(text = element_text(size = xTextSize)) +
  facet_wrap(~Peptone, ncol=3)
p_nd_diam_slope_F_lmlines_log
```


Summarize the data (across technical replicates)
```{r}
nd_diam_summary_F <- nd_diam_F %>%
  group_by(Peptone, Morph, Pass, isolate, days) %>% #pick what you want to summarize
  summarize(min = min(Diameter), 
            max = max(Diameter), #saying what we want to summarize, stats and data
            mean = mean(Diameter), 
            q1= quantile(Diameter, probs = 0.25), 
            median = median(Diameter), 
            q3= quantile(Diameter, probs = 0.75),
            sd = sd(Diameter)) %>%
  mutate_if(is.numeric, round, digits=2) #values, if something is numeric, round to 2 decimals

View(nd_diam_summary_F)
```

Plot out together:
```{r}
plot_grid(p_nd_diam_F_lmlines, p_nd_diam_slope_F_lmlines_log, align="v", ncol=1, labels="AUTO")
ggsave("pNutrientColonyDiameter_F_lmlines.png", width=8, height=8, units="in", dpi=400)
```
and without lines
```{r}
plot_grid(p_nd_diam_F, p_nd_diam_slope_F, align="v", ncol=1, labels="AUTO")
ggsave("pNutrientColonyDiameter_F.png", width=8, height=8, units="in", dpi=400)
```

#### Community A data
Also pass 6, this time with ancestor and with some extra dilutions. Rows E-G are 10X serial dilutions of the corresponding wells in row A.

First, read in data:
```{r}
nd_diam_A <- read_excel("swarm assay all.xlsx", sheet = "nutrientA")
view(nd_diam_A)
```

Clean up:
```{r}
nd_diam_A<-nd_diam_A %>%
  mutate(Morph=replace(Morph, Community=="ANC", "o")) %>% # ..that WT is original morph
  mutate(Pass=replace(Pass, Community=="ANC", 0)) # and is passage 0
nd_diam_A<-nd_diam_A %>%
  mutate(Morph=recode(Morph, "a"="Alternate", "o"="Original")) # recode labels
```


Data are already in a ggplot-usable format, no need to modify. Let's go ahead and plot:
```{r}
p_nd_diam_A<-nd_diam_A %>%
  filter(Dilution == 0) %>% # only the regular dilution data
  ggplot(aes(x=hours, y=Diameter, color=Morph, shape=factor(isolate))) +
  geom_point(size=2) +
  #geom_smooth(method = "lm", fill = NA)+
  theme_light()+
    scale_color_manual(values=c("red2", "darkblue")) +
  labs(title="Peptone Concentration", 
       x="Time (h)", y="Diameter", color="Morph", shape="Isolate") +
  theme(text = element_text(size = 14)) +
  facet_wrap(~Peptone, ncol=3)
p_nd_diam_A
```
Clearly, all isolates and replicates within a given morph are behaving similarly. Interestingly, the standard NGM peptone concentration (1X) seems to allow larger diameters than either the low or high peptone condition, but only for the original isolates.

let's get some log-linear fits.
```{r}
p_nd_diam_A_lmlines<-nd_diam_A %>%
  filter(Dilution == 0) %>% # only the regular dilution data
  ggplot(aes(x=hours, y=Diameter, color=Morph)) +
  geom_point(size=2) +
    scale_color_manual(values=c("red2", "darkblue")) +
  #geom_smooth(method = "lm", fill = NA)+
  geom_smooth(method="lm", formula = y ~ log(x), fill="NA")+
  theme_light()+
  labs(title="Peptone Concentration", 
       x="Time (h)", y="Diameter", color="Morph") +
  theme(text = element_text(size = 14)) +
  facet_wrap(~Peptone, ncol=3)
p_nd_diam_A_lmlines
```

Can we get slopes between time points? First let's make a unique ID:
```{r}
nd_diam_A <- nd_diam_A %>%
  unite("ID", c(SourceWell, Peptone, Dilution), remove=FALSE) # create an ID by merging features
#View(nd_diam_A)
unique(nd_diam_A$ID)
```

Using this ID we can trace individual replicates over time points. 
```{r}
my_times<-unique(nd_diam_A$hours)
my_times
```
Set up a data object to keep the values:
```{r}
my_wells<-unique(nd_diam_A$ID)
my_len<-length(my_wells)
nd_diam_slope_A<-tibble(ID=rep(my_wells,times=4), 
                      hours=c(rep(my_times[2], my_len),
                              rep(my_times[3], my_len),
                              rep(my_times[4], my_len),
                              rep(my_times[5], my_len)),
                      slope=NA)
#view(nd_diam_slope_A)
```

And set up a loop to go across wells and get the slope of the diameter between time points of the same plate.
```{r}
for(i in 2:5){
  for(j in seq_along(my_wells)){
    if(my_times[i]==68 & substr(my_wells[j],1,1)=="B"){ # B wells drop out after 48h
    nd_diam_slope_A$slope[nd_diam_slope_A$hours==my_times[i] & 
                            nd_diam_slope_A$ID == my_wells[j]] <- NA} 
    else{  
    my_slope<-(nd_diam_A$Diameter[nd_diam_A$hours==my_times[i] & 
                                    nd_diam_A$ID == my_wells[j]] - 
                 nd_diam_A$Diameter[nd_diam_A$hours==my_times[i-1] & 
                                      nd_diam_A$ID == my_wells[j]])/(my_times[i] - my_times[i-1])
    nd_diam_slope_A$slope[nd_diam_slope_A$hours==my_times[i] & 
                            nd_diam_slope_A$ID == my_wells[j]] <- my_slope
    }
  }
}

```

Check
```{r}
view(nd_diam_slope_A)
```

Create some labels for the slopes
```{r}
nd_diam_slope_A$Morph<-NA
nd_diam_slope_A$isolate<-NA
nd_diam_slope_A$techrep<-NA
nd_diam_slope_A$Peptone<-NA
nd_diam_slope_A$Dilution<-NA

for(j in seq_along(my_wells)){
  nd_diam_slope_A$Morph[nd_diam_slope_A$ID==my_wells[j]] <- 
    unique(nd_diam_A$Morph[nd_diam_slope_A$ID==my_wells[j]])
  nd_diam_slope_A$isolate[nd_diam_slope_A$ID==my_wells[j]] <- 
    unique(nd_diam_A$isolate[nd_diam_slope_A$ID==my_wells[j]])
  nd_diam_slope_A$techrep[nd_diam_slope_A$ID==my_wells[j]] <-
    unique(nd_diam_A$techrep[nd_diam_slope_A$ID==my_wells[j]])
  nd_diam_slope_A$Peptone[nd_diam_slope_A$ID==my_wells[j]] <-
    unique(nd_diam_A$Peptone[nd_diam_slope_A$ID==my_wells[j]])
    nd_diam_slope_A$Dilution[nd_diam_slope_A$ID==my_wells[j]] <- 
    unique(nd_diam_A$Dilution[nd_diam_slope_A$ID==my_wells[j]])

}
nd_diam_slope_A$SourceWell<-substr(nd_diam_slope_A$ID,1,2)
```

Add days:
```{r}
nd_diam_slope_A<- nd_diam_slope_A %>%
  mutate(days=hours/24)
```

Remove the NAs:
```{r}
nd_diam_slope_A<-nd_diam_slope_A[complete.cases(nd_diam_slope_A),]
```

And disallow negative slopes, as these presumably are measurement error:
```{r}
idx<-which(nd_diam_slope_A$slope<0)
nd_diam_slope_A$slope[idx]<-0
```

Plot out slopes:
```{r}
p_nd_diam_slope_A<-nd_diam_slope_A %>%
  filter(Dilution==0) %>% # just the regular stuff first
    mutate(Morph=recode(Morph, "a"="Alternate", "o"="Original")) %>% # recode labels
  ggplot(aes(x=hours, y=slope, color=Morph, shape=factor(isolate)))+
    geom_jitter(size=2, width=0.02) +
  theme_light()+
    scale_color_manual(values=c("red2", "darkblue")) +
  labs(title="Peptone Concentration", 
       x="Time (h)", y="Expansion (cm) per Hour", color="Morph", shape="Isolate") +
  theme(text = element_text(size = xTextSize)) +
  facet_wrap(~Peptone, ncol=3)
p_nd_diam_slope_A
```

Log fits
```{r}
p_nd_diam_slope_A_lmlines_log<-nd_diam_slope_A %>%
  filter(Dilution==0) %>% # just the regular stuff first
  ggplot(aes(x=hours, y=slope, color=Morph))+
    geom_jitter(size=2, width=0.02) +
  geom_smooth(method="lm", formula = y ~ log(x), fill="NA")+
  theme_light()+
    scale_color_manual(values=c("red2", "darkblue")) +
  labs(title="", x="Time (h)", y="Expansion (cm) per Hour", color="Morph") +
  theme(text = element_text(size = xTextSize)) +
  facet_wrap(~Peptone, ncol=3)
p_nd_diam_slope_A_lmlines_log
```

What happens with dilution of the original inoculum?
```{r}
nd_diam_A %>%
  filter(Dilution!=0) %>%
    ggplot(aes(x=hours, y=Diameter, color=Morph))+
    geom_jitter(size=2, width=0.02)+
    theme_light()+
    scale_color_manual(values=c("red2", "darkblue")) +
  labs(title="Inoculum Dilution", x="Time (h)", y="Diameter (cm)", color="Morph") +
  facet_wrap(~Dilution)
  
```
How about the other way around
```{r}
well_list=c("A1", "A4", "A7",
            "E1", "E4", "E7",
            "F1", "F4", "F7",
            "G1", "G4", "G7")
pDilutionDiameterA<-nd_diam_A %>%
  filter(SourceWell %in% well_list) %>%
    mutate(Morph=recode(Morph, "a"="Alternate", "o"="Original")) %>% # recode labels
    ggplot(aes(x=hours, y=Diameter, color=factor(Dilution)))+
    geom_jitter(size=2, width=0.02)+
    theme_light()+
  labs(title="", x="Time (h)", y="Diameter (cm)", color="Dilution") +
  facet_grid(vars(Morph), vars(Peptone))
pDilutionDiameterA
```

What happens when we change dilution of the inoculum? With log fits:
```{r}
pDilutionDiameterA_lmlines<-nd_diam_A %>%
  filter(SourceWell %in% well_list) %>%
    mutate(Morph=recode(Morph, "a"="Alternate", "o"="Original")) %>% # recode labels
    ggplot(aes(x=hours, y=Diameter, color=factor(Dilution)))+
    geom_jitter(size=2, width=0.02)+
    theme_light()+
  geom_smooth(method="lm", formula = y ~ log(x), fill="NA")+
    theme(text = element_text(size = xTextSize)) +
  labs(title="", x="Time (h)", y="Diameter (cm)", color="Dilution") +
  facet_grid(vars(Morph), vars(Peptone))
pDilutionDiameterA_lmlines
```

Spreading rates?
```{r}
p_nd_diam_slope_A_lmlines_log_dilution<-nd_diam_slope_A %>%
  filter(SourceWell %in% well_list) %>%
  mutate(Morph=recode(Morph, "a"="Alternate", "o"="Original")) %>% # recode labels
  ggplot(aes(x=hours, y=slope, color=factor(Dilution)))+
    geom_jitter(size=2, width=0.02) +
  geom_smooth(method="lm", formula = y ~ log(x), fill="NA")+
  theme_light()+
  ylim(-0.05, 0.15)+
  labs(title="", x="Time (h)", y="Expansion (cm) per Hour", color="Dilution") +
  theme(text = element_text(size = xTextSize)) +
  facet_grid(vars(Peptone), vars(Morph))
p_nd_diam_slope_A_lmlines_log_dilution
```
Reverse the axes?
```{r}
p_nd_diam_slope_A_lmlines_log_dilution_flip<-nd_diam_slope_A %>%
  filter(SourceWell %in% well_list) %>%
  mutate(Morph=recode(Morph, "a"="Alternate", "o"="Original")) %>% # recode labels
  ggplot(aes(x=hours, y=slope, color=factor(Dilution)))+
    geom_jitter(size=2, width=0.02) +
  geom_smooth(method="lm", formula = y ~ log(x), fill="NA")+
  theme_light()+
  ylim(-0.05, 0.15)+
  labs(title="", x="Time (h)", y="Expansion (cm) per Hour", color="Dilution") +
  theme(text = element_text(size = xTextSize)) +
  facet_grid(vars(Morph), vars(Peptone), scales="free_y")
p_nd_diam_slope_A_lmlines_log_dilution_flip
```



Summarize the data (across technical replicates)
```{r}
nd_diam_summary_A <- nd_diam_A %>%
  filter(Dilution==0) %>% # just the regular stuff, others don't have replicates
  group_by(Peptone, Morph, Pass, isolate, days) %>% #pick what you want to summarize
  summarize(min = min(Diameter), 
            max = max(Diameter), #saying what we want to summarize, stats and data
            mean = mean(Diameter), 
            q1= quantile(Diameter, probs = 0.25), 
            median = median(Diameter), 
            q3= quantile(Diameter, probs = 0.75),
            sd = sd(Diameter)) %>%
  mutate_if(is.numeric, round, digits=2) #values, if something is numeric, round to 2 decimals

View(nd_diam_summary_A)
```

Plot out together:
```{r}
plot_grid(p_nd_diam_A_lmlines, p_nd_diam_slope_A_lmlines_log, align="v", ncol=1, labels="AUTO")
ggsave("pNutrientColonyDiameter_A_lmlines.png", width=8, height=8, units="in", dpi=400)
```
and the dilutions
```{r}
plot_grid(pDilutionDiameterA_lmlines,
          p_nd_diam_slope_A_lmlines_log_dilution, 
         ncol=1, labels="AUTO")
ggsave("pNutrientColonyDiameter_Dilutions_A.png", width=8, height=8, units="in", dpi=400)
```

#### Combining the data
Let's put the F2 and A2 nutrient data sets together
```{r}
temp1<-nd_diam_A %>%
      filter(Dilution==0) %>% # just the dilution 0 data for comparability
  dplyr::select(days, hours, Strain, Peptone, Community, Morph, ID, Pass, isolate, techrep, Diameter)

temp2<-nd_diam_F %>%
    dplyr::select(days, hours, Strain, Peptone, Community, Morph, ID, Pass, isolate, techrep, Diameter)
nd_diam<-rbind(temp1, temp2)  
rm(temp1, temp2)
```

Plot out together?
```{r}
nd_diam$Community<-factor(nd_diam$Community,
                          levels=c("ANC", "A2", "F2"))

p_nd_diam_lmlines_log<-nd_diam %>%
  ggplot(aes(x=hours, y=Diameter, color=Morph))+
    geom_jitter(size=2, width=0.02) +
  geom_smooth(method="lm", formula = y ~ log(x), fill="NA")+
  theme_light()+
    scale_color_manual(values=c("red2", "darkblue")) +
  labs(title="", x="Time (h)", y="Diameter (cm)", color="Morph") +
  theme(text = element_text(size = xTextSize)) +
  facet_grid(vars(Peptone), vars(Community), scales="free_x")
p_nd_diam_lmlines_log
```
Can I get these on a more condensed plot?
```{r}
p_nd_diam_lmlines_log_short<-nd_diam %>%
  ggplot(aes(x=hours, y=Diameter, color=Morph, linetype=factor(Peptone)))+
    geom_jitter(size=2, width=0.02) +
  geom_smooth(method="lm", formula = y ~ log(x), fill="NA")+
  theme_light()+
    scale_color_manual(values=c("red2", "darkblue")) +
    scale_linetype_manual(values=c("solid", "dashed", "dotted"))+
  labs(title="", x="Time (h)", y="Diameter (cm)", 
       color="Morph", linetype="Peptone") +
  theme(text = element_text(size = xTextSize)) +
  facet_wrap(~Community, scales="free_x")
p_nd_diam_lmlines_log_short
```

And the slopes
```{r}
temp1<-nd_diam_slope_A %>%
  filter(Dilution==0) %>% # just the regular stuff first
  dplyr::select(hours, slope, Morph, isolate, techrep, Peptone) %>%
  mutate(Community="A2")
temp2<-nd_diam_slope_F %>%
  dplyr::select(hours, slope, Morph, isolate, techrep, Peptone) %>%
  mutate(Community="F2")
nd_diam_slope<-rbind(temp1, temp2)
rm(temp1, temp2)
```


Plot out the slope data
```{r}
p_nd_diam_slope_lmlines_log<-nd_diam_slope %>%
  ggplot(aes(x=hours, y=slope, color=Morph))+
    geom_jitter(size=2, width=0.02) +
  geom_smooth(method="lm", formula = y ~ log(x), fill="NA")+
  theme_light()+
    scale_color_manual(values=c("red2", "darkblue")) +
  labs(title="", x="Time (h)", y="Expansion (cm) per Hour", color="Morph") +
  theme(text = element_text(size = xTextSize)) +
  facet_grid(vars(Peptone), vars(Community), scales="free_x")
p_nd_diam_slope_lmlines_log
```
Condensed:
```{r}
p_nd_diam_slope_lmlines_log_short<-nd_diam_slope %>%
  ggplot(aes(x=hours, y=slope, color=Morph, linetype=factor(Peptone)))+
    geom_jitter(size=2, width=0.02) +
  geom_smooth(method="lm", formula = y ~ log(x), fill="NA")+
  theme_light()+
    scale_color_manual(values=c("red2", "darkblue")) +
  scale_linetype_manual(values=c("solid", "dashed", "dotted"))+
  labs(title="", x="Time (h)", y="Expansion (cm/h)", 
       color="Morph", linetype="Peptone") +
  theme(text = element_text(size = xTextSize)) +
  facet_wrap(~Community, scales="free_x")
p_nd_diam_slope_lmlines_log_short
```


And combine the motility data:
```{r}
pNutrientMotility<-plot_grid(p_nd_diam_lmlines_log_short, 
          p_nd_diam_slope_lmlines_log_short,
          pDilutionDiameterA_lmlines + scale_color_brewer(palette = "Dark2"),
          p_nd_diam_slope_A_lmlines_log_dilution_flip + scale_color_brewer(palette = "Dark2"),
          ncol=1,
          rel_heights=c(1,1,1.5, 1.5),
          labels="AUTO"
          #labels=c("D", "E", "F")
          )
#plot_grid(pCGMotilitySummary,
#         pNutrientMotility,
#          ncol=1
#          )
pNutrientMotility
ggsave("Fig5_NutrientMotility.png", width=8, height=12, units="in", dpi=400)
```


### Growth rates and colony expansion
I also want to know what the relationship is between growth rate in the media and expansion rate on agar surfaces. 

#### Community F pass 6
Read in the growth data for the F6 isolates (5-point rolling average):
```{r}
plate_nutrient <- read_excel("20230518_NV_CG_NGM_25C.xlsx", sheet = "raw")
```

And the labels:
```{r}
my_labels_nutrient<-read_excel("20230518_NV_CG_NGM_25C.xlsx", sheet="Labels", col_names=TRUE)
```

Check the contents briefly:
```{r}
head(plate_nutrient)
```

We'll use growthrates for our fits because I like it better. Convert to long format:
```{r}
plate_nutrient_long<-plate_nutrient %>%
  dplyr::select(-c("A2", "A3", "A4", "A5", "A6", "A7", "A8", "A9", "A10",
            "H2", "H3", "H4", "H5", "H6", "H7", "H8", "H9", "H10")) %>% # remove blanks
  pivot_longer(cols = B2:G10,
               names_to = "sample",
               values_to = "OD600")
glimpse(plate_nutrient_long)
```

Now we can add labels to these objects directly (since growthrates will let us make use of these labels if we want to)
```{r}
plate_nutrient_long<-label96well(plate_nutrient_long, my_labels_nutrient)
str(plate_nutrient_long)
```
Relabel morphs to be consistent with motility data:
```{r}
plate_nutrient_long <- plate_nutrient_long %>%
  mutate(Morph=recode(Morph, "a"="Alternate", "o"="Original")) # recode labels
```


Also need to add the new labels (isolate, technical replicate, and peptone multiplier):
```{r}
plate_nutrient_long <- plate_nutrient_long %>%
  add_column(Isolate=NA, 
             TechRep=NA,
             Peptone=NA)
  
  # Take well IDs
well_list1<-unique(my_labels_nutrient$Well)
  
attach(my_labels_nutrient)

for (i in seq_along(well_list1)){
    idx<-which(plate_nutrient_long$sample==well_list1[i]) # Find indices corresponding to each well
    plate_nutrient_long$Isolate[idx]<-Isolate[i]
    plate_nutrient_long$TechRep[idx]<-TechRep[i]
    plate_nutrient_long$Peptone[idx]<-Peptone[i]
    }
detach(my_labels_nutrient)

str(plate_nutrient_long)
```

We can plot out with ggplot:
```{r}
plate_nutrient_long %>%
  mutate(Peptone=factor(Peptone)) %>%
  mutate(Isolate=factor(Isolate)) %>%
  ggplot(aes(time, OD600)) + 
  geom_point(aes(color=Isolate)) + 
  facet_grid(Peptone ~ Morph)
```
Some bumps remaining, let's see how splines do. I want estimates for each well, so we'll tell growthrates to separate by well:
```{r}
# Single-well fit for illustration, as in the vignette
splitted.data.nutrientplate<-multisplit(plate_nutrient_long, "sample")
dat<-splitted.data.nutrientplate[[1]] # should be the first data set in alphanumeric order (well B10)
dat
```

```{r}
unique(dat$sample)
```

And fit spline to just the well B10 time series:
```{r}
fit.nutrientplate.B10.spline<-fit_spline(dat$time, dat$OD600)
summary(fit.nutrientplate.B10.spline)
```

This is an object; we can take pieces of it (for example, just the parameter estimates):
```{r}
coef(fit.nutrientplate.B10.spline)
```

Plotting can then be done either in log-scale or after re-transformation:
```{r}
par(mfrow = c(1, 2))
plot(fit.nutrientplate.B10.spline, log = "y")
plot(fit.nutrientplate.B10.spline)
```

Not a great fit for some reason. Let's smooth. 
```{r}
fit.nutrientplate.B10.spline_smooth<-fit_spline(dat$time, dat$OD600, spar=0.9)
```

Plot to confirm that the new fit is on adequately smoothed data:
```{r}
par(mfrow = c(1, 2))
plot(fit.nutrientplate.B10.spline_smooth, log = "y")
plot(fit.nutrientplate.B10.spline_smooth)
```

Better. Check the coefficients:
```{r}
coef(fit.nutrientplate.B10.spline_smooth)
```

We can do the same fitting splines to each well across a plate. 
```{r}
plate_nutrient_manyspline<-all_splines(OD600~time | sample, data=plate_nutrient_long, spar=0.95)
par(mfrow=c(7,8))
par(mar = c(2.5, 4, 2, 1))
plot(plate_nutrient_manyspline)
```
Alt morphs are just.. odd. Are they clumping?

Now that we have these fits, let's extract the parameters. 
```{r}
# This gives us a list by well. For splines, we only need to keep max growth rate (mumax) estimates
coef(plate_nutrient_manyspline)
```

The coef() function returns a matrix, which is not what we want. Let's turn this into a data frame:
```{r}
plate_nutrient_manyspline_coef<-as_tibble(coef(plate_nutrient_manyspline), rownames=NA)
str(plate_nutrient_manyspline_coef)
```
Note that it did not bring well labels along for some reason (I think rownames=NA is supposed to retain these, not sure what's wrong); we'll have to retrieve those.
```{r}
# We can get the names from the coef() object
temp<-dimnames(coef(plate_nutrient_manyspline))
temp
temp[[1]]
```
Attach these well IDs to the coefficients:
```{r}
plate_nutrient_manyspline_coef$sample<-temp[[1]]
plate_nutrient_manyspline_coef
```

Now we have all our coefficients and their well labels. Pass these objects back through the labeler to get the meta-data associated with each well, then add the new labels.
```{r}
plate_nutrient_manyspline_coef<-label96well(plate_nutrient_manyspline_coef, my_labels_nutrient)

plate_nutrient_manyspline_coef <- plate_nutrient_manyspline_coef %>%
  add_column(Isolate=NA, 
             TechRep=NA,
             Peptone=NA)
  
  # Take well IDs
well_list1<-unique(my_labels_nutrient$Well)
  
attach(my_labels_nutrient)

for (i in seq_along(well_list1)){
    idx<-which(plate_nutrient_manyspline_coef$sample==well_list1[i]) # Find indices corresponding to each well
    plate_nutrient_manyspline_coef$Isolate[idx]<-Isolate[i]
    plate_nutrient_manyspline_coef$TechRep[idx]<-TechRep[i]
    plate_nutrient_manyspline_coef$Peptone[idx]<-Peptone[i]
    }
detach(my_labels_nutrient)

str(plate_nutrient_manyspline_coef)
```

Now we can plot out:
```{r}
pLVparams_spline_r_box_nutrient<-plate_nutrient_manyspline_coef %>%
  mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=Morph, y=mumax, color=Strain))+
  theme_classic()+
  geom_boxplot()+
  geom_jitter(width=0.1)+
  #geom_hline(yintercept = WTmedian_r_spline, color="black")+
  theme(legend.position = "none",
        text=element_text(size=xTextSize)) +
  labs(x="Morph", y="Max Growth Rate (r)") +
  facet_wrap(~Peptone, ncol=3)
pLVparams_spline_r_box_nutrient + stat_compare_means(label.y=0.19)
```
1X peptone is the only time we get a real growth difference between alternate and original morphs, interestingly.

Let's correlate. We have the colony expansion rate data from above:
```{r}
str(nd_diam_slope_F)
```

I guess we could try is to correlate the max expansion rate or max diameter and the max growth rate? As before, create a unique ID in the growth rate tibble:
```{r}
plate_nutrient_manyspline_coef_F <- plate_nutrient_manyspline_coef %>%
  mutate(Morph=recode(Morph, "a"="Alternate", "o"="Original")) %>% # recode label
  unite("ID", Morph:TechRep, remove=FALSE) # create an ID by merging morph, rep, and techrep
unique(plate_nutrient_manyspline_coef_F$ID)
```
Same as in the diameter slope data?
```{r}
nd_diam_slope_F <- nd_diam_slope_F %>%
  unite("ID", Morph:techrep, remove=FALSE) # create an ID by merging morph, rep, and techrep
unique(nd_diam_slope_F$ID)
```
And in the diameters?
```{r}
unique(nd_diam_F$ID)
```
No, have to fix that one. What are the data?
```{r}
view(nd_diam_F)
```

Make a new one:
```{r}
nd_diam_F<-nd_diam_F %>%
  dplyr::select(-Pass) %>%
  unite("ID2", Morph:techrep, remove=FALSE)
unique(nd_diam_F$ID2)
```

ok, so far so good. Now get the max growth rate (at any time) for each ID and peptone level:
```{r}
my_ids<-unique(nd_diam_slope_F$ID)
my_levels<-unique(nd_diam_slope_F$Peptone)

# Create a tibble to hold the data

nd_diam_slope_rate_F<-tibble(ID=rep(my_ids, times=length(my_levels)),
                           Peptone=NA,
                           spreadrate=NA,
                           mumax=NA,
                           maxdiam=NA)
idx<-1
for (i in seq_along(my_ids)){
  for (j in seq_along(my_levels)){
    nd_diam_slope_rate_F$ID[idx]<-my_ids[i]
    nd_diam_slope_rate_F$Peptone[idx]<-my_levels[j]
    nd_diam_slope_rate_F$spreadrate[idx]<-max(nd_diam_slope_F$slope[nd_diam_slope_F$ID==my_ids[i] & 
                                                             nd_diam_slope_F$Peptone==my_levels[j]])
    nd_diam_slope_rate_F$mumax[idx]<-plate_nutrient_manyspline_coef_F$mumax[plate_nutrient_manyspline_coef_F$ID==my_ids[i] & 
                                                             plate_nutrient_manyspline_coef_F$Peptone==my_levels[j]]
    nd_diam_slope_rate_F$maxdiam[idx]<-max(nd_diam_F$Diameter[nd_diam_F$ID2==my_ids[i] & 
                                                             nd_diam_F$Peptone==my_levels[j]])
    idx<-idx+1
  }
}

```

Check the object:
```{r}
str(nd_diam_slope_rate_F)
```
Separate out morphs:
```{r}
nd_diam_slope_rate_F$Morph<-substr(nd_diam_slope_rate_F$ID, 1, 1)

nd_diam_slope_rate_F<- nd_diam_slope_rate_F %>%
    mutate(Morph=recode(Morph, "A"="Alternate", "O"="Original")) # recode labels
```


Now we can plot:
```{r}
p_diam_rate_F<-nd_diam_slope_rate_F %>%
  mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=mumax, y=maxdiam, color=Peptone)) +
  geom_jitter(size=2, width=0.02)+
  theme_light()+
  theme(text=element_text(size=xTextSize)) +
  labs(x="Max Growth Rate (r)", y="Max Diameter") +
  facet_wrap(~Morph, ncol=2)
p_diam_rate_F
```

```{r}
p_spreadrate_rate_F<-nd_diam_slope_rate_F %>%
   mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=mumax, y=spreadrate, color=Peptone)) +
  geom_jitter(size=2, width=0.02)+
  theme_light()+
  theme(text=element_text(size=xTextSize)) +
  labs(x="Max Growth Rate (r)", y="Max Spread Rate") +
  facet_wrap(~Morph, ncol=2)
p_spreadrate_rate_F
```

Linear fits to these data, or first:
```{r}
nd_rate_temp_F<-nd_diam_slope_rate_F %>%
  filter(Morph=="Original")
lm_nd_diam_slope_rate_ORI_F<-lm(maxdiam~mumax, data=nd_rate_temp_F)
summary(lm_nd_diam_slope_rate_ORI_F)

nd_rate_temp_F<-nd_diam_slope_rate_F %>%
  filter(Morph=="Original")
lm_nd_diam_slope_rate_ORI_F<-lm(spreadrate~mumax, data=nd_rate_temp_F)
summary(lm_nd_diam_slope_rate_ORI_F)
```


And alternate morphs:
```{r}
nd_rate_temp_F<-nd_diam_slope_rate_F %>%
  filter(Morph=="Alternate")
lm_nd_diam_slope_rate_ALT_F<-lm(maxdiam~mumax, data=nd_rate_temp_F)
summary(lm_nd_diam_slope_rate_ALT_F)

nd_rate_temp_F<-nd_diam_slope_rate_F %>%
  filter(Morph=="Alternate")
lm_nd_diam_slope_rate_ALT_F<-lm(spreadrate~mumax, data=nd_rate_temp_F)
summary(lm_nd_diam_slope_rate_ALT_F)
```


So, no. How about carrying capacity? Let's fit the logistic:
```{r}
p     <- c(y0 = 0.01, mumax = 0.1, K = 0.5)
lower <- c(y0 = 1e-6, mumax = 0,   K = 0)
upper <- c(y0 = 0.05, mumax = 5,   K = 1.5)

many_logistic_nutrient_F <- all_growthmodels(OD600 ~ grow_logistic(time, parms) | sample, data= plate_nutrient_long, 
                                           p = p, lower = lower, upper = upper, transform = "log")
par(mfrow=c(7,8))
par(mar = c(2.5, 4, 2, 1))
plot(many_logistic_nutrient_F)
```
Coefficients:
```{r}
coef(many_logistic_nutrient_F)
```


Add these to the object:
```{r}
# Create a tibble
many_logistic_nutrient_coef_F<-as_tibble(coef(many_logistic_nutrient_F), rownames=NA)
#str(many_logistic_nutrient_coef)

# Add the well IDs
# We can get the names from the coef() object
temp<-dimnames(coef(many_logistic_nutrient_F))
#temp
temp[[1]]
many_logistic_nutrient_coef_F$sample<-temp[[1]]
str(many_logistic_nutrient_coef_F)
```

Now we have all our coefficients and their well labels. Pass these objects back through the labeler to get the meta-data associated with each well, then add the new labels.
```{r}
many_logistic_nutrient_coef_F<-label96well(many_logistic_nutrient_coef_F, my_labels_nutrient)

many_logistic_nutrient_coef_F <- many_logistic_nutrient_coef_F %>%
  add_column(Isolate=NA, 
             TechRep=NA,
             Peptone=NA)
  
  # Take well IDs
well_list1<-unique(my_labels_nutrient$Well)
  
attach(my_labels_nutrient)

for (i in seq_along(well_list1)){
    idx<-which(many_logistic_nutrient_coef_F$sample==well_list1[i]) # Find indices corresponding to each well
    many_logistic_nutrient_coef_F$Isolate[idx]<-Isolate[i]
    many_logistic_nutrient_coef_F$TechRep[idx]<-TechRep[i]
    many_logistic_nutrient_coef_F$Peptone[idx]<-Peptone[i]
    }
detach(my_labels_nutrient)

str(many_logistic_nutrient_coef_F)
```

Relabel:
```{r}
many_logistic_nutrient_coef_F<- many_logistic_nutrient_coef_F %>%
    mutate(Morph=recode(Morph, "a"="Alternate", "o"="Original")) # recode labels
```


Now we can plot out:
```{r}
pmanyparams_K_box_nutrient_F<-many_logistic_nutrient_coef_F %>%
  mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=Morph, y=K, color=Strain))+
  theme_classic()+
  geom_boxplot()+
  geom_jitter(width=0.1)+
  #geom_hline(yintercept = WTmedian_r_spline, color="black")+
  theme(legend.position = "none",
        text=element_text(size=xTextSize)) +
  labs(x="Morph", y="Carrying Capacity (OD600)") +
  facet_wrap(~Peptone, ncol=3)
pmanyparams_K_box_nutrient_F + stat_compare_means()
```

Add these to the rest of the parameter data. As before, create a unique ID in the growth rate tibble:
```{r}
many_logistic_nutrient_coef_F <- many_logistic_nutrient_coef_F %>%
  unite("ID", Morph:TechRep, remove=FALSE) # create an ID by merging morph, rep, and techrep
unique(many_logistic_nutrient_coef_F$ID)
```

Are these in the same order or...
```{r}
nd_diam_slope_rate_F$ID
many_logistic_nutrient_coef_F$ID
```
Nope, have to find.
```{r}
nd_diam_slope_rate_F$K<-NA

my_len<-dim(nd_diam_slope_rate_F)[1]
for (i in seq_len(my_len)){
  my_id<-nd_diam_slope_rate_F$ID[i]
  my_level<-nd_diam_slope_rate_F$Peptone[i]
  nd_diam_slope_rate_F$K[i]<-many_logistic_nutrient_coef_F$K[many_logistic_nutrient_coef_F$ID==my_id & 
                                     many_logistic_nutrient_coef_F$Peptone==my_level]
}
str(nd_diam_slope_rate_F)
```

And plot K vs diameter:
```{r}
p_diam_K_F<-nd_diam_slope_rate_F %>%
  mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=K, y=maxdiam, color=Peptone)) +
  geom_jitter(size=2, width=0.02)+
  #geom_smooth(method="lm", fill="NA")+
  theme_light()+
  theme(text=element_text(size=xTextSize)) +
  labs(x="K (OD600)", y="Max Diameter") +
  facet_wrap(~Morph, ncol=2)
p_diam_K_F
```
Fit linear models myself (geom_smooth wants to fit each peptone group by itself)
```{r}
nd_rate_temp_F<-nd_diam_slope_rate_F %>%
  filter(Morph=="Original")
lm_nd_diam_slope_rate_ORI_F<-lm(maxdiam~K, data=nd_rate_temp_F)
summary(lm_nd_diam_slope_rate_ORI_F)
```
and for alt morphs
```{r}
nd_rate_temp_F<-nd_diam_slope_rate_F %>%
  filter(Morph=="Alternate")
lm_nd_diam_slope_rate_ALT_F<-lm(maxdiam~K, data=nd_rate_temp_F)
summary(lm_nd_diam_slope_rate_ALT_F)
```


And vs spreading rate:
```{r}
p_spreadrate_K_F<-nd_diam_slope_rate_F %>%
   mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=K, y=spreadrate, color=Peptone)) +
  geom_jitter(size=2, width=0.02)+
  theme_light()+
  theme(text=element_text(size=xTextSize)) +
  labs(x="K (OD600)", y="Max Spread Rate") +
  facet_wrap(~Morph, ncol=2)
p_spreadrate_K_F
```

And linear fits, first ORI:
```{r}
nd_rate_temp_F<-nd_diam_slope_rate_F %>%
  filter(Morph=="Original")
lm_nd_diam_slope_rate_ORI<-lm(spreadrate~K, data=nd_rate_temp_F)
summary(lm_nd_diam_slope_rate_ORI_F)
```

Then alt:
```{r}
nd_rate_temp_F<-nd_diam_slope_rate_F %>%
  filter(Morph=="Alternate")
lm_nd_diam_slope_rate_ALT<-lm(spreadrate~K, data=nd_rate_temp_F)
summary(lm_nd_diam_slope_rate_ALT_F)
```


Let's assemble the figures. First the raw data:
```{r}
plot_grid(p_nd_diam_F, p_nd_diam_slope_F, ncol=1, labels="AUTO")
ggsave("pNutrientColonyDiameter_F.png", width=8, height=8, units="in", dpi=300)
```

Then the rates:
```{r}
plot_grid(pLVparams_spline_r_box_nutrient + stat_compare_means(label.y=0.19), 
          p_diam_rate, p_spreadrate_rate,
          ncol=1, labels="AUTO")
ggsave("pDiameterRates.png", width=8, height=10, units="in", dpi=300)
```

Same for K:
```{r}
plot_grid(pmanyparams_K_box_nutrient + stat_compare_means(label.y=1.1), 
          p_diam_K, p_spreadrate_K,
          ncol=1, labels="AUTO")
ggsave("pDiameterVsK.png", width=8, height=10, units="in", dpi=300)
```


#### Community A pass 6
Read in the growth data for the F6 isolates (5-point rolling average):
```{r}
plate_nutrient_A <- read_excel("20230724_NV_CG_NGM_25C.xlsx", sheet = "raw")
```

And the labels:
```{r}
my_labels_nutrient_A<-read_excel("20230724_NV_CG_NGM_25C.xlsx", sheet="Labels", col_names=TRUE)
```

Check the contents briefly:
```{r}
head(plate_nutrient_A)
```

We'll use growthrates for our fits because I like it better. Convert to long format:
```{r}
plate_nutrient_long_A<-plate_nutrient_A %>%
  dplyr::select(-c("A2", "A3", "A4", "A5", "A6", "A7", "A8", "A9", "A10",
            "H2", "H3", "H4", "H5", "H6", "H7", "H8", "H9", "H10")) %>% # remove blanks
  pivot_longer(cols = B2:G11,
               names_to = "sample",
               values_to = "OD600")
glimpse(plate_nutrient_long_A)
```

Now we can add labels to these objects directly (since growthrates will let us make use of these labels if we want to)
```{r}
plate_nutrient_long_A<-label96well(plate_nutrient_long_A, my_labels_nutrient_A)
str(plate_nutrient_long_A)
```

Also need to add the new labels (isolate, technical replicate, and peptone multiplier):
```{r}
plate_nutrient_long_A <- plate_nutrient_long_A %>%
  add_column(Isolate=NA, 
             TechRep=NA,
             Peptone=NA)
  
  # Take well IDs
well_list1<-unique(my_labels_nutrient_A$Well)
  
attach(my_labels_nutrient_A)

for (i in seq_along(well_list1)){
    idx<-which(plate_nutrient_long_A$sample==well_list1[i]) # Find indices corresponding to each well
    plate_nutrient_long_A$Isolate[idx]<-Isolate[i]
    plate_nutrient_long_A$TechRep[idx]<-TechRep[i]
    plate_nutrient_long_A$Peptone[idx]<-Peptone[i]
    }
detach(my_labels_nutrient_A)

str(plate_nutrient_long_A)
```

We can plot out with ggplot:
```{r}
plate_nutrient_long_A %>%
  mutate(Peptone=factor(Peptone)) %>%
  mutate(Isolate=factor(Isolate)) %>%
  ggplot(aes(time, OD600)) + 
  geom_point(aes(color=Isolate)) + 
  facet_grid(Peptone ~ Morph)
```

Fit splines to each well. 
```{r}
plate_nutrient_manyspline_A<-all_splines(OD600~time | sample, data=plate_nutrient_long_A, spar=0.95)
par(mfrow=c(8,8))
par(mar = c(2.5, 2, 1, 1))
plot(plate_nutrient_manyspline_A)
```

Now that we have these fits, let's extract the parameters. 
```{r}
# This gives us a list by well. For splines, we only need to keep max growth rate (mumax) estimates
coef(plate_nutrient_manyspline_A)
```

The coef() function returns a matrix, which is not what we want. Let's turn this into a data frame:
```{r}
plate_nutrient_manyspline_coef_A<-as_tibble(coef(plate_nutrient_manyspline_A), rownames=NA)
str(plate_nutrient_manyspline_coef_A)
```

Retrieve well labels:
```{r}
# We can get the names from the coef() object
temp<-dimnames(coef(plate_nutrient_manyspline_A))
temp
temp[[1]]
```
Attach these well IDs to the coefficients:
```{r}
plate_nutrient_manyspline_coef_A$sample<-temp[[1]]
plate_nutrient_manyspline_coef_A
```

Now we have all our coefficients and their well labels. Pass these objects back through the labeler to get the meta-data associated with each well, then add the new labels.
```{r}
plate_nutrient_manyspline_coef_A<-label96well(plate_nutrient_manyspline_coef_A, my_labels_nutrient_A)

plate_nutrient_manyspline_coef_A <- plate_nutrient_manyspline_coef_A %>%
  add_column(Isolate=NA, 
             TechRep=NA,
             Peptone=NA)
  
  # Take well IDs
well_list1<-unique(my_labels_nutrient_A$Well)
  
attach(my_labels_nutrient_A)

for (i in seq_along(well_list1)){
    idx<-which(plate_nutrient_manyspline_coef_A$sample==well_list1[i]) # Find indices corresponding to each well
    plate_nutrient_manyspline_coef_A$Isolate[idx]<-Isolate[i]
    plate_nutrient_manyspline_coef_A$TechRep[idx]<-TechRep[i]
    plate_nutrient_manyspline_coef_A$Peptone[idx]<-Peptone[i]
    }
detach(my_labels_nutrient_A)

str(plate_nutrient_manyspline_coef_A)
```

Now we can plot out:
```{r}
pLVparams_spline_r_box_nutrient_A<-plate_nutrient_manyspline_coef_A %>%
#  filter(Pass!=0) %>% # leave out the ancestor
  mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=Morph, y=mumax, color=Strain))+
  theme_classic()+
  geom_boxplot()+
  geom_jitter(width=0.1)+
  #geom_hline(yintercept = WTmedian_r_spline, color="black")+
  theme(legend.position = "none",
        text=element_text(size=xTextSize)) +
  labs(x="Morph", y="Max Growth Rate (r)") +
  facet_wrap(~Peptone, ncol=3)
pLVparams_spline_r_box_nutrient_A + stat_compare_means(label.y=0.19)
```
For these isolates we get a difference in 0.2X and in 1X.

Let's correlate. We have the colony expansion rate data from above:
```{r}
str(nd_diam_slope_A)
```

Correlate the max expansion rate or max diameter and the max growth rate? As before, create a unique ID in the growth rate tibble. We don't have enough ancestral data for growth, so we'll remove the single replicate.
```{r}
plate_nutrient_manyspline_coef_A_6 <- plate_nutrient_manyspline_coef_A %>%
  dplyr::filter(Morph!="Ancestor") %>%
  unite("ID", Morph:TechRep, remove=FALSE) # create an ID by merging morph, rep, and techrep
unique(plate_nutrient_manyspline_coef_A_6$ID)
```

Same as in the diameter slope data?
```{r}
nd_diam_slope_A <- nd_diam_slope_A %>%
  unite("ID", Morph:techrep, remove=FALSE) # create an ID by merging morph, rep, and techrep
unique(nd_diam_slope_A$ID)
```
And in the diameters?
```{r}
unique(nd_diam_A$ID)
```
No, have to fix that one. What are the data?
```{r}
view(nd_diam_A)
```

Make a new one:
```{r}
nd_diam_A<-nd_diam_A %>%
  dplyr::select(-Pass) %>%
  unite("ID2", Morph:techrep, remove=FALSE)
unique(nd_diam_A$ID2)
```

ok, so far so good. Now get the max growth rate (at any time) for each ID and peptone level:
```{r}
my_ids<-unique(nd_diam_slope_A$ID)
my_levels<-unique(nd_diam_slope_A$Peptone)

# Create a tibble to hold the data

nd_diam_slope_rate_A<-tibble(ID=rep(my_ids, times=length(my_levels)),
                           Peptone=NA,
                           spreadrate=NA,
                           mumax=NA,
                           maxdiam=NA)
idx<-1
for (i in seq_along(my_ids)){
  for (j in seq_along(my_levels)){
    nd_diam_slope_rate_A$ID[idx]<-my_ids[i]
    nd_diam_slope_rate_A$Peptone[idx]<-my_levels[j]
    nd_diam_slope_rate_A$spreadrate[idx]<-max(nd_diam_slope_A$slope[nd_diam_slope_A$ID==my_ids[i] & 
                                                             nd_diam_slope_A$Peptone==my_levels[j]])
    nd_diam_slope_rate_A$maxdiam[idx]<-max(nd_diam_A$Diameter[nd_diam_A$ID2==my_ids[i] & 
                                                             nd_diam_A$Peptone==my_levels[j]])
#    if(sum(plate_nutrient_manyspline_coef_A$ID==my_ids[i]) >0){    

      nd_diam_slope_rate_A$mumax[idx]<-
      plate_nutrient_manyspline_coef_A_6$mumax[plate_nutrient_manyspline_coef_A_6$ID==my_ids[i] &                                                        plate_nutrient_manyspline_coef_A_6$Peptone==my_levels[j]]
 #     }
    idx<-idx+1
  }
}

```

Check the object:
```{r}
str(nd_diam_slope_rate_A)
View(nd_diam_slope_rate_A)
```
Separate out morphs:
```{r}
nd_diam_slope_rate_A$Morph<-substr(nd_diam_slope_rate_A$ID, 1, 1)
nd_diam_slope_rate_A<-nd_diam_slope_rate_A %>%
   mutate(Morph=recode(Morph, "A"="Alternate", "O"="Original"))
```

Now we can plot:
```{r}
p_diam_rate_A<-nd_diam_slope_rate_A %>%
  mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=mumax, y=maxdiam, color=Peptone)) +
  geom_jitter(size=2, width=0.02)+
  theme_light()+
  theme(text=element_text(size=xTextSize)) +
  labs(x="Max Growth Rate (r)", y="Max Diameter") +
  facet_wrap(~Morph, ncol=2)
p_diam_rate_A
```

```{r}
p_spreadrate_rate_A<-nd_diam_slope_rate_A %>%
   mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=mumax, y=spreadrate, color=Peptone)) +
  geom_jitter(size=2, width=0.02)+
  theme_light()+
  theme(text=element_text(size=xTextSize)) +
  labs(x="Max Growth Rate (r)", y="Max Spread Rate") +
  facet_wrap(~Morph, ncol=2)
p_spreadrate_rate_A
```
Linear fits to these data, or first:
```{r}
nd_rate_temp_A<-nd_diam_slope_rate_A %>%
  filter(Morph=="Original")
lm_nd_diam_slope_rate_ORI_A<-lm(maxdiam~mumax, data=nd_rate_temp_A)
summary(lm_nd_diam_slope_rate_ORI_A)

nd_rate_temp_A<-nd_diam_slope_rate_A %>%
  filter(Morph=="Original")
lm_nd_diam_slope_rate_ORI_A<-lm(spreadrate~mumax, data=nd_rate_temp_A)
summary(lm_nd_diam_slope_rate_ORI_A)
```


And alternate morphs:
```{r}
nd_rate_temp_A<-nd_diam_slope_rate_A %>%
  filter(Morph=="Alternate")
lm_nd_diam_slope_rate_ALT_A<-lm(maxdiam~mumax, data=nd_rate_temp_A)
summary(lm_nd_diam_slope_rate_ALT_A)

nd_rate_temp_A<-nd_diam_slope_rate_A %>%
  filter(Morph=="Alternate")
lm_nd_diam_slope_rate_ALT_A<-lm(spreadrate~mumax, data=nd_rate_temp_A)
summary(lm_nd_diam_slope_rate_ALT_A)
```




So, no. How about carrying capacity? Let's fit the logistic:
```{r}
p     <- c(y0 = 0.01, mumax = 0.1, K = 0.5)
lower <- c(y0 = 1e-6, mumax = 0,   K = 0)
upper <- c(y0 = 0.05, mumax = 5,   K = 1.5)

many_logistic_nutrient_A <- all_growthmodels(OD600 ~ grow_logistic(time, parms) | sample, data= plate_nutrient_long_A, 
                                           p = p, lower = lower, upper = upper, transform = "log")
par(mfrow=c(7,8))
par(mar = c(2.5, 4, 2, 1))
plot(many_logistic_nutrient_A)
```
Coefficients:
```{r}
coef(many_logistic_nutrient_A)
```


Add these to the object:
```{r}
# Create a tibble
many_logistic_nutrient_coef_A<-as_tibble(coef(many_logistic_nutrient_A), rownames=NA)
#str(many_logistic_nutrient_coef)

# Add the well IDs
# We can get the names from the coef() object
temp<-dimnames(coef(many_logistic_nutrient_A))
#temp
temp[[1]]
many_logistic_nutrient_coef_A$sample<-temp[[1]]
str(many_logistic_nutrient_coef_A)
```
Now we have all our coefficients and their well labels. Pass these objects back through the labeler to get the meta-data associated with each well, then add the new labels.
```{r}
many_logistic_nutrient_coef_A<-label96well(many_logistic_nutrient_coef_A, my_labels_nutrient_A)

many_logistic_nutrient_coef_A <- many_logistic_nutrient_coef_A %>%
  add_column(Isolate=NA, 
             TechRep=NA,
             Peptone=NA)
  
  # Take well IDs
well_list1<-unique(my_labels_nutrient_A$Well)
  
attach(my_labels_nutrient_A)

for (i in seq_along(well_list1)){
    idx<-which(many_logistic_nutrient_coef_A$sample==well_list1[i]) # Find indices corresponding to each well
    many_logistic_nutrient_coef_A$Isolate[idx]<-Isolate[i]
    many_logistic_nutrient_coef_A$TechRep[idx]<-TechRep[i]
    many_logistic_nutrient_coef_A$Peptone[idx]<-Peptone[i]
    }
detach(my_labels_nutrient_A)

str(many_logistic_nutrient_coef_A)
```
Now we can plot out:
```{r}
pmanyparams_K_box_nutrient_A<-many_logistic_nutrient_coef_A %>%
  mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=Morph, y=K, color=Strain))+
  theme_classic()+
  geom_boxplot()+
  geom_jitter(width=0.1)+
  #geom_hline(yintercept = WTmedian_r_spline, color="black")+
  theme(legend.position = "none",
        text=element_text(size=xTextSize)) +
  labs(x="Morph", y="Carrying Capacity (OD600)") +
  facet_wrap(~Peptone, ncol=3)
pmanyparams_K_box_nutrient_A + stat_compare_means()
```

Add these to the rest of the parameter data. As before, create a unique ID in the growth rate tibble:
```{r}
many_logistic_nutrient_coef_A <- many_logistic_nutrient_coef_A %>%
  dplyr::filter(Morph!="Ancestor") %>%
  unite("ID", Morph:TechRep, remove=FALSE) # create an ID by merging morph, rep, and techrep
unique(many_logistic_nutrient_coef_A$ID)
```
Are these in the same order or...
```{r}
nd_diam_slope_rate_A$ID
many_logistic_nutrient_coef_A$ID
```
Nope, have to find.
```{r}
nd_diam_slope_rate_A$K<-NA

my_len<-dim(nd_diam_slope_rate_A)[1]
for (i in seq_len(my_len)){
  my_id<-nd_diam_slope_rate_A$ID[i]
  my_level<-nd_diam_slope_rate_A$Peptone[i]
  nd_diam_slope_rate_A$K[i]<-many_logistic_nutrient_coef_A$K[many_logistic_nutrient_coef_A$ID==my_id & 
                                                             many_logistic_nutrient_coef_A$Peptone==my_level]
}
str(nd_diam_slope_rate_A)
```

And plot K vs diameter:
```{r}
p_diam_K_A<-nd_diam_slope_rate_A %>%
  mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=K, y=maxdiam, color=Peptone)) +
  geom_jitter(size=2, width=0.02)+
  #geom_smooth(method="lm", fill="NA")+
  theme_light()+
  theme(text=element_text(size=xTextSize)) +
  labs(x="K (OD600)", y="Max Diameter") +
  facet_wrap(~Morph, ncol=2)
p_diam_K_A
```
Fit linear models myself (geom_smooth wants to fit each peptone group by itself)
```{r}
nd_rate_temp_A<-nd_diam_slope_rate_A %>%
  filter(Morph=="Original")
lm_nd_diam_slope_rate_ORI_A<-lm(maxdiam~K, data=nd_rate_temp_A)
summary(lm_nd_diam_slope_rate_ORI_A)
```
and for alt morphs
```{r}
nd_rate_temp_A<-nd_diam_slope_rate_A %>%
  filter(Morph=="Alternate")
lm_nd_diam_slope_rate_ALT_A<-lm(maxdiam~K, data=nd_rate_temp_A)
summary(lm_nd_diam_slope_rate_ALT_A)
```


And vs spreading rate:
```{r}
p_spreadrate_K_A<-nd_diam_slope_rate_A %>%
   mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=K, y=spreadrate, color=Peptone)) +
  geom_jitter(size=2, width=0.02)+
  theme_light()+
  theme(text=element_text(size=xTextSize)) +
  labs(x="K (OD600)", y="Max Spread Rate") +
  facet_wrap(~Morph, ncol=2)
p_spreadrate_K_A
```
And linear fits, first ORI:
```{r}
nd_rate_temp_A<-nd_diam_slope_rate_A %>%
  filter(Morph=="Original")
lm_nd_diam_slope_rate_ORI_A<-lm(spreadrate~K, data=nd_rate_temp_A)
summary(lm_nd_diam_slope_rate_ORI_A)
```

Then alt:
```{r}
nd_rate_temp_A<-nd_diam_slope_rate_A %>%
  filter(Morph=="Alternate")
lm_nd_diam_slope_rate_ALT_A<-lm(spreadrate~K, data=nd_rate_temp_A)
summary(lm_nd_diam_slope_rate_ALT_A)
```

#### Growth vs Spread Pooled
Put the parameter estimates together.
```{r}
nd_diam_slope_rate_A$Community<-"A"
nd_diam_slope_rate_F$Community<-"F"
nd_diam_slope_rate<-rbind(nd_diam_slope_rate_A, nd_diam_slope_rate_F)
```

Composite figures. Parameter estimates:
```{r}
pLVparams_spline_r_box_nutrient<-nd_diam_slope_rate %>%
  mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=Morph, y=mumax, color=Morph))+
  theme_classic()+
  geom_boxplot()+
  geom_jitter(width=0.1)+
  theme(legend.position = "none",
        text=element_text(size=xTextSize)) +
  labs(x="Morph", y="Max Growth Rate (r)") +
  facet_grid(Peptone~Community, scales="free_y")
pLVparams_spline_r_box_nutrient + stat_compare_means()
```
And for K:
```{r}
pLVparams_spline_K_box_nutrient<-nd_diam_slope_rate %>%
  mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=Morph, y=K, color=Morph))+
  theme_classic()+
  geom_boxplot()+
  geom_jitter(width=0.1)+
  theme(legend.position = "none",
        text=element_text(size=xTextSize)) +
  labs(x="Morph", y="Capacity (K)") +
  facet_grid(Peptone~Community, scales="free_y")
pLVparams_spline_K_box_nutrient + stat_compare_means(label.y.npc = c(0.28, 0.6, 1.1))
#pLVparams_spline_K_box_nutrient + stat_compare_means(label.y=0.1)
```
Finally the trends:
```{r}
p_diam_K<-nd_diam_slope_rate %>%
  mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=K, y=maxdiam, color=Peptone)) +
  geom_jitter(size=2, width=0.02)+
  #geom_smooth(method="lm", fill="NA")+
  theme_light()+
  theme(text=element_text(size=xTextSize)) +
  labs(x="K (OD600)", y="Max Diameter") +
  facet_grid(Community~Morph)
p_diam_K
```
K vs spread rate:
```{r}
p_spread_K<-nd_diam_slope_rate %>%
  mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=K, y=spreadrate, color=Peptone)) +
  geom_jitter(size=2, width=0.02)+
  theme_light()+
  theme(text=element_text(size=xTextSize)) +
  labs(x="K (OD600)", y="Spreading Rate") +
  facet_grid(Community~Morph)
p_spread_K
```


and in mumax:
```{r}
p_diam_mumax<-nd_diam_slope_rate %>%
  mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=mumax, y=maxdiam, color=Peptone)) +
  geom_jitter(size=2, width=0.02)+
  theme_light()+
  theme(text=element_text(size=xTextSize)) +
  labs(x="Max Growth Rate (r)", y="Max Diameter") +
  facet_grid(Community~Morph)
p_diam_mumax
```

```{r}
p_spread_mumax<-nd_diam_slope_rate %>%
  mutate(Peptone=as.factor(Peptone)) %>%
  ggplot(aes(x=mumax, y=spreadrate, color=Peptone)) +
  geom_jitter(size=2, width=0.02)+
  theme_light()+
  theme(text=element_text(size=xTextSize)) +
  labs(x="Max Growth Rate (r)", y="Spreading Rate") +
  facet_grid(Community~Morph)
p_spread_mumax
```


Assemble. Growth rates:
```{r}
plot_grid(pLVparams_spline_r_box_nutrient + stat_compare_means(label.y=0), 
          p_diam_mumax, p_spread_mumax,
          ncol=1, rel_heights=c(1.5,1,1), labels="AUTO")
ggsave("pDiameterRates.png", width=8, height=10, units="in", dpi=300)
```
Same for K:
```{r}
plot_grid(pLVparams_spline_K_box_nutrient + stat_compare_means(label.y.npc = c(0.28, 0.6, 1.1)), 
          p_diam_K, p_spread_K,
          ncol=1, labels="AUTO")
ggsave("pDiameterVsK.png", width=8, height=10, units="in", dpi=300)
```


